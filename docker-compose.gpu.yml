version: "3.8"

services:
  myfoil:
    image: myfoil:${MYFOIL_VERSION:-2.1.3}
    container_name: myfoil
    restart: unless-stopped
    ports:
      - "8465:8465"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Sao_Paulo
      - DATABASE_URL=postgresql://myfoil:myfoilpassword@postgres:5432/myfoil
      - REDIS_URL=redis://redis:6379/0
      # GPU Configuration - Set to 'true' to enable GPU acceleration
      - MYFOIL_GPU_ENABLED=true
    volumes:
      - /path/to/your/games:/games
      - /path/to/your/externo:/externo
      - ./config:/app/config
      - ./data:/app/data
    depends_on:
      postgres:
        condition: service_started
      redis:
        condition: service_healthy
    # GPU Support - Uncomment the lines below to enable NVIDIA GPU
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

  postgres:
    image: postgres:15-alpine
    container_name: myfoil-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: myfoil
      POSTGRES_PASSWORD: myfoilpassword
      POSTGRES_DB: myfoil
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: myfoil-redis
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  worker:
    image: myfoil:${MYFOIL_VERSION:-2.1.3}
    container_name: myfoil-worker
    restart: unless-stopped
    command: celery -A celery_app.celery worker --loglevel=info --concurrency=20 -P gevent
    depends_on:
      redis:
        condition: service_healthy
      myfoil:
        condition: service_started
    environment:
      - DATABASE_URL=postgresql://myfoil:myfoilpassword@postgres:5432/myfoil
      - REDIS_URL=redis://redis:6379/0
      - PUID=1000
      - PGID=1000
      - TZ=America/Sao_Paulo
      - CELERY_REQUIRED=true
      # GPU Configuration - Set to 'true' to enable GPU acceleration in workers
      - MYFOIL_GPU_ENABLED=true
    volumes:
      - /path/to/your/games:/games
      - /path/to/your/externo:/externo
      - ./config:/app/config
      - ./data:/app/data
    # GPU Support for workers - Uncomment to enable
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

volumes:
  postgres_data:
