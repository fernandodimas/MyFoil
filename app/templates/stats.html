{% extends "base.html" %}

{% block content %}
{% include 'nav.html' %}

<section class="section">
    <div class="container is-fluid px-5">
        <div class="columns is-multiline">
            <!-- Header Stats -->
            <div class="column is-12">
                <div class="level">
                    <div class="level-left">
                        <div>
                            <h1 class="title is-2 mb-2" style="font-weight: 800; letter-spacing: -1px;">üìä Dashboard de
                                Estat√≠sticas</h1>
                            <p class="subtitle is-6 opacity-60">Vis√£o geral da sua cole√ß√£o e compara√ß√£o com o cat√°logo
                                global.</p>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="field">
                            <label class="label is-small opacity-50">Filtrar por Biblioteca</label>
                            <div class="control has-icons-left">
                                <span class="select is-rounded is-small">
                                    <select id="libraryFilter" onchange="loadStats()">
                                        <option value="">Todas as Bibliotecas</option>
                                    </select>
                                </span>
                                <span class="icon is-small is-left">
                                    <i class="bi bi-folder2-open"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Cards Row 1 -->
            <div class="column is-3">
                <div class="card box shadow-sm border-none p-5 h-100">
                    <p class="heading is-size-7 opacity-50 mb-2">Total de T√≠tulos</p>
                    <div class="is-flex is-align-items-center">
                        <span class="icon is-large has-text-primary mr-3">
                            <i class="bi bi-collection-play is-size-3"></i>
                        </span>
                        <div>
                            <p class="title is-3 m-0" id="stat-total-games">--</p>
                            <p class="is-size-7" id="stat-owned-count">-- Possu√≠dos</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column is-3">
                <div class="card box shadow-sm border-none p-5 h-100">
                    <p class="heading is-size-7 opacity-50 mb-2">Espa√ßo em Disco</p>
                    <div class="is-flex is-align-items-center">
                        <span class="icon is-large has-text-info mr-3">
                            <i class="bi bi-hdd-network is-size-3"></i>
                        </span>
                        <div>
                            <p class="title is-4 m-0" id="stat-total-size">--</p>
                            <p class="is-size-7 opacity-70">Soma Total de Arquivos</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column is-3">
                <div class="card box shadow-sm border-none p-5 h-100">
                    <p class="heading is-size-7 opacity-50 mb-2">Updates na Cole√ß√£o</p>
                    <div class="is-flex is-align-items-center">
                        <span class="icon is-large has-text-link mr-3">
                            <i class="bi bi-arrow-up-circle is-size-3"></i>
                        </span>
                        <div>
                            <p class="title is-4 m-0" id="stat-total-updates">--</p>
                            <p class="is-size-7">Arquivos de Update</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column is-3">
                <div class="card box shadow-sm border-none p-5 h-100">
                    <p class="heading is-size-7 opacity-50 mb-2">DLCs na Cole√ß√£o</p>
                    <div class="is-flex is-align-items-center">
                        <span class="icon is-large has-text-danger-dark mr-3">
                            <i class="bi bi-plus-circle is-size-3"></i>
                        </span>
                        <div>
                            <p class="title is-4 m-0" id="stat-total-dlcs">--</p>
                            <p class="is-size-7">Arquivos de Conte√∫do Extra</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Cards Row 2 -->
            <div class="column is-6">
                <div class="card box shadow-sm border-none p-5 h-100 is-light">
                    <div class="columns is-mobile is-vcentered">
                        <div class="column">
                            <p class="heading is-size-7 opacity-50 mb-1">Status da Cole√ß√£o</p>
                            <p class="title is-4 m-0" id="stat-up-to-date-pct">-- %</p>
                            <p class="is-size-7" id="stat-up-to-date-count">-- atualizados</p>
                        </div>
                        <div class="column is-narrow has-text-centered border-left px-5">
                            <span class="icon is-large has-text-success">
                                <i class="bi bi-check-circle-fill is-size-3"></i>
                            </span>
                        </div>
                        <div class="column">
                            <p class="heading is-size-7 opacity-50 mb-1">Cobertura TitleDB</p>
                            <p class="title is-4 m-0" id="stat-coverage-pct">-- %</p>
                            <p class="is-size-7">Fonte: <b id="stat-source-name">--</b></p>
                            <p class="is-size-7">Cat√°logo: <b id="stat-total-available">--</b> jogos</p>
                        </div>
                        <div class="column is-narrow has-text-centered">
                            <span class="icon is-large has-text-warning">
                                <i class="bi bi-globe2 is-size-3"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column is-6">
                <div class="card box shadow-sm h-100 p-5">
                    <div class="columns is-mobile is-vcentered">
                        <div class="column">
                            <p class="heading is-size-7 opacity-50 mb-1">Sa√∫de dos Arquivos</p>
                            <p class="title is-4 m-0" id="stat-id-rate">--%</p>
                            <p class="is-size-7">Arquivos Identificados</p>
                        </div>
                        <div class="column is-narrow has-text-centered">
                            <span class="icon is-large has-text-info">
                                <i class="bi bi-fingerprint is-size-3"></i>
                            </span>
                        </div>
                        <div class="column has-text-right">
                            <p class="is-size-7">Total: <b id="stat-total-files">--</b></p>
                            <p class="is-size-7 has-text-danger">N√£o Ident.: <b id="stat-unidentified-files">--</b></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="column is-12">
                <div class="card box shadow-sm">
                    <header class="card-header border-none shadow-none">
                        <p class="card-header-title">
                            <i class="bi bi-pie-chart-fill mr-2 has-text-primary"></i> Distribui√ß√£o por G√™nero
                        </p>
                    </header>
                    <div class="card-content pt-0">
                        <div style="height: 300px; position: relative;">
                            <canvas id="genreChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Additions -->
            <div class="column is-12">
                <div class="card box shadow-sm">
                    <header class="card-header border-none shadow-none">
                        <p class="card-header-title">
                            <i class="bi bi-clock-history mr-2 has-text-primary"></i> Adicionados Recentemente
                        </p>
                    </header>
                    <div class="card-content pt-0">
                        <div id="recentGamesList" class="columns is-multiline">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    $(document).ready(() => {
        loadStats(true); // Initial load with library list population
    });

    let genreChart = null;

    function loadStats(initFilter = false) {
        const libId = $('#libraryFilter').val();
        const url = `/api/stats/overview${libId ? '?library_id=' + libId : ''}`;

        $.getJSON(url, (data) => {
            if (initFilter) {
                populateLibraryFilter(data.libraries);
            }

            // Fill quick cards
            $('#stat-total-games').text(data.library.total_titles);
            $('#stat-owned-count').text(data.library.total_owned + ' Possu√≠dos');
            $('#stat-total-size').text(data.library.total_size_formatted);
            $('#stat-total-updates').text(data.library.total_updates);
            $('#stat-total-dlcs').text(data.library.total_dlcs);

            $('#stat-up-to-date-pct').text(data.library.completion_rate + '%');
            $('#stat-up-to-date-count').text(data.library.up_to_date + ' atualizados');
            $('#stat-coverage-pct').text(data.titledb.coverage_pct + '%');
            $('#stat-source-name').text(data.titledb.source_name);
            $('#stat-total-available').text(data.titledb.total_available);

            // Identification Stats
            $('#stat-id-rate').text(data.identification.identified_pct + '%');
            $('#stat-total-files').text(data.identification.total_files);
            $('#stat-unidentified-files').text(data.identification.unidentified_count);

            // Render Genre Chart
            renderGenreChart(data.genres);

            // Render Recent Games
            renderRecentGames(data.recent);
        });
    }

    function populateLibraryFilter(libs) {
        const select = $('#libraryFilter');
        libs.forEach(lib => {
            select.append(`<option value="${lib.id}">${lib.path}</option>`);
        });
    }

    function renderGenreChart(genreData) {
        if (genreChart) {
            genreChart.destroy();
        }

        const ctx = document.getElementById('genreChart').getContext('2d');
        const labels = Object.keys(genreData);
        const values = Object.values(genreData);

        genreChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Jogos por G√™nero',
                    data: values,
                    backgroundColor: 'rgba(124, 58, 237, 0.7)',
                    borderColor: '#7c3aed',
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { grid: { display: false } }
                }
            }
        });
    }

    function renderRecentGames(games) {
        const container = $('#recentGamesList').empty();
        if (!games.length) {
            container.append('<div class="column is-12 has-text-centered py-6 opacity-40">Nenhum jogo encontrado.</div>');
            return;
        }

        games.forEach(game => {
            container.append(`
                <div class="column is-3-tablet is-2-desktop">
                    <div class="card box p-0 shadow-sm border-none overflow-hidden h-100" style="transition: transform 0.2s;">
                        <figure class="image is-square">
                            <img src="${game.iconUrl || '/static/img/no-icon.png'}" style="object-fit: cover;">
                        </figure>
                        <div class="p-3">
                            <p class="is-size-7 has-text-weight-bold line-clamp-2" title="${game.name}">${game.name}</p>
                            <p class="is-size-7 opacity-50">${game.id}</p>
                        </div>
                    </div>
                </div>
            `);
        });
    }
</script>

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .hover-scale:hover {
        transform: scale(1.02);
    }
</style>
{% endblock %}