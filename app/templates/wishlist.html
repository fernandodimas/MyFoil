{% extends "base.html" %}

{% block title %}MyFoil - Wishlist{% endblock %}

{% block content %}
{% include 'nav.html' %}
<div class="container is-fluid px-5 pb-6">
    <div class="section pt-5">
        <div class="level mb-4">
            <div class="level-left">
                <div>
                    <h1 class="title is-3">Lista de Desejos</h1>
                    <p class="subtitle is-6 has-text-grey">Gerencie os jogos que voc√™ pretende jogar</p>
                </div>
            </div>
            <div class="level-right">
                <div class="buttons">
                    <button class="button is-primary shadow-sm" onclick="openAddToWishlistModal()">
                        <span class="icon"><i class="bi bi-plus-circle"></i></span>
                        <span>Adicionar Jogo</span>
                    </button>
                    <div class="dropdown is-hoverable is-right">
                        <div class="dropdown-trigger">
                            <button class="button is-white shadow-sm" aria-haspopup="true"
                                aria-controls="dropdown-menu-export">
                                <span class="icon is-small has-text-primary"><i class="bi bi-download"></i></span>
                                <span>Exportar</span>
                                <span class="icon is-small"><i class="bi bi-chevron-down"></i></span>
                            </button>
                        </div>
                        <div class="dropdown-menu" id="dropdown-menu-export" role="menu">
                            <div class="dropdown-content">
                                <a href="/api/wishlist/export?format=json" target="_blank" class="dropdown-item">
                                    <span class="icon mr-2"><i class="bi bi-filetype-json"></i></span> JSON
                                </a>
                                <a href="/api/wishlist/export?format=csv" target="_blank" class="dropdown-item">
                                    <span class="icon mr-2"><i class="bi bi-filetype-csv"></i></span> CSV
                                </a>
                                <a href="/api/wishlist/export?format=html" target="_blank" class="dropdown-item">
                                    <span class="icon mr-2"><i class="bi bi-filetype-html"></i></span> HTML
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="box is-paddingless shadow-sm overflow-hidden border-none"
            style="border-radius: 12px; min-height: 400px;">
            <div class="table-container">
                <table class="table is-fullwidth is-hoverable is-striped mb-0" id="wishlistTable">
                    <thead>
                        <tr class="has-background-light-soft">
                            <th width="80" class="has-text-centered">Capa</th>
                            <th>T√≠tulo</th>
                            <th>Prioridade</th>
                            <th>Adicionado em</th>
                            <th>Status</th>
                            <th class="has-text-right">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="wishlistBody">
                        <tr>
                            <td colspan="6" class="has-text-centered p-6">
                                <span class="loader is-loading is-inline-block"
                                    style="width: 2rem; height: 2rem;"></span>
                                <p class="mt-2 has-text-grey">Carregando wishlist...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add to Wishlist Modal -->
<div class="modal" id="addToWishlistModal">
    <div class="modal-background" onclick="closeModal('addToWishlistModal')"></div>
    <div class="modal-card" style="max-width: 600px;">
        <header class="modal-card-head">
            <p class="modal-card-title"><i class="bi bi-search mr-2"></i> Buscar Jogo para Adicionar</p>
            <button class="delete" aria-label="close" onclick="closeModal('addToWishlistModal')"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label is-small">Buscar no TitleDB</label>
                <div class="control has-icons-left">
                    <input class="input" type="text" id="wishlistSearchInput" placeholder="Digite o nome do jogo..."
                        onkeyup="searchTitleDBForWishlist()">
                    <span class="icon is-left">
                        <i class="bi bi-search"></i>
                    </span>
                </div>
                <p class="help">Digite ao menos 3 caracteres para buscar</p>
            </div>

            <div id="wishlistSearchResults" class="mt-4" style="max-height: 400px; overflow-y: auto;">
                <!-- Results will be populated here -->
            </div>
        </section>
    </div>
</div>

<script>
    {% raw %}
    document.addEventListener('DOMContentLoaded', () => {
        loadWishlist();
    });

    function getPriorityLabel(level) {
        switch (parseInt(level)) {
            case 3: return '<span class="tag is-danger is-light">Alta</span>';
            case 2: return '<span class="tag is-warning is-light">M√©dia</span>';
            case 1: return '<span class="tag is-info is-light">Baixa</span>';
            default: return '<span class="tag is-light">Normal</span>';
        }
    }

    async function loadWishlist() {
        try {
            const res = await fetch('/api/wishlist');
            const items = await res.json();

            const tbody = document.getElementById('wishlistBody');

            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="has-text-centered p-6">
                            <div class="content">
                                <p class="is-size-3 mb-2">ü§∑‚Äç‚ôÇÔ∏è</p>
                                <p class="has-text-grey">Sua lista de desejos est√° vazia.</p>
                                <a href="/" class="button is-primary is-small mt-3">Explorar Biblioteca</a>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Fetch game details for each item to show names/images
            // We can optimize this by batching or doing it server-side properly later.
            // For now, let's fetch individual meta

            tbody.innerHTML = '';

            for (const item of items) {
                // Fetch basic info from our library/titledb endpoint logic 
                // Using the public endpoint logic or a customized one
                // Since there is no bulk lookup public API, we might rely on the client knowing or fetching one by one

                let gameName = item.title_id;
                let iconUrl = '/static/img/no-icon.png';
                let statusHtml = '<span class="tag is-light">Desconhecido</span>';

                try {
                    // We try to get info. If backend supports generic lookup for non-owned games, this works.
                    // Assuming existing '/api/get_game/<tid>' or similar works even if not owned?
                    // Let's rely on TitleDB lookup
                    const gRes = await fetch(`/api/app_info/${item.title_id}`);
                    if (gRes.ok) {
                        const gData = await gRes.json();
                        gameName = gData.name || item.title_id;
                        iconUrl = gData.iconUrl || iconUrl;

                        // Check if released
                        if (gData.releaseDate && gData.releaseDate > new Date().toISOString().replace(/-/g, '')) {
                            statusHtml = '<span class="tag is-info is-light">Em Breve</span>';
                        } else {
                            statusHtml = '<span class="tag is-success is-light">Lan√ßado</span>';
                        }
                    }
                } catch (e) {
                    console.error("Failed to fetch game details", e);
                }

                const row = document.createElement('tr');

                // Check if game is owned (in library)
                let ownedBadge = '';
                let inLibrary = false;

                try {
                    const gRes = await fetch(`/api/app_info/${item.title_id}`);
                    if (gRes.ok) {
                        const gData = await gRes.json();
                        gameName = gData.name || item.title_id;
                        iconUrl = gData.iconUrl || iconUrl;
                        inLibrary = gData.owned || false;

                        // Check if already in library
                        if (inLibrary) {
                            ownedBadge = '<span class="tag is-success mr-2"><i class="bi bi-check-circle-fill mr-1"></i> Possuo</span>';
                        }

                        // Check if released
                        if (gData.releaseDate && gData.releaseDate > new Date().toISOString().replace(/-/g, '')) {
                            statusHtml = '<span class="tag is-info is-light">Em Breve</span>';
                        } else {
                            statusHtml = '<span class="tag is-success is-light">Lan√ßado</span>';
                        }
                    }
                } catch (e) {
                    console.error("Failed to fetch game details", e);
                }

                row.innerHTML = `
                    <td class="has-text-centered p-2">
                        <figure class="image is-48x48 is-inline-block">
                            <img src="${iconUrl}" class="is-rounded" style="object-fit: cover; width: 100%; height: 100%;">
                        </figure>
                    </td>
                    <td class="is-vcentered">
                        <a onclick="showGameDetails('${item.title_id}')" class="has-text-weight-bold has-text-primary-dark">${gameName}</a>
                        <p class="is-size-7 font-mono opacity-50">${item.title_id}</p>
                    </td>
                    <td class="is-vcentered">
                        <div class="field has-addons">
                            <div class="control">
                                <button class="button is-small is-rounded" onclick="changePriority('${item.title_id}', ${item.priority - 1})" ${item.priority <= 0 ? 'disabled' : ''}>
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                            </div>
                            <div class="control">
                                <a class="button is-small is-static px-3">${getPriorityLabel(item.priority)}</a>
                            </div>
                            <div class="control">
                                <button class="button is-small is-rounded" onclick="changePriority('${item.title_id}', ${item.priority + 1})" ${item.priority >= 3 ? 'disabled' : ''}>
                                    <i class="bi bi-chevron-up"></i>
                                </button>
                            </div>
                        </div>
                    </td>
                    <td class="is-vcentered is-size-7">${new Date(item.added_date).toLocaleDateString()}</td>
                    <td class="is-vcentered">${ownedBadge}${statusHtml}</td>
                    <td class="is-vcentered has-text-right">
                        <button class="button is-small is-danger is-light" onclick="removeFromWishlist('${item.title_id}')" title="Remover">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        } catch (e) {
            console.error(e);
            document.getElementById('wishlistBody').innerHTML = `<tr><td colspan="6" class="has-text-centered has-text-danger">Erro ao carregar wishlist</td></tr>`;
        }
    }

    function removeFromWishlist(tid) {
        confirmAction({
            title: 'Remover da Wishlist',
            message: 'Deseja realmente remover este item da sua lista de desejos?',
            confirmText: 'Remover',
            confirmClass: 'is-danger',
            onConfirm: async () => {
                try {
                    const res = await fetch(`/api/wishlist/${tid}`, { method: 'DELETE' });
                    if (res.ok) {
                        showToast('Item removido da wishlist', 'success');
                        loadWishlist();
                    }
                } catch (e) {
                    showToast('Erro ao remover item', 'error');
                }
            }
        });
    }

    async function changePriority(tid, newPriority) {
        if (newPriority < 0 || newPriority > 3) return;

        try {
            const res = await fetch(`/api/wishlist/${tid}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ priority: newPriority })
            });
            if (res.ok) {
                loadWishlist();
            } else {
                showToast('Erro ao atualizar prioridade', 'error');
            }
        } catch (e) {
            console.error(e);
            showToast('Erro de conex√£o', 'error');
        }
    }

    // Add game to wishlist from TitleDB
    function openAddToWishlistModal() {
        openModal('addToWishlistModal');
        $('#wishlistSearchInput').val('').focus();
        $('#wishlistSearchResults').html('<p class="has-text-centered py-4 opacity-50">Digite para buscar jogos no TitleDB...</p>');
    }

    let wishlistSearchTimeout;
    function searchTitleDBForWishlist() {
        const query = $('#wishlistSearchInput').val();

        if (!query || query.length < 3) {
            $('#wishlistSearchResults').html('<p class="has-text-centered py-4 opacity-50">Digite ao menos 3 caracteres...</p>');
            return;
        }

        clearTimeout(wishlistSearchTimeout);
        wishlistSearchTimeout = setTimeout(() => {
            $.getJSON(`/api/titledb/search?q=${encodeURIComponent(query)}`, (results) => {
                if (!results || results.length === 0) {
                    $('#wishlistSearchResults').html('<p class="has-text-centered py-4 opacity-50">Nenhum jogo encontrado</p>');
                    return;
                }

                let html = '<div class="list">';
                results.slice(0, 10).forEach(game => {
                    html += `
                        <div class="list-item is-clickable" onclick="addGameToWishlistFromTitleDB('${game.id}', '${game.name.replace(/'/g, "\\'")}')">
                            <div class="media">
                                ${game.iconUrl ? `<div class="media-left"><figure class="image is-48x48"><img src="${game.iconUrl}" style="border-radius: 8px;"></figure></div>` : ''}
                                <div class="media-content">
                                    <p class="is-size-7 has-text-weight-bold">${game.name}</p>
                                    <p class="is-size-7 opacity-50">${game.id}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                $('#wishlistSearchResults').html(html);
            }).fail(() => {
                $('#wishlistSearchResults').html('<p class="has-text-centered py-4 has-text-danger">Erro ao buscar. Verifique o console.</p>');
            });
        }, 300);
    }

    function addGameToWishlistFromTitleDB(titleId, titleName) {
        $.ajax({
            url: '/api/wishlist',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ title_id: titleId }),
            success: (res) => {
                if (res.success) {
                    showToast(`"${titleName}" adicionado √† wishlist!`, 'success');
                    closeModal('addToWishlistModal');
                    loadWishlist();
                } else {
                    showToast(res.error || 'Erro ao adicionar', 'error');
                }
            },
            error: () => {
                showToast('Erro ao adicionar √† wishlist', 'error');
            }
        });
    }


    {% endraw %}
</script>


{% endblock %}