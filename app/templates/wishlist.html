{% extends "base.html" %}

{% block title %}MyFoil - Wishlist{% endblock %}

{% block content %}
{% include 'nav.html' %}
<div class="container is-fluid px-5 pb-6">
    <div class="section pt-5">
        <div class="level mb-4">
            <div class="level-left">
                <div>
                    <h1 class="title is-3">Lista de Desejos</h1>
                    <p class="subtitle is-6 has-text-grey">Gerencie os jogos que você pretende jogar</p>
                </div>
            </div>
            <div class="level-right">
                <div class="buttons">
                    <button class="button is-primary shadow-sm" onclick="openAddToWishlistModal()">
                        <span class="icon"><i class="bi bi-plus-circle"></i></span>
                        <span>Adicionar Jogo</span>
                    </button>
                    <div class="dropdown is-hoverable is-right">
                        <div class="dropdown-trigger">
                            <button class="button is-white shadow-sm" aria-haspopup="true"
                                aria-controls="dropdown-menu-export">
                                <span class="icon is-small has-text-primary"><i class="bi bi-download"></i></span>
                                <span>Exportar</span>
                                <span class="icon is-small"><i class="bi bi-chevron-down"></i></span>
                            </button>
                        </div>
                        <div class="dropdown-menu" id="dropdown-menu-export" role="menu">
                            <div class="dropdown-content">
                                <a href="/api/wishlist/export?format=json" target="_blank" class="dropdown-item">
                                    <span class="icon mr-2"><i class="bi bi-filetype-json"></i></span> JSON
                                </a>
                                <a href="/api/wishlist/export?format=csv" target="_blank" class="dropdown-item">
                                    <span class="icon mr-2"><i class="bi bi-filetype-csv"></i></span> CSV
                                </a>
                                <a href="/api/wishlist/export?format=html" target="_blank" class="dropdown-item">
                                    <span class="icon mr-2"><i class="bi bi-filetype-html"></i></span> HTML
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="box is-paddingless shadow-sm overflow-hidden border-none"
            style="border-radius: 12px; min-height: 400px;">
            <div class="table-container">
                <table class="table is-fullwidth is-hoverable game-list-table mb-0" id="wishlistTable">
                    <thead>
                        <tr class="has-background-light-soft" style="border-bottom: 2px solid var(--bulma-primary)">
                            <th width="80" class="has-text-centered p-1">Capa</th>
                            <th>Título</th>
                            <th width="140">Prioridade</th>
                            <th width="140">Adicionado em</th>
                            <th width="140" class="has-text-centered">Na Biblioteca</th>
                            <th width="140">Status</th>
                            <th class="has-text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="wishlistBody">
                        <tr>
                            <td colspan="6" class="has-text-centered p-6">
                                <span class="loader is-loading is-inline-block"
                                    style="width: 2rem; height: 2rem;"></span>
                                <p class="mt-2 has-text-grey">Carregando wishlist...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add to Wishlist Modal -->
<div class="modal" id="addToWishlistModal">
    <div class="modal-background" onclick="closeModal('addToWishlistModal')"></div>
    <div class="modal-card" style="max-width: 600px;">
        <header class="modal-card-head">
            <p class="modal-card-title"><i class="bi bi-search mr-2"></i> Buscar Jogo para Adicionar</p>
            <button class="delete" aria-label="close" onclick="closeModal('addToWishlistModal')"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label is-small">Buscar no TitleDB</label>
                <div class="control has-icons-left">
                    <input class="input" type="text" id="wishlistSearchInput" placeholder="Digite o nome do jogo..."
                        onkeyup="searchTitleDBForWishlist()">
                    <span class="icon is-left">
                        <i class="bi bi-search"></i>
                    </span>
                </div>
                <p class="help">Digite ao menos 3 caracteres para buscar</p>
            </div>

            <div id="wishlistSearchResults" class="mt-4" style="max-height: 400px; overflow-y: auto;">
                <!-- Results will be populated here -->
            </div>
        </section>
    </div>
</div>

<script>
    {% raw %}
    document.addEventListener('DOMContentLoaded', () => {
        loadWishlist();
    });

    function getPriorityLabel(level) {
        switch (parseInt(level)) {
            case 3: return '<span class="tag is-danger is-light">Alta</span>';
            case 2: return '<span class="tag is-warning is-light">Média</span>';
            case 1: return '<span class="tag is-info is-light">Baixa</span>';
            default: return '<span class="tag is-light">Normal</span>';
        }
    }

    async function loadWishlist() {
        try {
            const res = await fetch('/api/wishlist');
            const items = await res.json();

            const tbody = document.getElementById('wishlistBody');

            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="has-text-centered p-6 opacity-50 italic">${t("Sua wishlist está vazia")}</td></tr>`;
                return;
            }

            tbody.innerHTML = '';

            for (const item of items) {
                let statusHtml = t('Desconhecido');
                let statusClass = 'has-text-grey';
                let ownedHtml = '--';
                let ownedClass = 'opacity-50';
                let owned = false;

                try {
                    const gRes = await fetch(`/api/app_info/${item.title_id}`);
                    if (gRes.ok) {
                        const gData = await gRes.json();
                        gameName = gData.name || item.title_id;
                        iconUrl = gData.iconUrl || iconUrl;
                        owned = gData.owned || false;

                        // Check if already in library
                        if (owned) {
                            ownedHtml = 'SIM';
                            ownedClass = 'has-text-success';
                        } else {
                            ownedHtml = 'NÃO';
                            ownedClass = 'has-text-warning'; // Sincronizado com o status "Missing" da biblioteca
                        }

                        // Check if released - Correcting logic for YYYYMMDD comparison
                        // We assume release_date is YYYYMMDD or YYYY-MM-DD
                        const rawDate = String(gData.release_date || '');
                        const releaseDateStr = rawDate.replace(/-/g, '');
                        const todayStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');

                        if (releaseDateStr && releaseDateStr > todayStr) {
                            statusHtml = t('Em Breve');
                            statusClass = 'has-text-info';
                        } else if (releaseDateStr) {
                            statusHtml = t('Lançado');
                            statusClass = 'has-text-success';
                        }
                    }
                } catch (e) {
                    console.error("Failed to fetch game details", e);
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-1 has-text-centered is-vcentered">
                        <img src="${iconUrl}" style="width: 32px; height: 32px; border-radius: 4px; object-fit: cover;">
                    </td>
                    <td class="is-vcentered">
                        <strong class="is-size-7-mobile is-clickable" onclick="showGameDetails('${item.title_id}')">${gameName}</strong>
                        <p class="is-size-7 font-mono opacity-50">${item.title_id}</p>
                    </td>
                    <td class="is-vcentered">
                        <div class="field has-addons">
                            <div class="control">
                                <button class="button is-small is-rounded is-light py-0 px-2" onclick="changePriority('${item.title_id}', ${item.priority - 1})" ${item.priority <= 0 ? 'disabled' : ''}>
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                            </div>
                            <div class="control">
                                <span class="button is-small is-static px-3 is-size-7">${getPriorityLabel(item.priority)}</span>
                            </div>
                            <div class="control">
                                <button class="button is-small is-rounded is-light py-0 px-2" onclick="changePriority('${item.title_id}', ${item.priority + 1})" ${item.priority >= 3 ? 'disabled' : ''}>
                                    <i class="bi bi-chevron-up"></i>
                                </button>
                            </div>
                        </div>
                    </td>
                    <td class="is-vcentered font-mono is-size-7 opacity-70">
                        ${new Date(item.added_date).toLocaleDateString()}
                    </td>
                    <td class="is-vcentered has-text-centered ${ownedClass} has-text-weight-bold is-size-7">
                        ${ownedHtml}
                    </td>
                    <td class="is-vcentered ${statusClass} has-text-weight-bold is-size-7">
                        ${statusHtml}
                    </td>
                    <td class="is-vcentered has-text-right">
                        <div class="buttons is-justify-content-flex-end">
                            ${owned ? `
                                <button class="button is-small is-ghost has-text-grey mr-1" onclick="editGameMetadata('${item.title_id}')" title="Editar Dados">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            ` : ''}
                            <button class="button is-small is-ghost has-text-danger" onclick="removeFromWishlist('${item.title_id}')" title="Remover">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            }
        } catch (e) {
            console.error(e);
            document.getElementById('wishlistBody').innerHTML = `<tr><td colspan="7" class="has-text-centered has-text-danger p-6">Erro ao carregar wishlist</td></tr>`;
        }
    }

    function removeFromWishlist(tid) {
        confirmAction({
            title: 'Remover da Wishlist',
            message: 'Deseja realmente remover este item da sua lista de desejos?',
            confirmText: 'Remover',
            confirmClass: 'is-danger',
            onConfirm: async () => {
                try {
                    const res = await fetch(`/api/wishlist/${tid}`, { method: 'DELETE' });
                    if (res.ok) {
                        showToast('Item removido da wishlist', 'success');
                        loadWishlist();
                    }
                } catch (e) {
                    showToast('Erro ao remover item', 'error');
                }
            }
        });
    }

    async function changePriority(tid, newPriority) {
        if (newPriority < 0 || newPriority > 3) return;

        try {
            const res = await fetch(`/api/wishlist/${tid}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ priority: newPriority })
            });
            if (res.ok) {
                loadWishlist();
            } else {
                showToast('Erro ao atualizar prioridade', 'error');
            }
        } catch (e) {
            console.error(e);
            showToast('Erro de conexão', 'error');
        }
    }

    // Add game to wishlist from TitleDB
    function openAddToWishlistModal() {
        openModal('addToWishlistModal');
        $('#wishlistSearchInput').val('').focus();
        $('#wishlistSearchResults').html('<p class="has-text-centered py-4 opacity-50">Digite para buscar jogos no TitleDB...</p>');
    }

    let wishlistSearchTimeout;
    function searchTitleDBForWishlist() {
        const query = $('#wishlistSearchInput').val();

        if (!query || query.length < 3) {
            $('#wishlistSearchResults').html('<p class="has-text-centered py-4 opacity-50">Digite ao menos 3 caracteres...</p>');
            return;
        }

        clearTimeout(wishlistSearchTimeout);
        wishlistSearchTimeout = setTimeout(() => {
            $.getJSON(`/api/titledb/search?q=${encodeURIComponent(query)}`, (results) => {
                if (!results || results.length === 0) {
                    $('#wishlistSearchResults').html('<p class="has-text-centered py-4 opacity-50">Nenhum jogo encontrado</p>');
                    return;
                }

                let html = '<div class="list">';
                results.slice(0, 10).forEach(game => {
                    html += `
                        <div class="list-item is-clickable" onclick="addGameToWishlistFromTitleDB('${game.id}', '${game.name.replace(/'/g, "\\'")}')">
                            <div class="media">
                                ${game.iconUrl ? `<div class="media-left"><figure class="image is-48x48"><img src="${game.iconUrl}" style="border-radius: 8px;"></figure></div>` : ''}
                                <div class="media-content">
                                    <p class="is-size-7 has-text-weight-bold">${game.name}</p>
                                    <p class="is-size-7 opacity-50">${game.id}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                $('#wishlistSearchResults').html(html);
            }).fail(() => {
                $('#wishlistSearchResults').html('<p class="has-text-centered py-4 has-text-danger">Erro ao buscar. Verifique o console.</p>');
            });
        }, 300);
    }

    function addGameToWishlistFromTitleDB(titleId, titleName) {
        $.ajax({
            url: '/api/wishlist',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ title_id: titleId }),
            success: (res) => {
                if (res.success) {
                    showToast(`"${titleName}" adicionado à wishlist!`, 'success');
                    closeModal('addToWishlistModal');
                    loadWishlist();
                } else {
                    showToast(res.error || 'Erro ao adicionar', 'error');
                }
            },
            error: () => {
                showToast('Erro ao adicionar à wishlist', 'error');
            }
        });
    }


    {% endraw %}
</script>


{% endblock %}