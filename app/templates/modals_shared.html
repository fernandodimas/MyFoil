<!-- Shared Modals for MyFoil -->



<!-- Game Details Modal -->
<div class="modal" id="gameDetailsModal" style="z-index: 1040;">
    <div class="modal-background" onclick="closeModal('gameDetailsModal')"></div>
    <div class="modal-card"
        style="max-height: 90vh; max-width: 90vw; width: 90vw; overflow: hidden; border-radius: 12px;">
        <section class="modal-card-body p-0 overflow-y-auto" id="modalContent">
            <!-- Injected via JS -->
        </section>
    </div>
</div>

<!-- DLC Details Modal (New) -->
<div class="modal" id="dlcDetailsModal" style="z-index: 1050;">
    <div class="modal-background" onclick="closeModal('dlcDetailsModal')"></div>
    <div class="modal-card" style="max-height: 80vh; overflow: hidden; border-radius: 12px; width: 800px;">
        <header class="modal-card-head">
            <p class="modal-card-title is-size-5" id="dlcModalTitle">Detalhes da DLC</p>
            <button class="delete" aria-label="close" onclick="closeModal('dlcDetailsModal')"></button>
        </header>
        <section class="modal-card-body p-0 overflow-y-auto" id="dlcModalContent">
            <!-- Injected via JS -->
        </section>
    </div>
</div>

<!-- Edit Metadata Modal -->
<div class="modal" id="editMetadataModal" style="z-index: 1100;">
    <div class="modal-background" onclick="closeModal('editMetadataModal')"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Editar Dados do Jogo</p>
            <button class="delete" aria-label="close" onclick="closeModal('editMetadataModal')"></button>
        </header>
        <section class="modal-card-body">
            <!-- Search TitleDB Section -->
            <div class="box has-background-light-soft mb-4">
                <label class="label is-small">Buscar Metadados na Base Geral (TitleDB)</label>
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input class="input is-small" type="text" id="searchTitleDBInput"
                            placeholder="Digite o nome do jogo (ex: Mario)">
                    </div>
                    <div class="control">
                        <button class="button is-small is-info" onclick="searchTitleDB()">
                            <span class="icon is-small"><i class="bi bi-search"></i></span>
                            <span>Buscar</span>
                        </button>
                    </div>
                </div>
                <div id="titleDBSearchResults" class="mt-2" style="max-height: 150px; overflow-y: auto;"></div>
            </div>

            <input type="hidden" id="editMetaId">
            <div class="field">
                <label class="label">Nome</label>
                <div class="control">
                    <input class="input" type="text" id="editMetaName">
                </div>
            </div>
            <div class="field">
                <label class="label">Publisher</label>
                <div class="control">
                    <input class="input" type="text" id="editMetaPublisher">
                </div>
            </div>
            <div class="field">
                <label class="label">Descrição</label>
                <div class="control">
                    <textarea class="textarea" id="editMetaDescription"></textarea>
                </div>
            </div>
            <div class="field">
                <label class="label">URL do Ícone</label>
                <div class="control">
                    <input class="input" type="text" id="editMetaIcon">
                </div>
            </div>
            <div class="field">
                <label class="label">URL do Banner</label>
                <div class="control">
                    <input class="input" type="text" id="editMetaBanner">
                </div>
            </div>
            <div class="columns">
                <div class="column">
                    <div class="field">
                        <label class="label">Gênero</label>
                        <div class="control">
                            <input class="input" type="text" id="editMetaGenre" placeholder="Ex: Ação, RPG">
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="field">
                        <label class="label">Data de Lançamento</label>
                        <div class="control">
                            <input class="input" type="text" id="editMetaRelease" placeholder="Ex: 2023-11-14">
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <footer class="modal-card-foot is-justify-content-flex-end">
            <button class="button" onclick="closeModal('editMetadataModal')">Cancelar</button>
            <button class="button is-primary" id="btnSaveMetadata" onclick="saveGameMetadata()">Salvar
                Alterações</button>
        </footer>
    </div>
</div>

<!-- Confirmation Modal (Generic) -->
<div class="modal" id="genericConfirmModal" style="z-index: 9999;">
    <div class="modal-background" onclick="closeModal('genericConfirmModal')"></div>
    <div class="modal-card" style="max-width: 450px;">
        <header class="modal-card-head py-3">
            <p class="modal-card-title is-size-6" id="confirmTitle">Confirmar Ação</p>
            <button class="delete" aria-label="close" onclick="closeModal('genericConfirmModal')"></button>
        </header>
        <section class="modal-card-body py-4">
            <div class="is-flex is-align-items-center mb-0">
                <span class="icon is-large has-text-warning mr-2">
                    <i class="bi bi-exclamation-triangle-fill is-size-3"></i>
                </span>
                <p id="confirmMessage" class="is-size-6">Deseja realmente prosseguir com esta ação?</p>
            </div>
        </section>
        <footer class="modal-card-foot is-justify-content-flex-end py-2">
            <button class="button is-small is-light" onclick="closeModal('genericConfirmModal')">Cancelar</button>
            <button class="button is-small is-primary" id="btnConfirmAction">Confirmar</button>
        </footer>
    </div>
</div>

<script>
    const openModal = (id) => $(`#${id}`).addClass('is-active');
    const closeModal = (id) => $(`#${id}`).removeClass('is-active');

    // Generic Confirmation Helper
    window.confirmAction = function (options) {
        const { title, message, onConfirm, confirmText, confirmClass } = options;
        $('#confirmTitle').text(title || 'Confirmar Ação');
        $('#confirmMessage').text(message || 'Deseja realmente prosseguir?');
        $('#btnConfirmAction').text(confirmText || 'Confirmar');
        $('#btnConfirmAction').attr('class', `button is-small ${confirmClass || 'is-primary'}`);

        $('#btnConfirmAction').off('click').on('click', function () {
            if (onConfirm) onConfirm();
            closeModal('genericConfirmModal');
        });

        openModal('genericConfirmModal');
    };

    function showGameDetails(id) {
        $.getJSON(`/api/app_info/${id}`, (game) => {
            $('#modalTitle').text(game.name);

            // Set navigation context for keyboard shortcuts
            if (typeof games !== 'undefined' && games.length) {
                window.setModalNavigationContext(id, games);
            } else if (typeof filteredGames !== 'undefined' && filteredGames.length) {
                window.setModalNavigationContext(id, filteredGames);
            }

            // Base Files Section
            let filesHtml = game.files && game.files.length > 0 ? `
                <div class="mb-5">
                    <p class="heading has-text-weight-bold mb-3 has-text-primary">Arquivos Base Encontrados (${game.files.length})</p>
                    ${game.files.map(f => `
                        <div class="box is-shadowless border p-3 mb-2 bg-light-soft">
                            <div class="columns is-vcentered is-mobile is-gapless">
                                <div class="column">
                                    <p class="is-size-7 has-text-weight-bold break-word" title="${f.filename}">${f.filename}</p>
                                    <p class="is-size-7 opacity-50 break-word" title="${f.filepath}">${f.filepath}</p>
                                </div>
                                <div class="column is-narrow ml-2 is-flex align-items-center">
                                    <span class="tag is-info is-light font-mono mr-1">v${f.version || '0'}</span>
                                    <span class="tag is-light font-mono mr-2">${f.size_formatted || '--'}</span>
                                    <a href="/api/get_game/${f.id}" class="button is-primary is-small mr-1" title="Download">
                                        <span class="icon is-small"><i class="bi bi-download"></i></span>
                                    </a>
                                    <button class="button is-danger is-small is-light" onclick="deleteGameFile(${f.id}, '${game.id}')" title="Excluir Arquivo">
                                        <span class="icon is-small"><i class="bi bi-trash-fill"></i></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : (!game.has_base ? `<p class="notification is-warning is-light p-2 is-size-7" style="border: 1px solid rgba(0,0,0,0.1)">${t('Missing Base File')}</p>` : '');

            // Updates Section
            const sortedUpdates = [...(game.updates || [])].sort((a, b) => b.version - a.version);
            let updatesHtml = '';

            if (sortedUpdates.length === 0) {
                updatesHtml = `
                    <div class="mb-5">
                        <p class="heading has-text-weight-bold mb-3 has-text-link">${t('Updates')}</p>
                        <p class="is-size-7 opacity-50 italic">${t('No DLCs or Updates available')}</p>
                    </div>
                `;
            } else {
                const latest = sortedUpdates[0];
                const others = sortedUpdates.slice(1);

                const renderUpdateRow = (u) => {
                    const file = u.files && u.files.length > 0 ? u.files[0] : null;
                    const isRedundant = u !== latest && game.updates.length > 1;
                    const ignoreId = `ignore-upd-${u.version}`;
                    return `
                        <tr>
                            <td class="has-text-weight-bold">v${u.version}</td>
                            <td class="opacity-70">${u.release_date || '--'}</td>
                            <td class="has-text-centered">
                                ${u.owned && file ? `
                                    <div class="field is-grouped is-grouped-centered is-align-items-center">
                                        <span class="tag is-light font-mono mr-2 is-hidden-mobile">${file.size_formatted || '--'}</span>
                                        ${isRedundant ? '<span class="tag tag-redundant mr-1 has-text-weight-bold">REDUNDANTE</span>' : ''}
                                        <p class="control">
                                            <a href="/api/get_game/${file.id}" class="button is-primary is-small" title="Download">
                                                <i class="bi bi-download"></i>
                                            </a>
                                        </p>
                                        <p class="control">
                                            <button class="button is-danger is-small is-light" onclick="deleteGameFile(${file.id}, '${game.id}')" title="Excluir">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </p>
                                    </div>
                                ` : (u.owned ? '<span class="tag is-warning is-light is-small">Erro</span>' : '<span class="tag is-danger is-light is-small">Falta</span>')}
                            </td>
                            <td class="has-text-centered">
                                <input type="checkbox" class="is-small" 
                                    id="${ignoreId}"
                                    title="Ignorar esta atualização"
                                    onchange="toggleItemIgnore('${game.id}', 'update', '${u.version}', this.checked)">
                            </td>
                        </tr>
                    `;
                };

                updatesHtml = `
                    <div class="mb-5">
                        <div class="is-flex is-justify-content-between is-align-items-center mb-3">
                            <p class="heading has-text-weight-bold has-text-link mb-0">Histórico de Atualizações</p>
                            ${others.length > 0 ? `<button class="button is-ghost is-small p-0" onclick="$('#otherUpdates').toggleClass('is-hidden'); $(this).find('i').toggleClass('bi-chevron-down bi-chevron-up')">
                                <span class="is-size-7 mr-1 text-primary">${others.length} mais</span>
                                <i class="bi bi-chevron-down text-primary"></i>
                            </button>` : ''}
                        </div>
                        <div class="table-container">
                            <table class="table is-narrow is-fullwidth is-size-7">
                                <thead>
                                    <tr>
                                        <th>Versão</th>
                                        <th>Lançamento</th>
                                        <th class="has-text-centered">Status</th>
                                        <th class="has-text-centered" title="Ignorar">Ignorar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${renderUpdateRow(latest)}
                                </tbody>
                                <tbody id="otherUpdates" class="is-hidden">
                                    ${others.map(u => renderUpdateRow(u)).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // DLCs Section
            let dlcsHtml = game.dlcs && game.dlcs.length > 0 ? `
                <div class="mb-5">
                    <p class="heading has-text-weight-bold mb-3 has-text-success">Conteúdo Adicional (DLCs)</p>
                    <div class="table-container">
                        <table class="table is-narrow is-fullwidth is-size-7">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th class="has-text-centered">Lançamento</th>
                                    <th class="has-text-centered">Status</th>
                                    <th class="has-text-centered" title="Ignorar">Ignorar</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${game.dlcs.map(d => {
                const file = d.files && d.files.length > 0 ? d.files[0] : null;
                const ignoreId = `ignore-dlc-${d.app_id}`;
                return `
                                    <tr>
                                        <td class="has-text-weight-bold" onclick="showDlcDetails('${d.app_id}')" style="cursor: pointer; color: inherit;" title="Ver detalhes desta DLC">${d.name}</td>
                                        <td class="opacity-50 font-mono has-text-centered">${d.release_date || d.releaseDate || '--'}</td>
                                        <td class="has-text-centered">
                                            ${d.owned && file ? `
                                                <div class="field is-grouped is-grouped-centered is-align-items-center">
                                                    <span class="tag is-light font-mono mr-2 is-hidden-mobile">${file.size_formatted || '--'}</span>
                                                    <p class="control">
                                                        <a href="/api/get_game/${file.id}" class="button is-primary is-light is-small" title="Download">
                                                            <i class="bi bi-download"></i>
                                                        </a>
                                                    </p>
                                                    <p class="control">
                                                        <button class="button is-danger is-small is-light" onclick="deleteGameFile(${file.id}, '${game.id}')" title="Excluir">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </p>
                                                </div>
                                            ` : (d.owned ? '<span class="tag is-warning is-light is-small">Erro</span>' : '<span class="tag is-danger is-light is-small">Falta</span>')}
                                        </td>
                                        <td class="has-text-centered">
                                            <input type="checkbox" class="is-small"
                                                id="${ignoreId}"
                                                title="Ignorar esta DLC"
                                                onchange="toggleItemIgnore('${game.id}', 'dlc', '${d.app_id}', this.checked)">
                                        </td>
                                    </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            ` : '';

            let content = `
                <div class="modal-banner-container" style="position: relative; height: 240px; overflow: hidden; background: var(--bulma-background);">
                    <img src="${game.bannerUrl || game.iconUrl || '/static/img/no-icon.png'}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.6; filter: blur(2px);">
                    <button class="delete is-large" aria-label="close" onclick="closeModal('gameDetailsModal')" style="position: absolute; top: 1.5rem; right: 1.5rem; background-color: rgba(255,255,255,0.2); backdrop-filter: blur(8px); z-index: 20; border: 1px solid rgba(255,255,255,0.1);"></button>
                </div>
                <div class="p-6">
                    <div class="columns is-variable is-6">
                        <div class="column is-4">
                            <figure class="image is-square box p-0 shadow-lg overflow-hidden mb-5" style="margin-top: -100px; position: relative; z-index: 15; border: 4px solid var(--bulma-card-background); border-radius: 12px; transition: transform 0.3s ease;">
                                <img src="${game.iconUrl || '/static/img/no-icon.png'}" alt="Icon" style="height: 100%; width: 100%; object-fit: cover;">
                            </figure>
                            <div class="box p-4 is-shadowless border bg-light-soft" style="border-radius: 12px;">
                                <div class="mb-3">
                                    <p class="is-size-7 heading mb-1 opacity-50">Publisher</p>
                                    <p class="is-size-6 has-text-weight-bold">${game.publisher || '--'}</p>
                                </div>
                                <div class="mb-3">
                                    <p class="is-size-7 heading mb-1 opacity-50">Lançamento</p>
                                    <p class="is-size-6">${game.release_date || '--'}</p>
                                </div>
                                <div class="mb-3">
                                    <p class="is-size-7 heading mb-1 opacity-50">Versão</p>
                                    <p class="is-size-6"><span class="tag is-info is-light has-text-weight-bold">v${game.display_version}</span></p>
                                </div>
                                <div class="mb-3">
                                    <p class="is-size-7 heading mb-1 opacity-50">Total em Disco</p>
                                    <p class="is-size-6 has-text-weight-bold font-mono">${game.size_formatted || '--'}</p>
                                </div>
                                <div>
                                    <p class="is-size-7 heading mb-1 opacity-50">${t('Genre')}</p>
                                    <div class="tags">
                                        ${Array.isArray(game.category) ? game.category.map(c => `<span class="tag is-small is-light">${c}</span>`).join('') : `<span class="tag is-small is-light">${game.category || '--'}</span>`}
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <a href="${game.nsuid ? 'https://ec.nintendo.com/apps/' + game.nsuid + '/US' : (window.currentLocale === 'pt_BR' ? 'https://www.nintendo.com/pt-br/search/#q=' + encodeURIComponent(game.name) : 'https://www.nintendo.com/us/search/#q=' + encodeURIComponent(game.name))}" target="_blank" class="button is-small is-light is-fullwidth" style="border-color: #e60012; color: #e60012; --bulma-text: #e60012;">
                                        <span class="icon"><i class="bi bi-shop"></i></span>
                                        <span>eShop</span>
                                    </a>
                                </div>
                                <hr class="my-4 opacity-5">
                                <div class="mb-3">
                                    <p class="is-size-7 heading mb-1 opacity-50">${t('Custom Tags')}</p>
                                    <div id="gameModalTags" class="tags mb-2">
                                        <!-- Tags will be loaded here -->
                                    </div>
                                    <div class="field has-addons">
                                        <div class="control is-expanded">
                                            <div class="select is-small is-fullwidth">
                                                <select id="modalAddTagSelect">
                                                    <option value="">${t('Add Tag...')}</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="control">
                                            <button class="button is-small is-primary" onclick="addTagToGame('${game.id}')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <hr class="my-4 opacity-5"/>
                                <div class="wishlist-section mb-2">
                                    <button id="btnWishlist" class="button is-fullwidth is-small is-light" onclick="toggleWishlist('${game.id}')">
                                        <span class="icon"><i class="bi bi-heart"></i></span>
                                        <span>${t('Wishlist')}</span>
                                    </button>
                                </div>
                                <div class="edit-section">
                                    <button class="button is-fullwidth is-small is-ghost has-text-grey" 
                                            onclick="editGameMetadata('${game.id}')"
                                            ${!game.owned ? 'disabled title="Jogo não está na biblioteca"' : ''}>
                                        <span class="icon"><i class="bi bi-pencil"></i></span>
                                        <span>Editar Dados</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                                <div class="ignore-section mb-2">
                                    <p class="is-size-7 has-text-weight-bold mb-2">Ignorar notificações de:</p>
                                    <div class="field">
                                        <label class="checkbox is-small">
                                            <input type="checkbox" id="ignoreDlc" onchange="toggleIgnoreGame('${game.id}', 'dlc', this.checked)">
                                            DLCs
                                        </label>
                                    </div>
                                    <div class="field">
                                        <label class="checkbox is-small">
                                            <input type="checkbox" id="ignoreUpdate" onchange="toggleIgnoreGame('${game.id}', 'update', this.checked)">
                                            Updates
                                        </label>
                                    </div>
                                </div>
                                <div class="edit-section">
                                    <button class="button is-fullwidth is-small is-ghost has-text-grey" 
                                            onclick="editGameMetadata('${game.id}')"
                                            ${!game.owned ? 'disabled title="Jogo não está na biblioteca"' : ''}>
                                        <span class="icon"><i class="bi bi-pencil"></i></span>
                                        <span>Editar Dados</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                                <div class="edit-section">
                                    <button class="button is-fullwidth is-small is-ghost has-text-grey" 
                                            onclick="editGameMetadata('${game.id}')"
                                            ${!game.owned ? 'disabled title="Jogo não está na biblioteca"' : ''}>
                                        <span class="icon"><i class="bi bi-pencil"></i></span>
                                        <span>Editar Dados</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="column is-8">
                            <div class="mb-6">
                                <h2 class="title is-3 mb-4" style="font-weight: 800; letter-spacing: -0.5px;">${game.name}</h2>
                                <p class="is-size-7 font-mono opacity-50 mb-4">${game.id}</p>
                                <div class="content is-size-6 opacity-80" style="line-height: 1.7;">
                                    ${game.description || t('No description available')}
                                </div>
                            </div>
                            
                            <hr class="my-5 opacity-10">
                            
                            <div class="details-sections mt-4">
                                ${filesHtml}
                                ${updatesHtml}
                                ${dlcsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $('#modalContent').html(content);
            loadGameTagsAndWishlist(game.id);
            openModal('gameDetailsModal');
        });
    }

    function showDlcDetails(id) {
        $.getJSON(`/api/app_info/${id}`, (dlc) => {
            $('#dlcModalTitle').text(dlc.name);
            let content = `
                <div class="p-6">
                    <div class="columns">
                        <div class="column is-4">
                            <figure class="image is-square box p-0 shadow-sm overflow-hidden mb-4">
                                <img src="${dlc.iconUrl || '/static/img/no-icon.png'}" style="height: 100%; width: 100%; object-fit: cover;">
                            </figure>
                        </div>
                        <div class="column is-8">
                            <h3 class="title is-4 mb-2">${dlc.name}</h3>
                            <p class="is-size-7 font-mono opacity-50 mb-4">${dlc.id}</p>
                            <div class="columns is-mobile mb-4">
                                <div class="column">
                                    <p class="is-size-7 heading mb-1 opacity-50">Data de Lançamento</p>
                                    <p class="is-size-6">${dlc.release_date || dlc.releaseDate || '--'}</p>
                                </div>
                                <div class="column">
                                    <p class="is-size-7 heading mb-1 opacity-50">Status</p>
                                    <p class="is-size-6">${dlc.owned ? '<span class="has-text-success"><i class="bi bi-check-circle-fill"></i> Sim</span>' : '<span class="has-text-danger"><i class="bi bi-x-circle-fill"></i> Não</span>'}</p>
                                </div>
                            </div>
                            <div class="content is-size-7 opacity-80 mb-4">
                                ${dlc.description || 'Nenhuma descrição disponível para esta DLC.'}
                            </div>
                            
                            ${dlc.files && dlc.files.length > 0 ? `
                                <div class="box has-background-light-soft p-3">
                                    <p class="is-size-7 heading mb-2 opacity-50">Arquivos Identificados</p>
                                    ${dlc.files.map(f => `
                                        <div class="mb-2 pb-2" style="border-bottom: 1px solid rgba(0,0,0,0.05)">
                                            <p class="is-size-7 has-text-weight-bold truncate" title="${f.filename}">${f.filename}</p>
                                            <p class="is-size-7 opacity-50 font-mono truncate" style="font-size: 0.65rem !important;" title="${f.filepath}">${f.filepath}</p>
                                            <p class="is-size-7 opacity-50">Tamanho: ${f.size_formatted}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <hr class="my-4 opacity-10">
                    <div class="buttons is-right">
                        <button class="button is-small" onclick="closeModal('dlcDetailsModal')">Fechar</button>
                    </div>
                </div>
            `;
            $('#dlcModalContent').html(content);
            openModal('dlcDetailsModal');
        });
    }

    function deleteGameFile(fileId, titleId) {
        confirmAction({
            title: 'Confirmar Exclusão',
            message: 'Tem certeza que deseja excluir este arquivo? Esta ação não pode ser desfeita.',
            confirmText: 'Excluir',
            confirmClass: 'is-danger',
            onConfirm: () => {
                const btn = $(event.target).closest('.button');
                btn.addClass('is-loading');
                
                $.post(`/api/files/delete/${fileId}`, (res) => {
                    btn.removeClass('is-loading');
                    if (res.success) {
                        showGameDetails(titleId);
                        if (typeof applyFilters === 'function') {
                            $.getJSON(`/api/app_info/${titleId}`, (updatedGame) => {
                                if (!updatedGame || !updatedGame.id) return;
                                const idx = games.findIndex(g => g && g.id === titleId);
                                if (idx !== -1) {
                                    games[idx] = updatedGame;
                                    localStorage.setItem('myfoil_library_cache', JSON.stringify(games));
                                    applyFilters();
                                }
                            });
                        }
                        if (typeof loadWishlist === 'function') loadWishlist();
                        showToast('Arquivo excluído com sucesso', 'success');
                    } else {
                        showToast(res.error || 'Erro ao excluir', 'error');
                    }
                }).fail((xhr) => {
                    btn.removeClass('is-loading');
                    showToast('Erro de comunicação', 'error');
                });
            }
        });
    }

    function loadGameTagsAndWishlist(titleId) {
        titleId = titleId.toUpperCase();
        $.getJSON('/api/tags', (tags) => {
            const select = $('#modalAddTagSelect');
            if (select.length) {
                select.find('option:not(:first)').remove();
                tags.forEach(t => {
                    select.append(`<option value="${t.id}">${t.name}</option>`);
                });
            }
        });
        $.getJSON(`/api/titles/${titleId}/tags`, (tags) => {
            const container = $('#gameModalTags').empty();
            tags.forEach(t => {
                container.append(`
                    <span class="tag" style="background-color: ${t.color}; color: #fff;">
                        ${t.name}
                        <button class="delete is-small" onclick="removeTagFromGame('${titleId}', ${t.id})"></button>
                    </span>
                `);
            });
            });
            $.getJSON('/api/wishlist', (wishlist) => {
                const inWishlist = wishlist.find(i => i.title_id === titleId);
                const btn = $('#btnWishlist');
                if (inWishlist) {
                    btn.removeClass('is-light').addClass('is-danger is-light')
                        .find('i').removeClass('bi-heart').addClass('bi-heart-fill');
                } else {
                    btn.removeClass('is-danger').addClass('is-light')
                        .find('i').removeClass('bi-heart-fill').addClass('bi-heart');
                }
            });
            // Load ignore preferences for DLCs and Updates
            $.getJSON(`/api/library/ignore/${titleId}`, (data) => {
                if (data.dlcs) {
                    Object.entries(data.dlcs).forEach(([app_id, ignored]) => {
                        const cb = document.getElementById(`ignore-dlc-${app_id}`);
                        if (cb) cb.checked = ignored;
                    });
                }
                if (data.updates) {
                    Object.entries(data.updates).forEach(([version, ignored]) => {
                        const cb = document.getElementById(`ignore-upd-${version}`);
                        if (cb) cb.checked = ignored;
                    });
                }
            }).fail(() => {
                // Clear all checkboxes on error
                $('input[id^="ignore-dlc-"], input[id^="ignore-upd-"]').prop('checked', false);
            });
        }

        // Toggle ignore for a specific DLC or Update
        function toggleItemIgnore(titleId, type, itemId, value) {
            $.post(`/api/library/ignore/${titleId}`, {
                type: type,
                item_id: itemId,
                ignored: value
            }, (res) => {
                if (res.success) {
                    const msg = value ? `${type.toUpperCase()} ${itemId} será ignorado` : `${type.toUpperCase()} ${itemId} voltará a aparecer`;
                    showToast(msg, 'success');
                } else {
                    showToast('Erro ao salvar preferência', 'error');
                }
            }).fail(() => {
                showToast('Erro de conexão', 'error');
            });
        }

        function toggleWishlist(titleId) {
        const btn = $('#btnWishlist');
        const isCurrentlyActive = btn.hasClass('is-danger');
        if (isCurrentlyActive) {
            $.ajax({
                url: `/api/wishlist/${titleId}`,
                type: 'DELETE',
                success: () => {
                    btn.removeClass('is-danger').addClass('is-light')
                        .find('i').removeClass('bi-heart-fill').addClass('bi-heart');
                    showToast(t('Removed from Wishlist'));
                    if (typeof loadWishlist === 'function') loadWishlist();
                }
            });
        } else {
            $.ajax({
                url: '/api/wishlist',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ title_id: titleId }),
                success: () => {
                    btn.removeClass('is-light').addClass('is-danger is-light')
                        .find('i').removeClass('bi-heart').addClass('bi-heart-fill');
                    showToast(t('Added to Wishlist'), 'success');
                    if (typeof loadWishlist === 'function') loadWishlist();
                }
            });
        }
    }

    function addTagToGame(titleId) {
        const tagId = $('#modalAddTagSelect').val();
        if (!tagId) return;
        $.ajax({
            url: `/api/titles/${titleId}/tags`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ tag_id: tagId }),
            success: (res) => {
                if (res.success) loadGameTagsAndWishlist(titleId);
            }
        });
    }

    function removeTagFromGame(titleId, tagId) {
        $.ajax({
            url: `/api/titles/${titleId}/tags/${tagId}`,
            type: 'DELETE',
            success: (res) => {
                if (res.success) loadGameTagsAndWishlist(titleId);
            }
        });
    }

    function editGameMetadata(titleId) {
        $.get(`/api/games/${titleId}/custom`, function (response) {
            if (response.success) {
                const d = response.data || {};
                // Attempt to find game in global 'games' list (from index.html) or just use custom data
                const game = (typeof games !== 'undefined') ? games.find(g => g.id === titleId) : d;

                if (!game && !d.name) {
                    showToast('Dados do jogo não encontrados.', 'error');
                    return;
                }

                $('#editMetaId').val(titleId);
                $('#editMetaName').val(d.name || (game ? game.name : ''));
                $('#editMetaPublisher').val(d.publisher || (game ? game.publisher : ''));
                $('#editMetaDescription').val(d.description || (game ? game.description : ''));
                $('#editMetaIcon').val(d.iconUrl || (game ? game.iconUrl : ''));
                $('#editMetaBanner').val(d.bannerUrl || (game ? game.bannerUrl : ''));
                $('#editMetaGenre').val(d.genre || (game ? (Array.isArray(game.category) ? game.category.join(', ') : game.category) : ''));
                $('#editMetaRelease').val(d.release_date || (game ? (game.release_date || game.releaseDate) : ''));

                openModal('editMetadataModal');
            }
        });
    }

    function saveGameMetadata() {
        const titleId = $('#editMetaId').val();
        const data = {
            name: $('#editMetaName').val(),
            publisher: $('#editMetaPublisher').val(),
            description: $('#editMetaDescription').val(),
            iconUrl: $('#editMetaIcon').val(),
            bannerUrl: $('#editMetaBanner').val(),
            genre: $('#editMetaGenre').val(),
            release_date: $('#editMetaRelease').val()
        };

        $('#btnSaveMetadata').addClass('is-loading');

        $.ajax({
            url: `/api/games/${titleId}/custom`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (res) {
                $('#btnSaveMetadata').removeClass('is-loading');
                if (res.success) {
                    closeModal('editMetadataModal');
                    showToast('Dados atualizados com sucesso!');
                    if (typeof refreshLibrary === 'function') refreshLibrary();
                    if (typeof fillErrorsTable === 'function') fillErrorsTable();
                    showGameDetails(titleId);
                } else {
                    showToast('Erro ao salvar: ' + res.error, 'error');
                }
            },
            error: function () {
                $('#btnSaveMetadata').removeClass('is-loading');
                showToast('Erro de conexão ao salvar.', 'error');
            }
        });
    }

    function searchTitleDB() {
        const query = $('#searchTitleDBInput').val();
        if (!query || query.length < 2) return;
        const resultsContainer = $('#titleDBSearchResults');
        resultsContainer.html('<p class="is-size-7 p-2">Buscando...</p>');

        $.getJSON(`/api/titledb/search?q=${encodeURIComponent(query)}`, (results) => {
            if (!results || results.length === 0) {
                resultsContainer.html('<p class="is-size-7 p-2">Nenhum resultado.</p>');
                return;
            }
            let html = '<div class="list is-hoverable">';
            results.forEach(item => {
                const safeItem = JSON.stringify(item).replace(/"/g, '&quot;');
                html += `
                    <a class="list-item" onclick="useMetadata(${safeItem})">
                        <div class="media is-align-items-center">
                            <div class="media-left">
                                <figure class="image is-32x32"><img src="${item.iconUrl || '/static/img/no-icon.png'}" class="is-rounded"></figure>
                            </div>
                            <div class="media-content">
                                <p class="is-size-7 has-text-weight-bold">${item.name}</p>
                                <p class="is-size-7 opacity-50">${item.id}</p>
                            </div>
                        </div>
                    </a>`;
            });
            html += '</div>';
            resultsContainer.html(html);
        });
    }

    function useMetadata(item) {
        if (item.name) $('#editMetaName').val(item.name);
        if (item.publisher) $('#editMetaPublisher').val(item.publisher);
        if (item.description) $('#editMetaDescription').val(item.description);
        if (item.iconUrl) $('#editMetaIcon').val(item.iconUrl);
        if (item.bannerUrl) $('#editMetaBanner').val(item.bannerUrl);
        if (item.category || item.genre) $('#editMetaGenre').val(Array.isArray(item.category) ? item.category.join(', ') : (item.category || item.genre || ''));
        if (item.releaseDate || item.release_date) $('#editMetaRelease').val(item.releaseDate || item.release_date);
    }

    // Keyboard Navigation for Game Details Modal
    let currentGameId = null;
    let availableGames = [];

    // Set current game and available games list for navigation
    window.setModalNavigationContext = function (gameId, gamesList) {
        currentGameId = gameId;
        availableGames = gamesList || [];
    };

    // Navigate to next/previous game
    function navigateGameModal(direction) {
        if (!currentGameId || !availableGames.length) return;

        const currentIndex = availableGames.findIndex(g => g.id === currentGameId);
        if (currentIndex === -1) return;

        let newIndex = direction === 'next' ? currentIndex + 1 : currentIndex - 1;

        if (newIndex < 0) newIndex = availableGames.length - 1;
        if (newIndex >= availableGames.length) newIndex = 0;

        const newGame = availableGames[newIndex];
        if (newGame) {
            showGameDetails(newGame.id);
        }
    }

    // Global keyboard event handler
    $(document).on('keydown', function (e) {
        // Only handle if game details modal is open
        if (!$('#gameDetailsModal').hasClass('is-active')) return;

        // Prevent if user is typing in an input/textarea
        if ($(e.target).is('input, textarea')) return;

        switch (e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                navigateGameModal('prev');
                break;
            case 'ArrowRight':
                e.preventDefault();
                navigateGameModal('next');
                break;
            case 'ArrowUp':
                e.preventDefault();
                navigateGameModal('prev');
                break;
            case 'ArrowDown':
                e.preventDefault();
                navigateGameModal('next');
                break;
            case 'Escape':
                e.preventDefault();
                closeModal('gameDetailsModal');
                break;
            case 'e':
            case 'E':
                e.preventDefault();
                if (currentGameId) editGameMetadata(currentGameId);
                break;
            case 'f':
            case 'F':
                e.preventDefault();
                if (currentGameId) toggleWishlist(currentGameId);
                break;
            case 'd':
            case 'D':
                e.preventDefault();
                // Download file functionality
                console.log('Download shortcut pressed for game:', currentGameId);
                break;
        }
    });
</script>