{% extends "base.html" %}
{% block content %}
{% include 'nav.html' %}

<div class="container mx-auto px-4 py-8 max-w-5xl">

    <!-- Alerts Section -->
    <div class="space-y-4 mb-8">
        {% if admin_account_created == false %}
        <div class="alert alert-error shadow-lg">
            <i class="bi bi-exclamation-triangle-fill text-2xl"></i>
            <div>
                <h3 class="font-bold">{{ t('Missing admin account!') }}</h3>
                <div class="text-xs">{{ t('Authentication is disabled. Anyone can access and change your configuration
                    until an admin is created.') }} <a href="#Authentication"
                        class="link link-hover font-bold underline">{{ t('Add one here') }}</a>.</div>
            </div>
        </div>
        {% endif %}

        {% if valid_keys == false %}
        <div class="alert alert-warning shadow-lg">
            <i class="bi bi-key-fill text-2xl"></i>
            <div>
                <h3 class="font-bold">{{ t('Missing console keys!') }}</h3>
                <div class="text-xs">{{ t('Nintendo content decryption requires keys. Titles will be misidentified.') }}
                    <a target="_blank"
                        href="https://gitlab.com/easyhacking/switch/-/wikis/home/getting-started/dump-keys"
                        class="link link-hover font-bold underline">{{ t('Extraction guide') }}</a>.
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Main Settings Sections -->
    <div class="grid grid-cols-1 gap-12">

        <!-- Authentication -->
        <section id="Authentication" class="card bg-base-100 shadow-xl border border-primary/20 overflow-hidden">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-4 flex items-center gap-2 text-primary">
                    <i class="bi bi-people"></i> {{ t('Authentication') }}
                </h2>

                <div class="overflow-x-auto">
                    <table class="table w-full" id="userTable">
                        <thead>
                            <tr>
                                <th>{{ t('User') }}</th>
                                <th>{{ t('Permissions') }}</th>
                                <th class="text-right">{{ t('Actions') }}</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="divider"></div>

                <div class="collapse collapse-arrow bg-primary/5 border border-primary/20">
                    <input type="checkbox" id="collapseNewUser" />
                    <div class="collapse-title font-bold text-primary">{{ t('Add new user') }}</div>
                    <div class="bg-base-100/50 border border-primary/20 rounded-xl p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="inputNewUser" placeholder="{{ t('Username') }}"
                                class="input input-bordered w-full" />
                            <input type="password" id="inputNewUserPassword" placeholder="{{ t('Password') }}"
                                class="input input-bordered w-full" />
                        </div>
                        <div class="flex flex-wrap gap-6 my-6">
                            <label class="label cursor-pointer gap-2"><input type="checkbox"
                                    id="checkboxNewUserShopAccess" class="checkbox checkbox-primary" checked /> <span
                                    class="label-text">{{ t('Shop Access') }}</span></label>
                            <label class="label cursor-pointer gap-2"><input type="checkbox"
                                    id="checkboxNewUserBackupAccess" class="checkbox checkbox-primary" /> <span
                                    class="label-text">{{ t('Backup Access') }}</span></label>
                            <label class="label cursor-pointer gap-2"><input type="checkbox"
                                    id="checkboxNewUserAdminAccess" class="checkbox checkbox-primary" /> <span
                                    class="label-text">{{ t('Admin Access') }}</span></label>
                        </div>
                        <button class="btn btn-primary w-full md:w-auto" onclick="submitNewUser()">{{ t('Save')
                            }}</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Library Paths -->
        <section id="Library" class="card bg-base-100 shadow-xl border border-primary/20 overflow-hidden">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-4 flex items-center gap-2 text-primary">
                    <i class="bi bi-folder2-open"></i> {{ t('Library') }}
                </h2>
                <p class="text-sm opacity-60 mb-4">{{ t('Path of directory containing your games') }}</p>

                <div class="overflow-x-auto">
                    <table class="table w-full" id="pathsTable">
                        <thead>
                            <tr>
                                <th>{{ t('Path') }}</th>
                                <th class="text-right">{{ t('Actions') }}</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="divider"></div>

                <div class="flex flex-wrap gap-4">
                    <div class="collapse collapse-arrow bg-primary/5 border border-primary/20 flex-grow">
                        <input type="checkbox" id="collapseNewPath" />
                        <div class="collapse-title font-bold text-primary">{{ t('Add library path') }}</div>
                        <div class="collapse-content p-4">
                            <div class="bg-base-100/50 border border-primary/20 rounded-xl p-4 flex gap-2">
                                <input type="text" id="libraryPathInput" placeholder="/path/to/games"
                                    class="input input-bordered flex-grow" />
                                <button class="btn btn-primary" onclick="submitNewLibraryPath()">{{ t('Save')
                                    }}</button>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-outline btn-neutral h-auto min-h-0 py-4 scanBtn" onclick="scanLibrary()">
                        <i class="bi bi-arrow-clockwise"></i> {{ t('Scan library') }}
                    </button>
                </div>
            </div>
        </section>

        <!-- Titles Configuration -->
        <section id="Titles" class="card bg-base-100 shadow-xl border border-primary/20 overflow-hidden">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-4 flex items-center gap-2 text-primary">
                    <i class="bi bi-gear-fill"></i> {{ t('Titles') }}
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-control w-full">
                        <label class="label"><span class="label-text">{{ t('Library Region') }}</span></label>
                        <select id="selectRegion" class="select select-bordered w-full"></select>
                    </div>
                    <div class="form-control w-full">
                        <label class="label"><span class="label-text">{{ t('Library Language') }}</span></label>
                        <select id="selectLanguage" class="select select-bordered w-full"></select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="label"><span class="label-text">{{ t('Console keys') }}</span></label>
                        <input type="file" id="consoleKeysInput" class="file-input file-input-bordered w-full"
                            accept=".keys,.txt" />
                        <label class="label">
                            <span class="label-text-alt opacity-50">{{ t('Tinfoil/MyFoil uses this to identify files')
                                }}</span>
                            {% if valid_keys %}<span class="label-text-alt text-success">{{ t('Keys are valid')
                                }}</span>{% endif %}
                        </label>
                    </div>
                </div>

            </div>

            <div class="divider"></div>

            <div class="form-control">
                <label class="label cursor-pointer justify-start gap-4">
                    <input type="checkbox" id="useDbiVersionsCheck" class="checkbox checkbox-primary" />
                    <span class="label-text font-bold">{{ t('Fetch updates from DBI database') }}</span>
                </label>
                <span class="text-xs opacity-50 ml-12">{{ t('Use DBI versions database instead of TitleDB for
                    updates and DLCs') }}</span>
            </div>

            <button class="btn btn-primary mt-4 w-full md:w-auto" onclick="submitTitlesSettings()">{{ t('Save')
                }}</button>
    </div>
    </section>

    <!-- TitleDB Sources -->
    <section id="TitleDB" class="card bg-base-100 shadow-xl border border-primary/20 overflow-hidden">
        <div class="card-body">
            <h2 class="card-title text-2xl mb-4 flex items-center gap-2 text-primary">
                <i class="bi bi-database-fill"></i> {{ t('TitleDB Sources') }}
            </h2>

            {% if active_source %}
            <div class="alert {{ 'alert-success' if active_source.is_updated else 'alert-warning' }} shadow-sm mb-6">
                <i
                    class="bi {{ 'bi-check-circle-fill' if active_source.is_updated else 'bi-exclamation-triangle-fill' }} text-xl"></i>
                <div class="text-sm">
                    <div class="font-bold">{{ t('Current Active Source') }}: {{ active_source.name }}</div>
                    <div class="opacity-70">{{ t('Last local update') }}: {{ active_source.time_since }} {{ t('ago')
                        }} ({{ t('Up to date') if active_source.is_updated else t('Outdated') }})</div>
                    <div class="mt-1">
                        <span class="opacity-70">{{ t('Loaded Titles File') }}:</span>
                        <a href="/static/titledb/{{ active_source.loaded_titles_file }}" target="_blank"
                            class="badge badge-ghost hover:badge-primary font-mono text-xs cursor-pointer tracking-tighter">{{
                            active_source.loaded_titles_file }}</a>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="overflow-x-auto mb-6">
                <table class="table table-sm w-full" id="titledbSourcesTable">
                    <thead>
                        <tr>
                            <th>{{ t('Name') }}</th>
                            <th>{{ t('Type') }}</th>
                            <th>{{ t('Priority') }}</th>
                            <th>{{ t('Status') }}</th>
                            <th class="text-right">{{ t('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="flex flex-wrap gap-4 items-center">
                <div class="collapse collapse-arrow bg-primary/5 border border-primary/20 flex-grow">
                    <input type="checkbox" id="collapseNewSource" />
                    <div class="collapse-title font-bold">{{ t('Add custom source') }}</div>
                    <div class="collapse-content p-4">
                        <div class="bg-base-100/50 border border-primary/20 rounded-xl p-4 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="inputSourceName" placeholder="{{ t('Source Name') }}"
                                    class="input input-bordered w-full" />
                                <input type="text" id="inputSourceUrl" placeholder="https://..."
                                    class="input input-bordered w-full" />
                                <select id="inputSourceType" class="select select-bordered w-full">
                                    <option value="json" selected>{{ t('JSON (Direct)') }}</option>
                                    <option value="zip_legacy">{{ t('Legacy (ZIP)') }}</option>
                                </select>
                                <input type="number" id="inputSourcePriority" value="50"
                                    class="input input-bordered w-full" />
                            </div>
                            <button class="btn btn-primary w-full md:w-auto" onclick="submitNewSource()">Add</button>
                        </div>
                    </div>
                </div>
                <button class="btn btn-neutral updateTitleDBBtn" onclick="forceTitleDBUpdate()">{{ t('Force TitleDB
                    Update') }}</button>
            </div>

        </div>
    </section>

    <!-- Shop Configuration -->
    <section id="Shop" class="card bg-base-100 shadow-xl border border-primary/20 overflow-hidden mb-12">
        <div class="card-body">
            <h2 class="card-title text-2xl mb-4 flex items-center gap-2 text-primary">
                <i class="bi bi-cart-fill"></i> {{ t('Shop') }}
            </h2>

            <div class="space-y-6">
                <div class="form-control w-full">
                    <label class="label"><span class="label-text font-bold">{{ t('Shop URL') }}</span></label>
                    <input id="shopHostInput" placeholder="shop.domain.tld" class="input input-bordered w-full" />
                    <span class="label-text-alt opacity-50 mt-1">{{ t('Configure your shop URL to enable host
                        verification.') }}</span>
                </div>

                <div class="flex flex-wrap gap-8">
                    <label class="label cursor-pointer gap-2"><input type="checkbox" id="publicShopCheck"
                            class="checkbox checkbox-primary" /> <span class="label-text font-bold">{{ t('Public
                            shop') }}</span></label>
                    <label class="label cursor-pointer gap-2"><input type="checkbox" id="encryptShopCheck"
                            class="checkbox checkbox-primary" /> <span class="label-text font-bold">{{ t('Encrypt
                            shop') }}</span></label>
                </div>

                <div class="form-control w-full">
                    <label class="label"><span class="label-text font-bold">{{ t('Message of the day')
                            }}</span></label>
                    <textarea id="motdTextArea" rows="3" class="textarea textarea-bordered w-full"></textarea>
                </div>

                <div class="form-control w-full max-w-xs">
                    <label class="label"><span class="label-text font-bold">{{ t('Application language')
                            }}</span></label>
                    <select id="languageSelect" class="select select-bordered" onchange="changeLanguage(this.value)">
                        <option value="en">{{ t('English (Default)') }}</option>
                        <option value="pt_BR">{{ t('PortuguÃªs (Brasil)') }}</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary mt-8 w-full md:w-auto" onclick="submitShopSettings()">{{ t('Save')
                }}</button>
        </div>
    </section>

</div>
</div>

<!-- Custom Modals (Using daisyUI Dialog) -->
<dialog id="deleteUserModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">{{ t('Delete user') }}</h3>
        <p class="py-4 modal-text"></p>
        <div class="modal-action">
            <button class="btn" onclick="deleteUserModal.close()">{{ t('Cancel') }}</button>
            <button class="btn btn-error btn-confirm">{{ t('Delete') }}</button>
        </div>
    </div>
</dialog>

<dialog id="deletePathModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">{{ t('Delete library path') }}</h3>
        <p class="py-4 modal-text"></p>
        <div class="modal-action">
            <button class="btn" onclick="deletePathModal.close()">{{ t('Cancel') }}</button>
            <button class="btn btn-error btn-confirm">{{ t('Delete') }}</button>
        </div>
    </div>
</dialog>

<script>
    let allUsernames = [];

    function getInputVal(id) { return $(`#${id}`).val(); }
    function getCheckboxStatus(id) { return $(`#${id}`).is(":checked"); }

    function scanLibrary(path = null) {
        $('.scanBtn').addClass('btn-disabled opacity-50');
        $.ajax({
            url: '/api/library/scan',
            type: 'POST',
            data: JSON.stringify({ path }),
            contentType: "application/json",
            success: (result) => {
                if (result.success && result.location) window.location.href = result.location;
                $('.scanBtn').removeClass('btn-disabled opacity-50');
            }
        });
    }

    function fillLibraryTable() {
        $.getJSON("/api/settings/library/paths", (result) => {
            const tbody = $('#pathsTable tbody').empty();
            if (!result.paths?.length) tbody.append('<tr><td colspan="2" class="text-center opacity-50">-</td></tr>');
            else {
                result.paths.forEach(path => {
                    const row = $(`
                        <tr>
                            <td class="font-mono text-xs">${path}</td>
                            <td class="text-right flex justify-end gap-1">
                                <button class="btn btn-square btn-ghost btn-xs text-info" onclick="scanLibrary('${path}')"><i class="bi bi-arrow-clockwise"></i></button>
                                <button class="btn btn-square btn-ghost btn-xs text-error" onclick="showDeletePathModal('${path}')"><i class="bi bi-x-circle"></i></button>
                            </td>
                        </tr>
                    `);
                    tbody.append(row);
                });
            }
        });
    }

    function fillUserTable() {
        $.getJSON("/api/users", (result) => {
            const tbody = $('#userTable tbody').empty();
            allUsernames = result.map(u => u.user);
            if (!result.length) tbody.append('<tr><td colspan="3" class="text-center opacity-50">-</td></tr>');
            else {
                result.forEach(user => {
                    const permissions = `
                        <div class="flex gap-2">
                            <span class="badge ${user.shop_access ? 'badge-success' : 'badge-ghost'} badge-xs">Shop</span>
                            <span class="badge ${user.backup_access ? 'badge-success' : 'badge-ghost'} badge-xs">Backup</span>
                            <span class="badge ${user.admin_access ? 'badge-primary' : 'badge-ghost'} badge-xs">Admin</span>
                        </div>
                    `;
                    tbody.append(`
                        <tr>
                            <td class="font-bold">${user.user}</td>
                            <td>${permissions}</td>
                            <td class="text-right">
                                <button class="btn btn-square btn-ghost btn-xs text-error" onclick="showDeleteUserModal(${user.id}, '${user.user}')"><i class="bi bi-x-circle"></i></button>
                            </td>
                        </tr>
                    `);
                });
            }
        });
    }

    function fillTitleDBSourcesTable() {
        $.getJSON("/api/settings/titledb/sources", (result) => {
            if (!result.success) return;
            const tbody = $('#titledbSourcesTable tbody').empty();
            result.sources.forEach(source => {
                tbody.append(`
                    <tr>
                        <td><strong>${source.name}</strong><br><small class="opacity-50 text-[10px] break-all">${source.base_url}</small></td>
                        <td><span class="badge badge-ghost badge-xs uppercase">${source.source_type}</span></td>
                        <td><input type="number" class="input input-bordered input-xs w-16" value="${source.priority}" onchange="updateSourcePriority('${source.name}', this.value)" /></td>
                        <td><span class="badge ${source.enabled ? 'badge-success' : 'badge-ghost'} badge-xs">${source.enabled ? 'Enabled' : 'Disabled'}</span></td>
                        <td class="text-right flex justify-end gap-1">
                             <button class="btn btn-square btn-ghost btn-xs text-${source.enabled ? 'warning' : 'success'}" onclick="toggleSource('${source.name}', ${!source.enabled})"><i class="bi bi-${source.enabled ? 'pause' : 'play'}-fill"></i></button>
                             <button class="btn btn-square btn-ghost btn-xs text-error" onclick="deleteSource('${source.name}')"><i class="bi bi-x-circle"></i></button>
                        </td>
                    </tr>
                `);
            });
        });
    }

    function showDeleteUserModal(id, user) {
        $('#deleteUserModal .modal-text').text(`{{ t('Delete user') }} "${user}"?`);
        $('#deleteUserModal .btn-confirm').attr('onclick', `deleteUser(${id})`);
        deleteUserModal.showModal();
    }

    function showDeletePathModal(path) {
        $('#deletePathModal .modal-text').text(`{{ t('Delete path') }} "${path}"?`);
        $('#deletePathModal .btn-confirm').attr('onclick', `deleteLibraryPath('${path}')`);
        deletePathModal.showModal();
    }

    function deleteUser(id) {
        $.ajax({ url: "/api/user", type: 'DELETE', data: JSON.stringify({ user_id: id }), contentType: "application/json", success: () => { fillUserTable(); deleteUserModal.close(); } });
    }

    function deleteLibraryPath(path) {
        $.ajax({ url: "/api/settings/library/paths", type: 'DELETE', data: JSON.stringify({ path }), contentType: "application/json", success: () => { fillLibraryTable(); deletePathModal.close(); } });
    }

    function submitNewUser() {
        const user = getInputVal("inputNewUser");
        const password = getInputVal("inputNewUserPassword");
        if (!user || !password) return alert('Fill all fields');
        $.ajax({
            url: "/api/user", type: 'POST',
            data: JSON.stringify({
                user, password,
                shop_access: getCheckboxStatus("checkboxNewUserShopAccess"),
                backup_access: getCheckboxStatus("checkboxNewUserBackupAccess"),
                admin_access: getCheckboxStatus("checkboxNewUserAdminAccess")
            }),
            contentType: "application/json",
            success: () => { fillUserTable(); $('#collapseNewUser').prop('checked', false); }
        });
    }

    function submitNewLibraryPath() {
        const path = getInputVal("libraryPathInput");
        if (!path) return;
        $.ajax({ url: "/api/settings/library/paths", type: 'POST', data: JSON.stringify({ path }), contentType: "application/json", success: () => { fillLibraryTable(); $('#collapseNewPath').prop('checked', false); } });
    }

    function toggleSource(name, enabled) {
        $.ajax({ url: "/api/settings/titledb/sources", type: 'PUT', data: JSON.stringify({ name, enabled }), contentType: "application/json", success: fillTitleDBSourcesTable });
    }

    function updateSourcePriority(name, priority) {
        $.ajax({ url: "/api/settings/titledb/sources", type: 'PUT', data: JSON.stringify({ name, priority: parseInt(priority) }), contentType: "application/json", success: fillTitleDBSourcesTable });
    }

    function deleteSource(name) {
        if (confirm(`Delete source ${name}?`)) $.ajax({
            url: "/api/settings/titledb/sources", type: 'DELETE', data: JSON.stringify({ name }), contentType: "application/json", success: () => {
                showToast('Source deleted');
                fillTitleDBSourcesTable();
            }
        });
    }

    function submitNewSource() {
        const data = {
            name: getInputVal('inputSourceName'),
            base_url: getInputVal('inputSourceUrl'),
            priority: parseInt(getInputVal('inputSourcePriority')),
            source_type: $('#inputSourceType').val(),
            enabled: true
        };
        $.ajax({ url: "/api/settings/titledb/sources", type: 'POST', data: JSON.stringify(data), contentType: "application/json", success: () => { fillTitleDBSourcesTable(); $('#collapseNewSource').prop('checked', false); } });
    }

    function forceTitleDBUpdate() {
        const btn = $('.updateTitleDBBtn');
        const oldText = btn.text();
        btn.addClass('btn-disabled').text('Updating...');
        $.post("/api/settings/titledb/update", (r) => {
            if (r.success) showToast('Update started successfully!');
            else showToast('Update failed!', 'error');
            btn.removeClass('btn-disabled').text(oldText);
            fillTitleDBSourcesTable();
        });
    }

    function submitTitlesSettings() {
        const data = {
            region: $('#selectRegion').val(),
            language: $('#selectLanguage').val(),
            dbi_versions: getCheckboxStatus('useDbiVersionsCheck')
        };
        $.ajax({ url: "/api/settings/titles", type: 'POST', data: JSON.stringify(data), contentType: "application/json", success: () => showToast('{{ t("Saved") }}!') });

        const keysFile = $('#consoleKeysInput')[0].files[0];
        if (keysFile) {
            const formData = new FormData();
            formData.append('file', keysFile);
            $.ajax({ url: "/api/settings/keys", type: 'POST', data: formData, processData: false, contentType: false, success: () => window.location.reload() });
        }
    }

    function submitShopSettings() {
        const data = {
            host: getInputVal('shopHostInput'),
            public: getCheckboxStatus('publicShopCheck'),
            encrypt: getCheckboxStatus('encryptShopCheck'),
            motd: getInputVal('motdTextArea')
        };
        $.ajax({ url: "/api/settings/shop", type: 'POST', data: JSON.stringify(data), contentType: "application/json", success: () => showToast('{{ t("Saved") }}!') });
    }

    function changeLanguage(lang) {
        document.cookie = "language=" + lang + ";path=/;max-age=31536000";
        window.location.reload();
    }

    $(document).ready(async () => {
        fillUserTable();
        fillLibraryTable();
        fillTitleDBSourcesTable();

        try {
            // Load regions and languages first
            const [regionsData, languagesData, settingsData] = await Promise.all([
                $.getJSON("/api/settings/regions"),
                $.getJSON("/api/settings/languages"),
                $.getJSON("/api/settings")
            ]);

            // Populate select options
            const selectRegion = $('#selectRegion').empty();
            regionsData.regions.forEach(reg => selectRegion.append(new Option(reg, reg)));

            const selectLanguage = $('#selectLanguage').empty();
            languagesData.languages.forEach(l => selectLanguage.append(new Option(l, l)));

            // Set values
            $('#selectRegion').val(settingsData['titles/region']);
            $('#selectLanguage').val(settingsData['titles/language']);
            $('#shopHostInput').val(settingsData['shop/host']);
            $('#publicShopCheck').prop('checked', settingsData['shop/public']);
            $('#encryptShopCheck').prop('checked', settingsData['shop/encrypt']);
            $('#motdTextArea').val(settingsData['shop/motd']);
            $('#useDbiVersionsCheck').prop('checked', settingsData['shop/dbi_versions']);

            $('#languageSelect').val(document.cookie.match(/language=([^;]+)/)?.[1] || 'en');
        } catch (e) {
            console.error("Failed to load settings:", e);
        }
    });
</script>
{% endblock %}