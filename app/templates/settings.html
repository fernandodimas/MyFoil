{% extends "base.html" %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
{% include 'nav.html' %}

<section class="section">
    <div class="container is-fluid px-5">
        <div class="columns is-variable is-8">

            <!-- Sidebar Navigation -->
            <div class="column is-3">
                <aside class="menu is-sticky" style="top: 80px;">
                    <p class="menu-label has-text-weight-black is-size-5 mb-5 tracking-tighter">
                        <i class="bi bi-sliders2-vertical has-text-primary mr-2"></i> Configurações
                    </p>
                    <ul class="menu-list" id="settingsNav">
                        <li><a data-target="General" class="is-active"><i class="bi bi-gear-fill mr-2"></i> Geral</a>
                        </li>
                        <li><a data-target="Authentication"><i class="bi bi-people-fill mr-2"></i> Autenticação</a></li>
                        <li><a data-target="Library"><i class="bi bi-folder2-open mr-2"></i> Biblioteca</a></li>
                        <li><a data-target="FileExplorer"><i class="bi bi-files mr-2"></i> Explorador de Arquivos</a>
                        </li>
                        <li><a data-target="Renaming"><i class="bi bi-pencil-square mr-2"></i> Renomeação</a></li>
                        <li><a data-target="TitleDB"><i class="bi bi-database-fill mr-2"></i> TitleDB</a>
                        </li>
                        <li><a data-target="Shop"><i class="bi bi-cart-fill mr-2"></i> Loja</a></li>
                        <li><a data-target="Errors"><i class="bi bi-exclamation-octagon-fill mr-2"></i>
                                Erros/Identificação</a></li>
                        <li><a data-target="Tags"><i class="bi bi-tags-fill mr-2"></i> Tags</a></li>
                        <li><a data-target="Activity"><i class="bi bi-clock-history mr-2"></i> Atividade</a></li>
                        <li><a data-target="Webhooks"><i class="bi bi-plug-fill mr-2"></i> Webhooks <span
                                    class="tag is-warning is-light is-size-9 ml-1"
                                    style="font-size: 0.6rem;">BETA</span></a></li>
                        <li><a data-target="Cloud"><i class="bi bi-cloud-fill mr-2"></i> Cloud Storage <span
                                    class="tag is-warning is-light is-size-9 ml-1"
                                    style="font-size: 0.6rem;">BETA</span></a></li>
                        <li><a data-target="Plugins"><i class="bi bi-patch-check mr-2"></i> Plugins <span
                                    class="tag is-warning is-light is-size-9 ml-1"
                                    style="font-size: 0.6rem;">BETA</span></a></li>
                        <li><a data-target="Help"><i class="bi bi-question-circle mr-2"></i> Ajuda</a></li>
                    </ul>
                </aside>
            </div>

            <!-- Main Content Area -->
            <div class="column is-9">
                <!-- Loading Overlay -->
                <div id="settingsLoading" class="has-text-centered py-6">
                    <button class="button is-loading is-ghost is-large"></button>
                    <p class="mt-4 has-text-weight-bold">Carregando configurações...</p>
                </div>

                <div id="settingsContent" class="is-hidden animate-fade-in settings-container p-5">
                    <!-- Alerts -->
                    <div id="globalAlerts" class="mb-5">
                        {% if admin_account_created == false %}
                        <div class="notification is-ghost border p-4 mb-4"
                            style="border-left: 5px solid var(--color-danger) !important;">
                            <div class="is-flex is-align-items-center gap-3">
                                <i class="bi bi-exclamation-triangle-fill is-size-4 has-text-danger"></i>
                                <div>
                                    <strong class="is-block uppercase is-size-7 tracking-widest has-text-danger">Conta
                                        Admin
                                        Ausente!</strong>
                                    <span class="is-size-7">Autenticação desativada. Qualquer um pode acessar e alterar
                                        configurações.</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if valid_keys == false %}
                        <div id="keysAlert" class="notification is-ghost border p-4 mb-4"
                            style="border-left: 5px solid var(--color-warning) !important;">
                            <div class="is-flex is-align-items-center gap-3">
                                <i class="bi bi-key-fill is-size-4 has-text-warning"></i>
                                <div>
                                    <strong class="is-block uppercase is-size-7 tracking-widest has-text-warning">Chaves
                                        do console
                                        ausentes!</strong>
                                    <span class="is-size-7">
                                        Necessário para decriptar conteúdo Nintendo.
                                        <a target="_blank"
                                            href="https://gitlab.com/easyhacking/switch/-/wikis/home/getting-started/dump-keys"
                                            class="has-text-weight-bold is-underlined ml-1">Guia</a>
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Tab Sections -->

                    <!-- General Section -->
                    <section id="section-General" class="settings-section">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-gear-fill mr-2"></i> Configuração Geral
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <div class="columns is-multiline">
                                    <div class="column is-6">
                                        <div class="field">
                                            <label class="label is-small">Região da Biblioteca</label>
                                            <div class="control is-expanded">
                                                <div class="select is-fullwidth">
                                                    <select id="selectRegion"></select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="column is-6">
                                        <div class="field">
                                            <label class="label is-small">Idioma da Biblioteca</label>
                                            <div class="control is-expanded">
                                                <div class="select is-fullwidth">
                                                    <select id="selectLanguage"></select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="column is-6">
                                        <div class="field">
                                            <label class="label is-small">Idioma da Aplicação</label>
                                            <div class="control is-expanded">
                                                <div class="select is-fullwidth">
                                                    <select id="languageSelect" onchange="changeLanguage(this.value)">
                                                        <option value="en">English</option>
                                                        <option value="pt_BR">Português (Brasil)</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-6 opacity-10">

                                <div class="block">
                                    <h3 class="title is-6 mb-4"><i class="bi bi-key-fill has-text-primary mr-2"></i>
                                        Chaves do Console</h3>
                                    <div class="notification is-ghost border p-5"
                                        style="border-left: 5px solid var(--color-primary) !important;">
                                        <div class="columns is-vcentered">
                                            <div class="column">
                                                <div class="file has-name is-fullwidth">
                                                    <label class="file-label">
                                                        <input class="file-input" type="file" id="consoleKeysInput"
                                                            name="file" accept=".keys,.txt">
                                                        <span class="file-cta">
                                                            <span class="file-icon"><i class="bi bi-upload"></i></span>
                                                            <span class="file-label">Escolher arquivo...</span>
                                                        </span>
                                                        <span class="file-name" id="fileNameDisplay">Nenhum arquivo
                                                            escolhido</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="column is-narrow">
                                                <button class="button is-primary" onclick="submitTitlesSettings()">
                                                    <i class="bi bi-check-lg mr-2"></i> Salvar & Atualizar
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mt-2 is-flex is-align-items-center gap-2">
                                            {% if valid_keys %}
                                            <span class="tag is-success is-light"><i
                                                    class="bi bi-check-circle mr-1"></i> {{ t('Keys are valid')
                                                }}</span>
                                            {% else %}
                                            <span class="tag is-danger is-light"><i class="bi bi-x-circle mr-1"></i> {{
                                                t('Keys missing') }}</span>
                                            {% endif %}
                                            <span class="is-size-7 opacity-50 uppercase tracking-widest">{{ t('Required
                                                for identification') }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Authentication Section -->
                    <section id="section-Authentication" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-people-fill mr-2"></i> {{ t('User Management') }}
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <div class="table-container">
                                    <table class="table is-fullwidth is-hoverable" id="userTable">
                                        <thead>
                                            <tr>
                                                <th>{{ t('User') }}</th>
                                                <th>{{ t('Permissions') }}</th>
                                                <th class="has-text-right">{{ t('Actions') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>

                                <div class="block mt-6">
                                    <h3 class="title is-6 mb-4"><i
                                            class="bi bi-person-plus-fill has-text-primary mr-2"></i> {{ t('Add New
                                        User') }}</h3>
                                    <div class="notification is-ghost border p-5"
                                        style="border-left: 5px solid var(--color-primary) !important;">
                                        <div class="columns">
                                            <div class="column">
                                                <div class="field">
                                                    <label class="label is-small">{{ t('Username') }}</label>
                                                    <div class="control">
                                                        <input class="input" type="text" id="inputNewUser">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="column">
                                                <div class="field">
                                                    <label class="label is-small">{{ t('Password') }}</label>
                                                    <div class="control">
                                                        <input class="input" type="password" id="inputNewUserPassword">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="field is-grouped is-grouped-multiline mb-5">
                                            <div class="control">
                                                <label class="checkbox mr-4">
                                                    <input type="checkbox" id="checkboxNewUserShopAccess" checked> {{
                                                    t('Shop Access') }}
                                                </label>
                                            </div>
                                            <div class="control">
                                                <label class="checkbox mr-4">
                                                    <input type="checkbox" id="checkboxNewUserBackupAccess"> {{
                                                    t('Backup Access') }}
                                                </label>
                                            </div>
                                            <div class="control">
                                                <label class="checkbox">
                                                    <input type="checkbox" id="checkboxNewUserAdminAccess"> {{ t('Admin
                                                    Access') }}
                                                </label>
                                            </div>
                                        </div>

                                        <button class="button is-primary is-fullwidth-mobile" onclick="submitNewUser()">
                                            {{ t('Create Account') }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Library Section -->
                    <section id="section-Library" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-folder2-open mr-2"></i> {{ t('Library Locations') }}
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <!-- Estatísticas removidas conforme solicitação -->
                                <div class="table-container mb-5">
                                    <table class="table is-fullwidth" id="pathsTable">
                                        <thead>
                                            <tr>
                                                <th>{{ t('Storage Path') }}</th>
                                                <th class="has-text-centered">Jogos</th>
                                                <th class="has-text-centered">Arquivos</th>
                                                <th class="has-text-centered">Tamanho</th>
                                                <th class="has-text-centered">Último Scan</th>
                                                <th class="has-text-right">{{ t('Actions') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>

                                <div class="columns is-vcentered">
                                    <div class="column">
                                        <div class="field has-addons">
                                            <div class="control is-expanded">
                                                <input class="input" type="text" id="libraryPathInput"
                                                    placeholder="/mnt/games">
                                            </div>
                                            <div class="control">
                                                <button class="button is-primary" onclick="submitNewLibraryPath()">
                                                    {{ t('Add Path') }}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="column is-narrow">
                                        <button class="button is-warning is-outlined scanBtn mr-2"
                                            onclick="scanLibrary()">
                                            <span class="icon"><i class="bi bi-arrow-clockwise"></i></span>
                                            <span>{{ t('Full Scan') }}</span>
                                        </button>
                                        <button class="button is-warning is-outlined" id="btnCleanupOrphaned"
                                            onclick="cleanupOrphaned()">
                                            <span class="icon"><i class="bi bi-trash"></i></span>
                                            <span>Limpar Órfãos</span>
                                        </button>
                                    </div>
                                </div>
                                <div id="cleanupStats" class="is-hidden mt-3">
                                    <div class="notification is-info is-light py-2 is-size-7">
                                        <span id="cleanupMissingFiles">0</span> arquivos deletados do disco |
                                        <span id="cleanupMissingApps">0</span> registros órfãos
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- File Explorer Section -->
                    <section id="section-FileExplorer" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-info">
                                    <i class="bi bi-files mr-2"></i> Explorador de Arquivos da Biblioteca
                                </p>
                                <div class="card-header-icon pt-4 pr-5">
                                    <button class="button is-small is-dark is-outlined" onclick="fillFilesExplorer()">
                                        <i class="bi bi-arrow-clockwise mr-1"></i> Atualizar
                                    </button>
                                </div>
                            </header>
                            <div class="card-content pt-0">
                                <p class="is-size-7 mb-4 opacity-70">Visualize todos os arquivos físicos indexados na
                                    biblioteca, com
                                    informações detalhadas sobre cada arquivo.</p>

                                <!-- Filters -->
                                <div class="box is-shadowless border p-3 mb-4"
                                    style="border-left: 4px solid var(--color-primary) !important;">
                                    <div class="columns is-mobile">
                                        <div class="column">
                                            <div class="field">
                                                <label class="label is-small">Buscar</label>
                                                <div class="control has-icons-left">
                                                    <input class="input is-small" type="text" id="fileSearchInput"
                                                        placeholder="Buscar em todas as pastas...">
                                                    <span class="icon is-small is-left">
                                                        <i class="bi bi-search"></i>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="column is-narrow">
                                            <div class="field">
                                                <label class="label is-small">Tipo</label>
                                                <div class="control">
                                                    <div class="select is-small is-fullwidth">
                                                        <select id="fileTypeFilter">
                                                            <option value="">Todos</option>
                                                            <option value=".nsp">NSP</option>
                                                            <option value=".nsz">NSZ</option>
                                                            <option value=".xci">XCI</option>
                                                            <option value=".xcz">XCZ</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="column is-narrow">
                                            <div class="field">
                                                <label class="label is-small">Status</label>
                                                <div class="control">
                                                    <div class="select is-small is-fullwidth">
                                                        <select id="fileStatusFilter">
                                                            <option value="">Todos</option>
                                                            <option value="identified">Identificado</option>
                                                            <option value="error">Erro</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Files Table -->
                                <!-- Breadcrumb -->
                                <nav class="breadcrumb is-small mb-4 has-bullet-separator" aria-label="breadcrumbs">
                                    <ul id="fileExplorerBreadcrumb">
                                        <li class="is-active"><a href="javascript:void(0)"
                                                onclick="setExplorerPath('')"><i class="bi bi-hdd-fill mr-1"></i>
                                                Root</a></li>
                                    </ul>
                                </nav>

                                <div class="table-container">
                                    <table class="table is-fullwidth is-hoverable is-size-7" id="filesExplorerTable">
                                        <thead>
                                            <tr>
                                                <th>Nome do Arquivo</th>
                                                <th>Caminho</th>
                                                <th width="100">Tamanho</th>
                                                <th width="120">Tipo</th>
                                                <th width="100" class="has-text-centered">Status</th>
                                                <th width="80" class="has-text-right">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Populated by JS -->
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination Info -->
                                <div class="is-flex is-justify-content-space-between is-align-items-center mt-3">
                                    <span class="is-size-7 opacity-50" id="filesExplorerCount">0 arquivos
                                        encontrados</span>
                                </div>
                            </div>
                        </div>
                    </section>
                    <!-- Renaming Section -->
                    <section id="section-Renaming" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-pencil-square mr-2"></i> Renomeação Automática
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <div class="notification is-ghost border p-4 mb-5"
                                    style="border-left: 5px solid var(--color-info) !important;">
                                    <p class="is-size-7 opacity-70 mb-2">
                                        Use os seguintes placeholders para definir seus padrões:
                                    </p>
                                    <div class="tags">
                                        <span class="tag is-white font-mono pointer"
                                            onclick="insertTag('{Name}')">{Name}</span>
                                        <span class="tag is-white font-mono pointer"
                                            onclick="insertTag('{TitleID}')">{TitleID}</span>
                                        <span class="tag is-white font-mono pointer"
                                            onclick="insertTag('{Version}')">{Version}</span>
                                        <span class="tag is-white font-mono pointer"
                                            onclick="insertTag('{Region}')">{Region}</span>
                                    </div>
                                </div>

                                <div class="field mb-5">
                                    <label class="label is-small">Padrão para Jogo Base (NSP/XCI)</label>
                                    <div class="control">
                                        <input class="input font-mono is-small" type="text" id="patternBase"
                                            placeholder="{Name} [{TitleID}] [v{Version}]">
                                    </div>
                                </div>

                                <div class="field mb-5">
                                    <label class="label is-small">Padrão para Update</label>
                                    <div class="control">
                                        <input class="input font-mono is-small" type="text" id="patternUpd"
                                            placeholder="{Name} [UPD] [{TitleID}] [v{Version}]">
                                    </div>
                                </div>

                                <div class="field mb-6">
                                    <label class="label is-small">Padrão para DLC</label>
                                    <div class="control">
                                        <input class="input font-mono is-small" type="text" id="patternDlc"
                                            placeholder="{Name} [DLC] [{TitleID}] [v{Version}]">
                                    </div>
                                </div>

                                <div class="buttons">
                                    <button class="button is-primary" onclick="saveRenamingSettings()">
                                        <i class="bi bi-save2-fill mr-2"></i> Salvar Padrões
                                    </button>
                                    <button class="button is-ghost" onclick="previewRenaming()">
                                        <i class="bi bi-eye mr-2"></i> Prever
                                    </button>
                                    <button class="button is-danger is-light ml-auto" onclick="runRenamingJob()">
                                        <i class="bi bi-play-circle-fill mr-2"></i> Renomear Tudo Agora
                                    </button>
                                </div>

                                <!-- Preview Result -->
                                <div id="renamingPreview" class="is-hidden mt-5">
                                    <p class="heading has-text-weight-bold mb-3">Pré-visualização</p>
                                    <div class="box is-shadowless border is-size-7 font-mono" id="previewContent"
                                        style="border-left: 4px solid var(--color-primary) !important;">
                                        <!-- content -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- TitleDB Section -->
                    <section id="section-TitleDB" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-database-fill mr-2"></i> {{ t('TitleDB Sources') }}
                                </p>
                                <div class="card-header-icon pt-4 pr-5">
                                    <button class="button is-small is-warning is-outlined updateTitleDBBtn mr-2"
                                        onclick="forceTitleDBUpdate()">
                                        <i class="bi bi-cloud-download mr-1"></i> {{ t('Force Update') }}
                                    </button>
                                    <button class="button is-small is-ghost" onclick="refreshTitleDBDates()"
                                        title="{{ t('Refresh remote dates') }}">
                                        <i class="bi bi-calendar-event mr-1"></i>
                                    </button>
                                </div>
                            </header>
                            <div class="card-content pt-0">
                                {% if active_source %}
                                <nav class="level box is-shadowless notification py-3 mb-6"
                                    style="background: rgba(87,13,248,0.05)">
                                    <div class="level-item has-text-centered">
                                        <div>
                                            <p class="heading">{{ t('Active Source') }}</p>
                                            <p class="title is-5 has-text-primary">{{ active_source.name }}</p>
                                        </div>
                                    </div>
                                    <div class="level-item has-text-centered">
                                        <div>
                                            <p class="heading">{{ t('Last Download') }}</p>
                                            <p class="title is-5">{{ active_source.last_download_date }}</p>
                                        </div>
                                    </div>
                                    <div class="level-item has-text-centered">
                                        <div>
                                            <p class="heading">{{ t('Titles Detected') }}</p>
                                            <p class="title is-5">{{ active_source.titles_count }}</p>
                                        </div>
                                    </div>
                                    <div class="level-item has-text-centered">
                                        <div>
                                            <p class="heading">{{ t('Status') }}</p>
                                            <span
                                                class="tag {{ 'is-success' if active_source.is_updated else 'is-warning' }} is-light">
                                                {{ t('Up to date') if active_source.is_updated else t('Outdated') }}
                                            </span>
                                        </div>
                                    </div>
                                </nav>
                                {% endif %}

                                <div class="table-container">
                                    <table class="table is-fullwidth" id="titledbSourcesTable">
                                        <thead>
                                            <tr>
                                                <th>{{ t('Source') }}</th>
                                                <th>{{ t('Last Modified (Remote)') }}</th>
                                                <th>{{ t('Last Download (Local)') }}</th>
                                                <th>{{ t('Priority') }}</th>
                                                <th>{{ t('Status') }}</th>
                                                <th class="has-text-right">{{ t('Actions') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>

                                <div class="block mt-6">
                                    <button class="button is-small is-primary is-outlined" id="toggleAddSource">
                                        <i class="bi bi-plus-lg mr-2"></i> {{ t('Add Custom Source') }}
                                    </button>

                                    <div id="addSourceForm" class="is-hidden mt-4 notification is-ghost border p-5"
                                        style="border-left: 5px solid var(--color-success) !important;">
                                        <div class="columns is-multiline">
                                            <div class="column is-6">
                                                <div class="field">
                                                    <label class="label is-small">{{ t('Name') }}</label>
                                                    <input class="input is-small" type="text" id="inputSourceName">
                                                </div>
                                            </div>
                                            <div class="column is-6">
                                                <div class="field">
                                                    <label class="label is-small">{{ t('URL') }}</label>
                                                    <input class="input is-small" type="text" id="inputSourceUrl">
                                                </div>
                                            </div>
                                            <div class="column is-6">
                                                <div class="field">
                                                    <label class="label is-small">{{ t('Type') }}</label>
                                                    <div class="select is-small is-fullwidth">
                                                        <select id="inputSourceType">
                                                            <option value="json" selected>JSON</option>
                                                            <option value="zip_legacy">Legacy ZIP</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="column is-6">
                                                <div class="field">
                                                    <label class="label is-small">{{ t('Priority') }}</label>
                                                    <input class="input is-small" type="number" id="inputSourcePriority"
                                                        value="50">
                                                </div>
                                            </div>
                                        </div>
                                        <button class="button is-primary is-small" onclick="submitNewSource()">{{
                                            t('Save Source') }}</button>
                                    </div>
                                </div>

                                <div class="box is-shadowless mt-4" style="background: rgba(87,13,248,0.03);">
                                    <label class="checkbox is-flex is-align-items-center">
                                        <input type="checkbox" id="autoUseLatest" class="mr-2">
                                        {{ t('Auto-use latest') }} - <span class="is-size-7 ml-2 opacity-75">{{
                                            t('Automatically use the source with the most recent data') }}</span>
                                    </label>
                                </div>

                                <div class="buttons mt-4">
                                    <button class="button is-primary" onclick="saveTitleDBSettings()">
                                        <i class="bi bi-check-lg mr-1"></i> {{ t('Save') }}
                                    </button>
                                </div>
                                </header>

                            </div>



                        </div>
                </div>
</section>

<!-- Shop Section -->
<section id="section-Shop" class="settings-section is-hidden">
    <div class="card box shadow-sm">
        <header class="card-header border-none shadow-none">
            <p class="card-header-title has-text-primary">
                <i class="bi bi-cart-fill mr-2"></i> {{ t('Shop Configuration') }}
            </p>
        </header>
        <div class="card-content pt-0">
            <div class="field mb-6">
                <label class="label">{{ t('Public Access URL') }}</label>
                <div class="field has-addons">
                    <p class="control"><a class="button is-static">https://</a></p>
                    <div class="control is-expanded">
                        <input class="input" id="shopHostInput" type="text" placeholder="tinfoil.domain.com">
                    </div>
                </div>
                <p class="help opacity-50">{{ t('Used for host verification and remote access') }}
                </p>
            </div>

            <div class="field is-grouped mb-6">
                <div class="control">
                    <label class="checkbox has-text-weight-bold mr-6">
                        <input type="checkbox" id="publicShopCheck"> {{ t('Public Index') }}
                    </label>
                </div>
                <div class="control">
                    <label class="checkbox has-text-weight-bold">
                        <input type="checkbox" id="encryptShopCheck" checked> {{ t('Encrypted Shop')
                        }}
                    </label>
                </div>
                <div class="control">
                    <label class="checkbox has-text-weight-bold">
                        <input type="checkbox" id="publicProfileCheck"> Perfil Público (Web)
                    </label>
                </div>
            </div>

            <div class="field mb-6">
                <label class="label">{{ t('Message of the Day') }}</label>
                <div class="control">
                    <textarea class="textarea font-mono is-small" id="motdTextArea" rows="4"
                        placeholder="Welcome to MyFoil..."></textarea>
                </div>
            </div>

            <button class="button is-primary px-6" onclick="submitShopSettings()">
                {{ t('Save Shop Changes') }}
            </button>
        </div>
    </div>
</section>

<!-- Errors Section -->
<section id="section-Errors" class="settings-section is-hidden">
    <div class="card box shadow-sm">
        <header class="card-header border-none shadow-none">
            <p class="card-header-title has-text-danger">
                <i class="bi bi-exclamation-octagon-fill mr-2"></i> Arquivos não Identificados
            </p>
            <div class="card-header-icon pt-4 pr-5">
                <button class="button is-small is-dark is-outlined" onclick="fillErrorsTable()">
                    <i class="bi bi-arrow-clockwise mr-1"></i> Atualizar
                </button>
            </div>
        </header>
        <div class="card-content pt-0">
            <p class="is-size-7 mb-4 opacity-70">Abaixo estão listados os arquivos que o MyFoil não
                conseguiu identificar automaticamente. Você pode verificar o motivo do erro ou
                excluir o arquivo se for lixo.</p>
            <div class="table-container">
                <div id="bulkActionsBar" class="notification is-ghost border py-2 px-3 mb-3 is-hidden"
                    style="border-left: 5px solid var(--color-primary) !important;">
                    <div class="is-flex is-justify-content-between is-align-items-center">
                        <span class="is-size-7 has-text-weight-bold" id="selectedCountText">0 itens
                            selecionados</span>
                        <div class="buttons">
                            <button class="button is-small is-danger is-light" onclick="bulkDeleteFiles()">
                                <i class="bi bi-trash3 mr-1"></i> Excluir Selecionados
                            </button>
                        </div>
                    </div>
                </div>
                <table class="table is-fullwidth is-hoverable" id="errorsTable">
                    <thead>
                        <tr>
                            <th width="40"><input type="checkbox" id="selectAllErrors" onclick="toggleAllErrors(this)">
                            </th>
                            <th>Arquivo</th>
                            <th>Erro</th>
                            <th class="has-text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- Tags Section -->
<section id="section-Tags" class="settings-section is-hidden">
    <div class="card box shadow-sm">
        <header class="card-header border-none shadow-none">
            <p class="card-header-title has-text-primary">
                <i class="bi bi-tags-fill mr-2"></i> Gerenciar Tags
            </p>
        </header>
        <div class="card-content pt-0">
            <div class="notification is-ghost border p-5 mb-5"
                style="border-left: 5px solid var(--color-primary) !important;">
                <div class="columns is-vcentered">
                    <div class="column is-4">
                        <input class="input" type="text" id="tagNameInput" placeholder="Nome da Tag">
                    </div>
                    <div class="column is-3">
                        <input class="input" type="color" id="tagColorInput" value="#3273dc"
                            style="height: 40px; padding: 2px;">
                    </div>
                    <div class="column is-3">
                        <div class="select is-fullwidth">
                            <select id="tagIconInput">
                                <option value="bi-tag">Etiqueta</option>
                                <option value="bi-star">Estrela</option>
                                <option value="bi-heart">Coração</option>
                                <option value="bi-fire">Fogo</option>
                                <option value="bi-controller">Controle</option>
                                <option value="bi-trophy">Troféu</option>
                            </select>
                        </div>
                    </div>
                    <div class="column is-2">
                        <button class="button is-primary is-fullwidth" onclick="createTag()">Criar</button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table class="table is-fullwidth" id="tagsTable">
                    <thead>
                        <tr>
                            <th>Tag</th>
                            <th>Visualização</th>
                            <th class="has-text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- Activity Section -->
<section id="section-Activity" class="settings-section is-hidden">
    <div class="card box shadow-sm">
        <header class="card-header border-none shadow-none">
            <p class="card-header-title has-text-primary">
                <i class="bi bi-clock-history mr-2"></i> Histórico de Atividade
            </p>
            <div class="card-header-icon pt-4 pr-5">
                <button class="button is-small is-ghost" onclick="fillActivityLogs()">
                    <i class="bi bi-arrow-clockwise mr-1"></i> Atualizar
                </button>
            </div>
        </header>
        <div class="card-content pt-0">
            <div id="activityLogsList" class="activity-timeline">
                <!-- Log items injected via JS -->
            </div>
        </div>
    </div>
</section>

<!-- Webhooks Section -->
<section id="section-Webhooks" class="settings-section is-hidden">
    <div class="card box shadow-sm">
        <header class="card-header border-none shadow-none">
            <p class="card-header-title has-text-primary">
                <i class="bi bi-hdd-network mr-2"></i> Webhooks de Integração
            </p>
        </header>
        <div class="card-content pt-0">
            <p class="is-size-7 opacity-60 mb-5">
                Notifique serviços externos (Discord, Slack, Home Assistant) sobre eventos na sua
                biblioteca.
            </p>

            <div id="webhooksList" class="mb-5">
                <!-- Webhooks will be listed here -->
            </div>

            <div class="notification is-ghost border p-5 border"
                style="border-left: 5px solid var(--color-primary) !important;">
                <p class="heading has-text-weight-bold mb-4">Adicionar Novo Webhook</p>
                <div class="columns is-multiline">
                    <div class="column is-12">
                        <div class="field">
                            <label class="label is-size-7">URL do Endpoint</label>
                            <input class="input is-small" type="url" id="webhookUrl"
                                placeholder="https://discord.com/api/webhooks/...">
                        </div>
                    </div>
                    <div class="column is-6">
                        <div class="field">
                            <label class="label is-size-7">Segredo (Opcional)</label>
                            <input class="input is-small" type="text" id="webhookSecret"
                                placeholder="Para assinatura HMAC-SHA256">
                        </div>
                    </div>
                    <div class="column is-6">
                        <div class="field">
                            <label class="label is-size-7">Eventos</label>
                            <div class="control">
                                <label class="checkbox is-size-7">
                                    <input type="checkbox" id="eventLibraryUpdated" checked>
                                    Alteração na Biblioteca
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="button is-primary is-small" onclick="addWebhook()">Adicionar
                    Webhook</button>
            </div>
        </div>
    </div>
</section>

<!-- Plugins Section -->
<!-- Help Section -->
<section id="section-Help" class="settings-section is-hidden">
    <div class="card box shadow-sm">
        <header class="card-header border-none shadow-none">
            <p class="card-header-title has-text-info">
                <i class="bi bi-question-circle mr-2"></i> Ajuda e Documentação
            </p>
        </header>
        <div class="card-content pt-0">

            <!-- Keyboard Shortcuts -->
            <div class="box is-shadowless border p-4 mb-4" style="border-left: 4px solid var(--color-info) !important;">
                <p class="heading has-text-weight-bold mb-3"><i class="bi bi-keyboard mr-2"></i>
                    Atalhos de Teclado</p>
                <div class="columns is-multiline">
                    <div class="column is-6">
                        <table class="table is-fullwidth is-size-7">
                            <thead>
                                <tr>
                                    <th>Atalho</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><kbd>Ctrl/Cmd + K</kbd></td>
                                    <td>Focar na busca</td>
                                </tr>
                                <tr>
                                    <td><kbd>ESC</kbd></td>
                                    <td>Fechar modais</td>
                                </tr>
                                <tr>
                                    <td><kbd>← / →</kbd></td>
                                    <td>Navegar paginação</td>
                                </tr>
                                <tr>
                                    <td><kbd>E</kbd> (no modal)</td>
                                    <td>Editar metadados</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="column is-6">
                        <table class="table is-fullwidth is-size-7">
                            <thead>
                                <tr>
                                    <th>Atalho</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><kbd>F</kbd> (no modal)</td>
                                    <td>Toggle Wishlist</td>
                                </tr>
                                <tr>
                                    <td><kbd>D</kbd> (no modal)</td>
                                    <td>Baixar arquivo</td>
                                </tr>
                                <tr>
                                    <td><kbd>Enter</kbd></td>
                                    <td>Abrir jogo selecionado</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Quick Start Guide -->
            <div class="box is-shadowless border p-4 mb-4"
                style="border-left: 4px solid var(--color-success) !important;">
                <p class="heading has-text-weight-bold mb-3"><i class="bi bi-book mr-2"></i> Guia
                    Rápido</p>
                <div class="content is-size-7">
                    <ol>
                        <li><strong>Configurar Biblioteca:</strong> Vá em "Biblioteca" e adicione o
                            caminho da pasta com
                            seus jogos NSP/NSZ/XCI.</li>
                        <li><strong>Atualizar TitleDB:</strong> Clique em "Atualizar Agora" na aba
                            TitleDB para baixar
                            informações dos jogos.</li>
                        <li><strong>Escanear:</strong> Após adicionar a pasta, clique em "Escanear
                            Biblioteca" para
                            identificar seus jogos.</li>
                        <li><strong>Configurar Loja:</strong> Na aba "Loja", defina o hostname e
                            ative a shop para o
                            Tinfoil.</li>
                        <li><strong>Conectar Tinfoil:</strong> No Switch, adicione
                            <code>protocol://HOST:5000</code> nas
                            File Browsers.
                        </li>
                    </ol>
                </div>
            </div>

            <!-- FAQ -->
            <div class="box is-shadowless border p-4 mb-4"
                style="border-left: 4px solid var(--color-warning) !important;">
                <p class="heading has-text-weight-bold mb-3"><i class="bi bi-patch-question mr-2"></i> Perguntas
                    Frequentes</p>
                <div class="content is-size-7">
                    <details class="mb-3">
                        <summary class="has-text-weight-bold mb-2" style="cursor: pointer;">Como
                            identificar jogos que
                            aparecem como "Unknown"?</summary>
                        <p>Vá em "Erros/Identificação", encontre o jogo e clique em "Reconhecer".
                            Busque o jogo correto
                            no TitleDB e clique em "Usar Metadados".</p>
                    </details>
                    <details class="mb-3">
                        <summary class="has-text-weight-bold mb-2" style="cursor: pointer;">Por que
                            alguns jogos não
                            aparecem na loja do Tinfoil?</summary>
                        <p>Verifique se: (1) O arquivo foi identificado corretamente, (2) Você tem
                            permissão
                            "shop_access" no seu usuário, (3) A loja está configurada como pública
                            ou você tem login
                            correto.</p>
                    </details>
                    <details class="mb-3">
                        <summary class="has-text-weight-bold mb-2" style="cursor: pointer;">Como
                            adicionar metadados
                            customizados?</summary>
                        <p>Clique no jogo, depois em "Editar Dados". Você pode buscar informações no
                            TitleDB ou
                            preencher manualmente.</p>
                    </details>
                    <details class="mb-3">
                        <summary class="has-text-weight-bold mb-2" style="cursor: pointer;">Qual a
                            diferença entre as
                            fontes do TitleDB?</summary>
                        <p>MyFoil suporta múltiplas fontes com fallback automático. Fontes com maior
                            prioridade são
                            tentadas primeiro. Recomendamos manter ao menos 2 fontes ativas.</p>
                    </details>
                </div>
            </div>

            <!-- Links -->
            <div class="box is-shadowless border p-4" style="border-left: 4px solid var(--color-primary) !important;">
                <p class="heading has-text-weight-bold mb-3"><i class="bi bi-link-45deg mr-2"></i>
                    Links Úteis</p>
                <div class="buttons">
                    <a href="https://github.com/fernandodimas/MyFoil" target="_blank" class="button is-small is-dark">
                        <i class="bi bi-github mr-2"></i> GitHub
                    </a>
                    <a href="https://github.com/fernandodimas/MyFoil/issues" target="_blank"
                        class="button is-small is-info">
                        <i class="bi bi-bug mr-2"></i> Reportar Bug
                    </a>
                    <a href="https://github.com/fernandodimas/MyFoil/wiki" target="_blank"
                        class="button is-small is-link">
                        <i class="bi bi-book mr-2"></i> Wiki Completa
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="section-Plugins" class="settings-section is-hidden">
    <div class="card box shadow-sm">
        <header class="card-header border-none shadow-none">
            <p class="card-header-title has-text-primary">
                <i class="bi bi-patch-check mr-2"></i> Plugins Instalados
            </p>
        </header>
        <div class="card-content pt-0">
            <p class="is-size-7 opacity-60 mb-5">
                Plugins permitem estender a funcionalidade do MyFoil com recursos personalizados.
            </p>
            <div id="pluginsList">
                <!-- Plugins injected by JS -->
            </div>
            <div class="notification is-ghost border is-size-7 mt-5"
                style="border-left: 5px solid var(--color-info) !important;">
                <i class="bi bi-info-circle mr-2"></i> Para instalar novos plugins, adicione-os na
                pasta <code>app/plugins/</code>.
            </div>
        </div>
    </div>
</section>

<!-- Cloud Section -->
<section id="section-Cloud" class="settings-section is-hidden">
    <div class="card box shadow-sm">
        <header class="card-header border-none shadow-none">
            <p class="card-header-title has-text-primary">
                <i class="bi bi-cloud-fill mr-2"></i> Integração Cloud
            </p>
        </header>
        <div class="card-content pt-0">
            <div class="columns">
                <div class="column is-6">
                    <div class="box border is-shadowless" id="cloud-gdrive"
                        style="border-left: 4px solid var(--color-primary) !important;">
                        <p class="has-text-weight-bold mb-3"><i class="bi bi-google mr-2"></i>
                            Google Drive</p>
                        <p class="is-size-7 opacity-60 mb-4">Sincronize sua biblioteca diretamente
                            com uma pasta do Google Drive.</p>
                        <div class="cloud-status mb-3 is-hidden">
                            <span class="tag is-success is-light"><i class="bi bi-check-circle mr-1"></i>
                                Conectado</span>
                        </div>
                        <button class="button is-small is-primary is-fullwidth btn-connect"
                            onclick="connectCloud('gdrive')">Conectar</button>
                        <p class="is-size-7 has-text-danger mt-2 is-hidden btn-config-needed">
                            Configuração necessária (secret.json não encontrado)</p>
                    </div>
                </div>
                <div class="column is-6">
                    <div class="box border is-shadowless" id="cloud-dropbox"
                        style="border-left: 4px solid var(--color-info) !important;">
                        <p class="has-text-weight-bold mb-3"><i class="bi bi-dropbox mr-2"></i>
                            Dropbox</p>
                        <p class="is-size-7 opacity-60 mb-4">Mantenha seu acervo seguro e acessível
                            via Dropbox.</p>
                        <div class="cloud-status mb-3 is-hidden">
                            <span class="tag is-success is-light"><i class="bi bi-check-circle mr-1"></i>
                                Conectado</span>
                        </div>
                        <button class="button is-small is-primary is-fullwidth btn-connect"
                            onclick="connectCloud('dropbox')">Conectar</button>
                        <p class="is-size-7 has-text-danger mt-2 is-hidden btn-config-needed">
                            Configuração necessária (app_key.txt não encontrado)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
</div>
</div>
</div>
</div>
</section>

<!-- Modals -->
<div class="modal" id="deleteUserModal">
    <div class="modal-background"></div>
    <div class="modal-card shadow-2xl">
        <header class="modal-card-head border-none">
            <p class="modal-card-title has-text-danger has-text-weight-black"><i class="bi bi-trash3-fill mr-2"></i> {{
                t('Delete User') }}</p>
            <button class="delete" aria-label="close" onclick="closeModal('deleteUserModal')"></button>
        </header>
        <section class="modal-card-body py-6 modal-text opacity-70">
            <!-- Text injected via JS -->
        </section>
        <footer class="modal-card-foot border-none is-justify-content-flex-end">
            <button class="button" onclick="closeModal('deleteUserModal')">{{ t('Keep User') }}</button>
            <button class="button is-danger btn-confirm">{{ t('Permanently Delete') }}</button>
        </footer>
    </div>
</div>

<div class="modal" id="deletePathModal">
    <div class="modal-background"></div>
    <div class="modal-card shadow-2xl">
        <header class="modal-card-head border-none">
            <p class="modal-card-title has-text-danger has-text-weight-black"><i class="bi bi-folder-x mr-2"></i> {{
                t('Remove Path') }}</p>
            <button class="delete" aria-label="close" onclick="closeModal('deletePathModal')"></button>
        </header>
        <section class="modal-card-body py-6 modal-text opacity-70">
            <!-- Text injected via JS -->
        </section>
        <footer class="modal-card-foot border-none is-justify-content-flex-end">
            <button class="button" onclick="closeModal('deletePathModal')">{{ t('Cancel') }}</button>
            <button class="button is-danger btn-confirm">{{ t('Remove Path') }}</button>
        </footer>
    </div>
</div>

<style>
    :root {
        --color-primary: #7c3aed;
        --color-success: #10b981;
        --color-danger: #ef4444;
        --color-warning: #f59e0b;
        --color-info: #3b82f6;
    }

    .has-text-primary {
        color: var(--color-primary) !important;
    }

    .has-text-success {
        color: var(--color-success) !important;
    }

    .has-text-danger {
        color: var(--color-danger) !important;
    }

    .has-text-warning {
        color: var(--color-warning) !important;
    }

    .has-text-info {
        color: var(--color-info) !important;
    }

    .menu-list a {
        transition: all 0.2s ease;
        border-radius: 8px;
        margin-bottom: 2px;
        color: var(--bulma-text);
        padding: 0.75rem 1rem;
    }

    .menu-list a:hover {
        background-color: rgba(124, 58, 237, 0.05);
        color: var(--color-primary);
        transform: translateX(5px);
    }

    .menu-list a.is-active {
        background: linear-gradient(90deg, rgba(124, 58, 237, 0.15) 0%, rgba(124, 58, 237, 0.05) 100%);
        color: var(--color-primary);
        font-weight: 700;
        border-left: 4px solid var(--color-primary);
        box-shadow: 0 4px 12px rgba(124, 58, 237, 0.1);
    }

    [data-theme="dark"] .menu-list a.is-active {
        background: linear-gradient(90deg, rgba(139, 92, 246, 0.2) 0%, rgba(139, 92, 246, 0.05) 100%);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .settings-container {
        animation: fadeIn 0.4s ease-out forwards;
        background-color: transparent !important;
        /* Remove fundo diferente */
        border-radius: 16px;
        border: none !important;
        /* Remove borda excessiva */
        box-shadow: none !important;
        /* Remove sombra excessiva */
    }

    .card.box {
        background-color: var(--bulma-card-background) !important;
        border: 1px solid var(--bulma-border) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03) !important;
    }

    [data-theme="dark"] .card.box {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
    }

    .is-clickable {
        cursor: pointer;
        transition: background-color 0.15s ease;
    }

    .is-clickable:hover {
        background-color: rgba(124, 58, 237, 0.05) !important;
    }

    .breadcrumb li a {
        color: var(--color-primary);
        font-weight: 500;
    }

    .breadcrumb li.is-active a {
        color: var(--bulma-text);
        cursor: default;
    }

    .animate-fade-in {
        animation: fadeIn 0.3s ease-out forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(15px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .is-sticky {
        position: sticky;
        top: 20px;
    }

    .mr-1 {
        margin-right: 0.25rem;
    }

    .mr-2 {
        margin-right: 0.5rem;
    }

    .mr-4 {
        margin-right: 1rem;
    }

    .mr-6 {
        margin-right: 1.5rem;
    }

    .ml-1 {
        margin-left: 0.25rem;
    }

    .my-6 {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .p-5 {
        padding: 1.25rem !important;
    }

    .p-0 {
        padding: 0 !important;
    }

    .gap-2 {
        gap: 0.5rem;
    }

    .gap-3 {
        gap: 0.75rem;
    }

    .shadow-none {
        box-shadow: none !important;
    }

    .is-loading.is-ghost::after {
        border-color: transparent transparent var(--bulma-primary) var(--bulma-primary) !important;
    }

    /* Activity Timeline Styles */
    .activity-timeline {
        padding-top: 10px;
        position: relative;
    }

    .activity-item {
        position: relative;
        padding-left: 3rem;
        padding-bottom: 2rem;
        border-left: 2px solid rgba(124, 58, 237, 0.2);
        margin-left: 1rem;
    }

    [data-theme="dark"] .activity-item {
        border-left: 2px solid rgba(139, 92, 246, 0.3);
    }

    .activity-item:last-child {
        border-left: 2px solid transparent;
    }

    .activity-dot {
        position: absolute;
        left: -11px;
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--bulma-card-background);
        border: 4px solid var(--bulma-primary);
        z-index: 2;
    }

    .activity-content {
        background: var(--bulma-background-scheme);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid var(--bulma-border);
    }

    .activity-meta {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--bulma-text);
        margin-bottom: 0.25rem;
        opacity: 0.6;
        display: block;
    }
</style>

<script>
    {% raw %}
    let allUsernames = [];

    // Helper functions
    const getInputVal = (id) => $(`#${id}`).val();
    const getCheckboxStatus = (id) => $(`#${id}`).is(":checked");
    // openModal and closeModal are defined in modals_shared.html (included globally)

    function createTag() {
        const name = $('#tagNameInput').val();
        const color = $('#tagColorInput').val();
        const icon = $('#tagIconInput').val();
        if (!name) return showToast('Nome da tag é obrigatório', 'error');

        $.ajax({
            url: '/api/tags',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name, color, icon }),
            success: (res) => {
                showToast('Tag criada com sucesso');
                $('#tagNameInput').val('');
                fillTagsTable();
            },
            error: (err) => showToast('Erro ao criar tag: ' + (err.responseJSON?.error || 'Erro desconhecido'), 'error')
        });
    }

    function fillTagsTable() {
        $.getJSON('/api/tags', (tags) => {
            const tbody = $('#tagsTable tbody').empty();
            tags.forEach(t => {
                tbody.append(`
                    <tr>
                        <td><strong>${t.name}</strong></td>
                        <td>
                            <span class="tag" style="background-color: ${t.color}; color: #fff;">
                                <i class="${t.icon.startsWith('bi-') ? 'bi ' + t.icon : 'fas ' + t.icon} mr-1"></i> ${t.name}
                            </span>
                        </td>
                        <td class="has-text-right">
                            <button class="button is-small is-ghost has-text-danger" onclick="deleteTag(${t.id})">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
        });
    }

    function deleteTag(id) {
        confirmAction({
            title: 'Excluir Tag',
            message: 'Deseja realmente excluir esta tag? Esta ação removerá a tag de todos os jogos associados.',
            confirmText: 'Excluir',
            confirmClass: 'is-danger',
            onConfirm: () => {
                $.ajax({
                    url: `/api/tags/${id}`,
                    type: 'DELETE',
                    success: () => {
                        showToast('Tag excluída');
                        fillTagsTable();
                    }
                });
            }
        });
    }

    function fillActivityLogs() {
        $.getJSON('/api/activity', (logs) => {
            const list = $('#activityLogsList').empty();
            if (!logs.length) {
                list.append('<p class="has-text-centered py-6 opacity-40 italic">Nenhuma atividade registrada.</p>');
                return;
            }
            logs.forEach(log => {
                const date = new Date(log.timestamp).toLocaleString();
                let iconClass = 'bi-info-circle';
                let color = '#7c3aed';

                if (log.action.includes('error') || log.action.includes('failed')) {
                    iconClass = 'bi-exclamation-circle-fill';
                    color = '#ef4444';
                } else if (log.action.includes('file_added')) {
                    iconClass = 'bi-file-earmark-plus';
                    color = '#10b981';
                } else if (log.action.includes('scan')) {
                    iconClass = 'bi-search';
                } else if (log.action.includes('backup')) {
                    iconClass = 'bi-safe';
                }

                list.append(`
                    <div class="activity-item">
                        <div class="activity-dot" style="border-color: ${color}"></div>
                        <div class="activity-content">
                            <span class="activity-meta">${date}</span>
                            <p class="has-text-weight-bold mb-1">
                                <i class="bi ${iconClass} mr-2" style="color: ${color}"></i>
                                ${log.action.toUpperCase().replace(/_/g, ' ')}
                            </p>
                            <div class="is-size-7 opacity-70">
                                ${log.title_id ? `<span class="tag is-info is-light is-small mr-2">${log.title_id}</span>` : ''}
                                ${JSON.stringify(log.details).replace(/[{}"]/g, '').replace(/:/g, ': ').replace(/,/g, ' | ')}
                            </div>
                        </div>
                    </div>
                `);
            });
        });
    }

    // Tab Navigation Logic
    $('#settingsNav a').on('click', function () {
        const target = $(this).data('target');
        $('#settingsNav a').removeClass('is-active');
        $(this).addClass('is-active');
        $('.settings-section').addClass('is-hidden');
        $(`#section-${target}`).removeClass('is-hidden');
        sessionStorage.setItem('lastSettingsTab', target);

        // Initial load for specific tabs
        if (target === 'Tags') fillTagsTable();
        if (target === 'Activity') fillActivityLogs();
        if (target === 'Library') {
            fillLibraryTable();
        }
    });

    // File Input Helper
    $('#consoleKeysInput').on('change', function () {
        const file = this.files[0];
        $('#fileNameDisplay').text(file ? file.name : '{{ t("No file chosen") }}');
    });

    // Toggle Add Source Form
    $('#toggleAddSource').on('click', function () {
        $('#addSourceForm').toggleClass('is-hidden');
    });

    // Populate Functions
    function fillLibraryTable() {
        $.getJSON("/api/settings/library/paths", (result) => {
            const tbody = $('#pathsTable tbody').empty();
            if (!result.paths?.length) {
                tbody.append('<tr><td colspan="2" class="has-text-centered py-6 opacity-40 italic">{{ t("No paths configured") }}</td></tr>');
            } else {
                result.paths.forEach(p => {
                    tbody.append(`
                        <tr>
                            <td>
                                <p class="font-mono is-size-7 mb-0">${p.path}</p>
                            </td>
                            <td class="has-text-centered"><span class="tag is-light">${p.titles_count}</span></td>
                            <td class="has-text-centered"><span class="tag is-light">${p.files_count}</span></td>
                            <td class="has-text-centered"><span class="tag is-primary is-light font-mono">${p.total_size_formatted}</span></td>
                            <td class="has-text-centered"><span class="is-size-7 opacity-50">${p.last_scan}</span></td>
                            <td class="has-text-right">
                                <div class="buttons is-right">
                                    <button class="button is-small is-ghost has-text-info" onclick="scanLibrary('${p.path}')" title="Escanear esta pasta"><i class="bi bi-arrow-clockwise"></i></button>
                                    <button class="button is-small is-ghost has-text-danger" onclick="showDeletePathModal('${p.path}')" title="Remover caminho"><i class="bi bi-trash3"></i></button>
                                </div>
                            </td>
                        </tr>
                    `);
                });
            }
        });
    }


    function fillUserTable() {
        $.getJSON("/api/users", (result) => {
            const tbody = $('#userTable tbody').empty();
            allUsernames = result.map(u => u.user);
            if (!result.length) {
                tbody.append('<tr><td colspan="3" class="has-text-centered py-6 opacity-40 italic">{{ t("No users found") }}</td></tr>');
            } else {
                result.forEach(user => {
                    const self = user.user === '{{ current_user.user if current_user.is_authenticated else "" }}';
                    tbody.append(`
                        <tr>
                            <td class="has-text-weight-bold">
                                <i class="bi bi-person-circle mr-2 opacity-50"></i> ${user.user} ${self ? '<span class="tag is-info is-light is-small ml-2">You</span>' : ''}
                            </td>
                            <td>
                                <div class="tags">
                                    <span class="tag ${user.shop_access ? 'is-success' : 'is-light'} is-small">${t('Shop')}</span>
                                    <span class="tag ${user.backup_access ? 'is-success' : 'is-light'} is-small">${t('Backup')}</span>
                                    <span class="tag ${user.admin_access ? 'is-primary' : 'is-light'} is-small">${t('Admin')}</span>
                                </div>
                            </td>
                            <td class="has-text-right">
                                ${!self ? `
                                    <button class="button is-small is-ghost has-text-danger" onclick="showDeleteUserModal(${user.id}, '${user.user}')">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `);
                });
            }
        });
    }

    function fillTitleDBSourcesTable() {
        $.getJSON("/api/settings/titledb/sources", (result) => {
            if (!result.success) return;
            const tbody = $('#titledbSourcesTable tbody').empty();
            // Initialize Sortable only if not exists
            if (!tbody.data('sortable-init')) {
                new Sortable(document.getElementById('titledbSourcesTable').querySelector('tbody'), {
                    handle: '.drag-handle',
                    animation: 150,
                    onEnd: function (evt) {
                        const rows = Array.from(tbody.find('tr'));
                        const priorities = {};
                        rows.forEach((row, index) => {
                            const name = $(row).find('p.has-text-weight-bold').text();
                            priorities[name] = index * 10;
                            $(row).find('input[type="number"]').val(index * 10);
                        });

                        $.ajax({
                            url: '/api/settings/titledb/sources/reorder',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(priorities),
                            success: function (res) {
                                if (res.success) showToast(t('Priorities updated'));
                                else showToast(t('Failed to update priorities'), 'error');
                            }
                        });
                    }
                });
                tbody.data('sortable-init', true);
            }

            result.sources.forEach(source => {
                let remoteDateHtml = '';
                if (source.is_fetching) {
                    remoteDateHtml = `<span class="is-size-7 italic opacity-50"><i class="bi bi-arrow-repeat spin mr-1"></i> Carregando...</span>`;
                } else if (source.remote_date) {
                    remoteDateHtml = `<span class="is-size-7">${new Date(source.remote_date).toLocaleString()}</span>`;
                } else {
                    const errorMsg = source.last_error ? `Erro: ${source.last_error}` : 'Nenhuma data encontrada para os arquivos esperados.';
                    remoteDateHtml = `<span class="is-size-7 has-text-danger italic opacity-50" title="${errorMsg}" style="cursor: help;">Não encontrado <i class="bi bi-question-circle"></i></span>`;
                }

                const localDate = source.last_success ? new Date(source.last_success).toLocaleString() : 'Never';

                tbody.append(`
                    <tr>
                        <td>
                            <div class="is-flex is-align-items-center">
                                <i class="bi ${source.source_type === 'json' ? 'bi-filetype-json' : 'bi-file-zip'} mr-2 opacity-40"></i>
                                <div>
                                    <p class="has-text-weight-bold has-text-primary is-size-6 m-0">${source.name}</p>
                                    <p class="is-family-monospace is-size-7 opacity-40" style="word-break: break-all;">${source.base_url}</p>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="is-flex is-align-items-center">
                                <i class="bi bi-cloud-check mr-2 has-text-info"></i>
                                ${remoteDateHtml}
                            </div>
                        </td>
                        <td>
                            <div class="is-flex is-align-items-center">
                                <i class="bi bi-download mr-2 opacity-50"></i>
                                <span class="is-size-7">${localDate}</span>
                            </div>
                        </td>
                        <td><input type="number" class="input is-small w-16" value="${source.priority}" style="width: 70px" onchange="updateSourcePriority('${source.name}', this.value)" /></td>
                        <td>
                            <span class="tag ${source.enabled ? 'is-success' : 'is-light'} is-small">
                                ${source.enabled ? t('Enabled') : t('Disabled')}
                            </span>
                        </td>
                        <td class="has-text-right">
                            <div class="buttons is-right">
                                <button class="button is-small is-ghost has-text-${source.enabled ? 'warning' : 'success'}" onclick="toggleSource('${source.name}', ${!source.enabled})">
                                    <i class="bi bi-${source.enabled ? 'pause-fill' : 'play-fill'}"></i>
                                </button>
                                <button class="button is-small is-ghost has-text-danger" onclick="deleteSource('${source.name}')">
                                    <i class="bi bi-trash3"></i>
                                </button>
                                <button class="button is-small is-ghost drag-handle" style="cursor: move">
                                    <i class="bi bi-grip-vertical"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `);
            });
        });
    }

    function fillErrorsTable() {
        $('#bulkActionsBar').addClass('is-hidden');
        $('#selectAllErrors').prop('checked', false);

        $.getJSON("/api/files/unidentified", (result) => {
            const tbody = $('#errorsTable tbody').empty();
            if (!result || !result.length) {
                tbody.append('<tr><td colspan="4" class="has-text-centered py-6 opacity-40 italic">Nenhum erro de identificação encontrado.</td></tr>');
            } else {
                result.forEach(file => {
                    // Check if it's a recognition error (contains TitleID in parenthesis)
                    const isRecognitionError = file.error && file.error.includes('Banco de Dados');
                    const tidMatch = isRecognitionError ? file.error.match(/\((0100[0-9A-F]+)\)/) : null;
                    const tid = tidMatch ? tidMatch[1] : null;

                    tbody.append(`
                        <tr>
                            <td><input type="checkbox" class="error-checkbox" data-id="${file.id}" onclick="updateBulkBar()"></td>
                            <td>
                                <p class="has-text-weight-bold is-size-7 break-word">${file.filename}</p>
                                <p class="is-family-monospace is-size-7 opacity-40 break-word">${file.filepath}</p>
                            </td>
                            <td>
                                <span class="is-size-7 ${isRecognitionError ? 'has-text-warning' : 'has-text-danger'}">
                                    <i class="bi ${isRecognitionError ? 'bi-question-circle' : 'bi-exclamation-triangle'} mr-1"></i>
                                    ${file.error || 'Erro desconhecido'}
                                </span>
                            </td>
                            <td class="has-text-right">
                                <div class="buttons is-right">
                                    ${tid ? `
                                        <button class="button is-small is-info is-light" onclick="openEditModalFromError('${tid}')" title="Identificar Manualmente">
                                            <i class="bi bi-pencil-square mr-1"></i> Reconhecer
                                        </button>
                                    ` : ''}
                                    <button class="button is-small is-ghost has-text-danger" onclick="deleteErrorFile(${file.id})" title="Excluir Arquivo">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `);
                });
            }
        });
    }

    function openEditModalFromError(titleId) {
        if (!titleId) return;
        $('#editMetaId').val(titleId);
        $('#editMetaName').val('Unknown (' + titleId + ')');
        $('#editMetaPublisher, #editMetaDescription, #editMetaIcon, #editMetaBanner, #editMetaGenre, #editMetaRelease').val('');
        $('#titleDBSearchResults').empty();
        $('#searchTitleDBInput').val('');

        // Try to fetch current data if exists
        $.get(`/api/games/${titleId}/custom`, function (d) {
            if (d && !d.error) {
                if (d.name) $('#editMetaName').val(d.name);
                if (d.publisher) $('#editMetaPublisher').val(d.publisher);
                if (d.description) $('#editMetaDescription').val(d.description);
                if (d.iconUrl) $('#editMetaIcon').val(d.iconUrl);
                if (d.bannerUrl) $('#editMetaBanner').val(d.bannerUrl);
                if (d.genre || d.category) $('#editMetaGenre').val(d.genre || d.category);
                if (d.release_date || d.releaseDate) $('#editMetaRelease').val(d.release_date || d.releaseDate);
            }
        });

        openModal('editMetadataModal');
    }


    function deleteErrorFile(id) {
        confirmAction({
            title: 'Excluir Arquivo',
            message: 'Deseja realmente excluir este arquivo do DISCO? Esta ação não pode ser desfeita.',
            confirmText: 'Excluir',
            confirmClass: 'is-danger',
            onConfirm: () => {
                $.post(`/api/files/delete/${id}`, (res) => {
                    if (res.success) {
                        showToast('Arquivo excluído');
                        fillErrorsTable();
                    } else {
                        showToast('Erro ao excluir: ' + res.error, 'error');
                    }
                });
            }
        });
    }

    // Bulk Actions for Error Files
    function toggleAllErrors(checkbox) {
        $('.error-checkbox').prop('checked', checkbox.checked);
        updateBulkBar();
    }

    function updateBulkBar() {
        const selected = $('.error-checkbox:checked').length;
        $('#selectedCountText').text(`${selected} ${selected === 1 ? 'item selecionado' : 'itens selecionados'}`);

        if (selected > 0) {
            $('#bulkActionsBar').removeClass('is-hidden');
        } else {
            $('#bulkActionsBar').addClass('is-hidden');
        }
    }

    function bulkDeleteFiles() {
        const selectedIds = $('.error-checkbox:checked').map(function () {
            return $(this).data('id');
        }).get();

        if (selectedIds.length === 0) {
            showToast('Nenhum arquivo selecionado', 'error');
            return;
        }

        confirmAction({
            title: 'Excluir Arquivos',
            message: `Deseja realmente excluir ${selectedIds.length} arquivo(s) do DISCO? Esta ação não pode ser desfeita.`,
            confirmText: 'Excluir',
            confirmClass: 'is-danger',
            onConfirm: () => {
                let deleted = 0;
                let errors = 0;

                selectedIds.forEach((id, index) => {
                    $.post(`/api/files/delete/${id}`, (res) => {
                        if (res.success) {
                            deleted++;
                        } else {
                            errors++;
                        }

                        // Check if all requests completed
                        if (index === selectedIds.length - 1) {
                            setTimeout(() => {
                                if (deleted > 0) {
                                    showToast(`${deleted} arquivo(s) excluído(s) com sucesso`);
                                }
                                if (errors > 0) {
                                    showToast(`${errors} erro(s) ao excluir`, 'error');
                                }
                                fillErrorsTable();
                            }, 500);
                        }
                    }).fail(() => {
                        errors++;
                        if (index === selectedIds.length - 1) {
                            setTimeout(() => {
                                showToast(`${errors} erro(s) ao excluir`, 'error');
                                fillErrorsTable();
                            }, 500);
                        }
                    });
                });
            }
        });
    }

    // Modal Triggers
    function showDeleteUserModal(id, user) {
        $('#deleteUserModal .modal-text').text(`{{ t('Are you sure you want to delete user') }} "${user}"? {{ t('This action cannot be undone.') }}`);
        $('#deleteUserModal .btn-confirm').off('click').on('click', () => deleteUser(id));
        openModal('deleteUserModal');
    }

    function showDeletePathModal(path) {
        $('#deletePathModal .modal-text').text(`{{ t('Remove path') }} "${path}"? {{ t('This will not delete your files.') }}`);
        $('#deletePathModal .btn-confirm').off('click').on('click', () => deleteLibraryPath(path));
        openModal('deletePathModal');
    }

    // API Calls
    function deleteUser(id) {
        $.ajax({ url: "/api/user", type: 'DELETE', data: JSON.stringify({ user_id: id }), contentType: "application/json", success: () => { fillUserTable(); closeModal('deleteUserModal'); showToast('User deleted'); } });
    }

    function deleteLibraryPath(path) {
        $.ajax({ url: "/api/settings/library/paths", type: 'DELETE', data: JSON.stringify({ path }), contentType: "application/json", success: () => { fillLibraryTable(); closeModal('deletePathModal'); showToast('Path removed'); } });
    }

    function submitNewUser() {
        const user = getInputVal("inputNewUser");
        const password = getInputVal("inputNewUserPassword");
        if (!user || !password) return showToast('Fill all fields', 'error');

        $.ajax({
            url: "/api/user", type: 'POST',
            data: JSON.stringify({
                user, password,
                shop_access: getCheckboxStatus("checkboxNewUserShopAccess"),
                backup_access: getCheckboxStatus("checkboxNewUserBackupAccess"),
                admin_access: getCheckboxStatus("checkboxNewUserAdminAccess")
            }),
            contentType: "application/json",
            success: (r) => {
                if (r.success) {
                    fillUserTable();
                    $('#inputNewUser, #inputNewUserPassword').val('');
                    showToast('User created successfully');
                } else {
                    showToast(r.errors?.[0]?.error || 'Failed to create user', 'error');
                }
            }
        });
    }

    function submitNewLibraryPath() {
        const path = getInputVal("libraryPathInput");
        if (!path) return showToast('Path is required', 'warning');
        $.ajax({
            url: "/api/settings/library/paths",
            type: 'POST',
            data: JSON.stringify({ path }),
            contentType: "application/json",
            success: (r) => {
                if (r.success) {
                    fillLibraryTable();
                    $('#libraryPathInput').val('');
                    showToast('Path added');
                } else {
                    showToast(r.errors?.[0]?.error || 'Failed to add path', 'error');
                }
            }
        });
    }

    function scanLibrary(path = null) {
        $('.scanBtn').addClass('is-loading');
        showToast('Scan started...');
        $.ajax({
            url: '/api/library/scan',
            type: 'POST',
            data: JSON.stringify({ path }),
            contentType: "application/json",
            success: (result) => {
                $('.scanBtn').removeClass('is-loading');
                if (result.success) showToast('Scan triggered!');
            }
        });
    }

    // Cleanup orphaned files and apps
    function loadCleanupStats() {
        $.getJSON('/api/cleanup/stats', (data) => {
            if (data.success && data.has_orphaned) {
                $('#cleanupStats').removeClass('is-hidden');
                $('#cleanupMissingFiles').text(data.missing_files);
                $('#cleanupMissingApps').text(data.missing_apps);
            } else {
                $('#cleanupStats').addClass('is-hidden');
            }
        }).fail(() => {
            $('#cleanupStats').addClass('is-hidden');
        });
    }

    function cleanupOrphaned() {
        confirmAction({
            title: 'Limpar Registros Órfãos',
            message: 'Isso removerá do banco de dados todos os registros de arquivos que não existem mais no disco e todos os apps marcados como owned sem arquivos associados. Esta ação não pode ser desfeita.',
            confirmText: 'Limpar',
            confirmClass: 'is-warning',
            onConfirm: () => {
                const btn = $('#btnCleanupOrphaned');
                btn.addClass('is-loading');
                btn.find('span:last').text('Limpando...');

                $.post('/api/cleanup/orphaned', (res) => {
                    btn.removeClass('is-loading');
                    btn.find('span:last').text('Limpar Órfãos');

                    if (res.success) {
                        showToast(res.message, 'success');
                        loadCleanupStats();
                        // Refresh game details modal if open
                        if (typeof showGameDetails === 'function' && currentGameId) {
                            showGameDetails(currentGameId);
                        }
                    } else {
                        showToast('Erro: ' + (res.error || 'Desconhecido'), 'error');
                    }
                }).fail((xhr) => {
                    btn.removeClass('is-loading');
                    btn.find('span:last').text('Limpar Órfãos');
                    showToast('Erro de comunicação: ' + (xhr.responseJSON?.error || 'Desconhecido'), 'error');
                });
            }
        });
    }

    function refreshTitleDBDates() {
        $.post('/api/settings/titledb/sources/refresh-dates', () => {
            showToast('Buscando datas remotas em segundo plano...');
            // Polling for updates for a few seconds
            let checks = 0;
            const interval = setInterval(() => {
                fillTitleDBSourcesTable();
                checks++;
                if (checks > 10) clearInterval(interval);
            }, 2000);
        });
    }

    function toggleSource(name, enabled) {
        $.ajax({ url: "/api/settings/titledb/sources", type: 'PUT', data: JSON.stringify({ name, enabled }), contentType: "application/json", success: fillTitleDBSourcesTable });
    }

    function updateSourcePriority(name, priority) {
        $.ajax({ url: "/api/settings/titledb/sources", type: 'PUT', data: JSON.stringify({ name, priority: parseInt(priority) }), contentType: "application/json", success: fillTitleDBSourcesTable });
    }

    function deleteSource(name) {
        confirmAction({
            title: 'Excluir Fonte',
            message: `Deseja realmente excluir a fonte "${name}"?`,
            confirmText: 'Excluir',
            confirmClass: 'is-danger',
            onConfirm: () => {
                $.ajax({
                    url: "/api/settings/titledb/sources",
                    type: 'DELETE',
                    data: JSON.stringify({ name }),
                    contentType: "application/json",
                    success: () => {
                        showToast('Fonte excluída');
                        fillTitleDBSourcesTable();
                    }
                });
            }
        });
    }

    function submitNewSource() {
        const name = getInputVal('inputSourceName');
        const url = getInputVal('inputSourceUrl');
        if (!name || !url) return showToast('Name and URL required', 'error');

        const data = {
            name,
            base_url: url,
            priority: parseInt(getInputVal('inputSourcePriority')),
            source_type: $('#inputSourceType').val(),
            enabled: true
        };
        $.ajax({
            url: "/api/settings/titledb/sources",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: () => {
                fillTitleDBSourcesTable();
                $('#inputSourceName, #inputSourceUrl').val('');
                $('#addSourceForm').addClass('is-hidden');
                showToast('Source added');
            }
        });
    }

    function forceTitleDBUpdate() {
        const btn = $('.updateTitleDBBtn');
        btn.addClass('is-loading');
        $.post("/api/settings/titledb/update", (r) => {
            if (r.success) showToast('Update started in background!');
            else showToast('Update failed!', 'error');
            setTimeout(() => {
                btn.removeClass('is-loading');
                fillTitleDBSourcesTable();
            }, 2000);
        });
    }

    function saveTitleDBSettings() {
        const data = {
            auto_use_latest: $('#autoUseLatest').is(':checked')
        };

        $.ajax({
            url: "/api/settings/titles",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: (r) => {
                if (!r.success) showToast(r.errors?.[0]?.error, 'error');
                else showToast(t('Settings saved'));
            }
        });
    }

    function submitTitlesSettings() {
        const data = {
            region: $('#selectRegion').val(),
            language: $('#selectLanguage').val(),
            auto_use_latest: $('#autoUseLatest').is(':checked')
        };

        $.ajax({
            url: "/api/settings/titles",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: (r) => {
                if (!r.success) showToast(r.errors?.[0]?.error, 'error');
                else showToast(t('Settings saved'));
            }
        });

        // Handle Keys Upload
        const keysFile = $('#consoleKeysInput')[0].files[0];
        if (keysFile) {
            const formData = new FormData();
            formData.append('file', keysFile);
            showToast('Uploading keys...');
            $.ajax({
                url: "/api/settings/keys",
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: (r) => {
                    if (r.success) {
                        showToast('Keys updated! Reloading...');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showToast('Invalid keys file!', 'error');
                    }
                }
            });
        }
    }


    function submitShopSettings() {
        const data = {
            host: getInputVal('shopHostInput'),
            public: getCheckboxStatus('publicShopCheck'),
            public_profile: getCheckboxStatus('publicProfileCheck'),
            encrypt: getCheckboxStatus('encryptShopCheck'),
            motd: getInputVal('motdTextArea')
        };
        $.ajax({
            url: "/api/settings/shop",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: () => showToast(t('Shop settings saved'))
        });
    }

    function changeLanguage(lang) {
        document.cookie = "language=" + lang + ";path=/;max-age=31536000";
        window.location.reload();
    }

    function connectCloud(provider) {
        $.getJSON(`/api/cloud/auth/${provider}`, (data) => {
            if (data.auth_url) {
                window.open(data.auth_url, '_blank');
            }
        }).fail((err) => {
            showToast(err.responseJSON?.error || 'Erro ao iniciar autenticação', 'error');
        });
    }

    function fillCloudStatus() {
        $.getJSON('/api/cloud/status', (status) => {
            ['gdrive', 'dropbox'].forEach(p => {
                const box = $(`#cloud-${p}`);
                const s = status[p];
                if (s) {
                    box.find('.btn-connect').prop('disabled', false).text(s.authenticated ? 'Reconectar' : 'Conectar');
                    if (s.authenticated) box.find('.cloud-status').removeClass('is-hidden');
                    box.find('.btn-config-needed').addClass('is-hidden');
                } else {
                    box.find('.btn-connect').addClass('is-hidden');
                    box.find('.btn-config-needed').removeClass('is-hidden');
                }
            });
        });
    }

    function fillPluginsList() {
        $.getJSON('/api/plugins', (plugins) => {
            const container = $('#pluginsList').empty();
            if (plugins.length === 0) {
                container.append('<p class="is-size-7 opacity-50 has-text-centered py-4">Nenhum plugin encontrado.</p>');
                return;
            }
            plugins.forEach(p => {
                const isEnabled = p.enabled !== false;
                container.append(`
                    <div class="box is-shadowless border p-4 mb-3" style="border: 1px solid rgba(0,0,0,0.05);">
                        <div class="columns is-vcentered">
                            <div class="column">
                                <p class="is-size-6 has-text-weight-bold ${isEnabled ? 'has-text-primary' : 'opacity-40'} mb-1">
                                    ${p.name} 
                                    <span class="tag is-light is-rounded ml-2">v${p.version}</span>
                                </p>
                                <p class="is-size-7 opacity-70">${p.description}</p>
                            </div>
                            <div class="column is-narrow">
                                <div class="field">
                                    <input id="plugin_${p.id}" type="checkbox" name="plugin_${p.id}" class="switch is-rounded is-primary is-small" ${isEnabled ? 'checked' : ''} onchange="togglePlugin('${p.id}', this.checked)">
                                    <label for="plugin_${p.id}" class="is-size-7 has-text-weight-semibold">${isEnabled ? 'Ativo' : 'Desativado'}</label>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            });
        });
    }

    function togglePlugin(pluginId, enabled) {
        $.ajax({
            url: '/api/plugins/toggle',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ id: pluginId, enabled: enabled }),
            success: (res) => {
                if (res.success) {
                    showToast(`Plugin ${enabled ? 'ativado' : 'desativado'} com sucesso!`);
                    fillPluginsList();
                } else {
                    showToast('Erro ao alterar status: ' + res.error, 'error');
                }
            },
            error: () => {
                showToast('Erro de comunicação com o servidor.', 'error');
            }
        });
    }


    // File Explorer Functions
    let allFiles = [];
    let explorerLibraries = [];
    let currentExplorerPath = ''; // '' means root (list libraries)

    function setExplorerPath(path) {
        currentExplorerPath = path;
        renderFilesExplorer();
        updateExplorerBreadcrumb();
    }

    function updateExplorerBreadcrumb() {
        const breadcrumb = $('#fileExplorerBreadcrumb').empty();

        // Root Item
        const rootLi = $('<li class="' + (currentExplorerPath === '' ? 'is-active' : '') + '"></li>');
        rootLi.append($('<a href="javascript:void(0)" onclick="setExplorerPath(\'\')"><i class="bi bi-hdd-fill mr-1"></i> Root</a>'));
        breadcrumb.append(rootLi);

        if (currentExplorerPath) {
            const parts = currentExplorerPath.split('/').filter(p => p !== '');
            let accumulatedPath = '';

            parts.forEach((part, index) => {
                accumulatedPath += '/' + part;
                const isLast = index === parts.length - 1;
                const li = $('<li class="' + (isLast ? 'is-active' : '') + '"></li>');
                li.append($('<a href="javascript:void(0)" onclick="setExplorerPath(\'' + accumulatedPath + '\')">' + part + '</a>'));
                breadcrumb.append(li);
            });
        }
    }

    function fillFilesExplorer() {
        // Load libraries first if not loaded
        $.getJSON('/api/settings/library/paths', (result) => {
            explorerLibraries = result.paths || [];

            // Then load files
            $.getJSON('/api/files/all', (files) => {
                allFiles = files;
                renderFilesExplorer();
                updateExplorerBreadcrumb();
            }).fail((xhr, status, error) => {
                console.error('Error loading files:', error);
                $('#filesExplorerTable tbody').html('<tr><td colspan="6" class="has-text-centered py-4 has-text-danger">Erro ao carregar arquivos.</td></tr>');
            });
        });
    }

    function renderFilesExplorer() {
        const tbody = $('#filesExplorerTable tbody').empty();
        const searchTerm = $('#fileSearchInput').val().toLowerCase();
        const typeFilter = $('#fileTypeFilter').val();
        const statusFilter = $('#fileStatusFilter').val();

        // If searching, show flat list
        if (searchTerm) {
            $('.breadcrumb').addClass('is-hidden');
            const filtered = allFiles.filter(f => {
                if (!f.filename.toLowerCase().includes(searchTerm) && !f.filepath.toLowerCase().includes(searchTerm)) return false;
                if (typeFilter && f.extension !== typeFilter) return false;
                if (statusFilter === 'identified' && !f.identified) return false;
                if (statusFilter === 'error' && (f.identified || !f.identification_error)) return false;
                return true;
            });

            if (filtered.length === 0) {
                tbody.append('<tr><td colspan="6" class="has-text-centered py-4 opacity-50">Nenhum arquivo encontrado para a busca.</td></tr>');
            } else {
                renderFileList(tbody, filtered, true);
            }
            $('#filesExplorerCount').text(`${filtered.length} arquivos encontrados`);
            return;
        }

        $('.breadcrumb').removeClass('is-hidden');

        // Hierarchical logic
        if (currentExplorerPath === '') {
            // Show libraries as folders
            explorerLibraries.forEach(lib => {
                tbody.append(`
                    <tr class="is-clickable" onclick="setExplorerPath('${lib.path}')">
                        <td colspan="6">
                            <i class="bi bi-folder-fill has-text-warning mr-2"></i>
                            <span class="has-text-weight-bold">${lib.path}</span>
                            <span class="tag is-light ml-2">${lib.files_count} arquivos</span>
                        </td>
                    </tr>
                `);
            });
            $('#filesExplorerCount').text(`${explorerLibraries.length} bibliotecas configuradas`);
        } else {
            const items = [];
            const folders = new Set();

            allFiles.forEach(f => {
                if (f.filepath.startsWith(currentExplorerPath)) {
                    let relative = f.filepath.substring(currentExplorerPath.length);
                    if (relative.startsWith('/')) relative = relative.substring(1);

                    if (!relative) return;

                    const parts = relative.split('/');
                    if (parts.length > 1) {
                        folders.add(parts[0]);
                    } else {
                        if (typeFilter && f.extension !== typeFilter) return;
                        if (statusFilter === 'identified' && !f.identified) return;
                        if (statusFilter === 'error' && (f.identified || !f.identification_error)) return;
                        items.push(f);
                    }
                }
            });

            // Back folder
            let finalParent = '';
            const isLibPath = explorerLibraries.some(lib => lib.path === currentExplorerPath);
            if (!isLibPath) {
                const lastSlash = currentExplorerPath.lastIndexOf('/');
                finalParent = lastSlash > 0 ? currentExplorerPath.substring(0, lastSlash) : '';
            }

            tbody.append(`
                <tr class="is-clickable" onclick="setExplorerPath('${finalParent}')">
                    <td colspan="6">
                        <i class="bi bi-arrow-up-circle mr-2 opacity-50"></i>
                        <span class="has-text-weight-bold">..</span>
                    </td>
                </tr>
            `);

            // Render Folders
            Array.from(folders).sort().forEach(folder => {
                const fullFolderPath = currentExplorerPath.endsWith('/') ? currentExplorerPath + folder : currentExplorerPath + '/' + folder;
                tbody.append(`
                    <tr class="is-clickable" onclick="setExplorerPath('${fullFolderPath}')">
                        <td colspan="6">
                            <i class="bi bi-folder-fill has-text-warning mr-2"></i>
                            <span class="has-text-weight-bold">${folder}</span>
                        </td>
                    </tr>
                `);
            });

            // Render Files
            renderFileList(tbody, items, false);
            $('#filesExplorerCount').text(`${folders.size} pastas, ${items.length} arquivos nesta pasta`);
        }
    }

    function renderFileList(tbody, files, showPath) {
        files.forEach(f => {
            const statusBadge = f.identified
                ? '<span class="tag is-success is-light is-small"><i class="bi bi-check-circle mr-1"></i> Identificado</span>'
                : '<span class="tag is-danger is-light is-small"><i class="bi bi-x-circle mr-1"></i> Erro</span>';

            const typeColor = {
                '.nsp': 'is-info',
                '.nsz': 'is-primary',
                '.xci': 'is-warning',
                '.xcz': 'is-danger'
            }[f.extension] || 'is-light';

            tbody.append(`
                <tr>
                    <td class="truncate" style="max-width: 300px;" title="${f.filename}">
                        <i class="bi bi-file-earmark mr-1 opacity-50"></i>
                        <span class="has-text-weight-bold">${f.filename}</span>
                        ${f.title_name ? `<br><span class="is-size-7 opacity-50">${f.title_name}</span>` : ''}
                    </td>
                    <td class="truncate is-family-monospace is-size-7 opacity-70" style="max-width: 400px;" title="${f.filepath}">
                        ${showPath ? f.filepath : '...'}
                    </td>
                    <td class="has-text-right is-family-monospace">${f.size_formatted}</td>
                    <td>
                        <span class="tag ${typeColor} is-light is-small">${f.extension.toUpperCase().replace('.', '')}</span>
                    </td>
                    <td class="has-text-centered">${statusBadge}</td>
                    <td class="has-text-right">
                        <button class="button is-ghost is-small has-text-danger" onclick="deleteErrorFile(${f.id})" title="Excluir arquivo">
                            <i class="bi bi-trash3"></i>
                        </button>
                    </td>
                </tr>
            `);
        });
    }

    // Attach filter events
    $(document).on('input', '#fileSearchInput', renderFilesExplorer);
    $(document).on('change', '#fileTypeFilter, #fileStatusFilter', renderFilesExplorer);

    function fillWebhooksList() {
        $.getJSON('/api/settings/webhooks', (webhooks) => {
            console.log('Webhooks received:', webhooks);
            const container = $('#webhooksList').empty();
            if (!webhooks || webhooks.length === 0) {
                container.append('<p class="is-size-7 opacity-50 has-text-centered py-4">Nenhum webhook configurado.</p>');
                return;
            }
            webhooks.forEach(w => {
                const statusIcon = w.active ? '<i class="bi bi-check-circle-fill has-text-success mr-2"></i>' : '<i class="bi bi-x-circle-fill has-text-danger mr-2"></i>';
                const statusText = w.active ? 'Ativo' : 'Inativo';

                container.append(`
                    <div class="box is-shadowless border p-3 mb-2" style="border-left: 4px solid var(--color-info) !important;">
                        <div class="columns is-vcentered is-mobile">
                            <div class="column">
                                <div class="is-flex is-align-items-center mb-1">
                                    ${statusIcon}
                                    <span class="tag is-small ${w.active ? 'is-success' : 'is-light'} is-light">${statusText}</span>
                                </div>
                                <p class="is-size-7 has-text-weight-bold truncate" title="${w.url}">${w.url}</p>
                                <p class="is-size-7 opacity-50">Eventos: ${w.events.join(', ')}</p>
                            </div>
                            <div class="column is-narrow">
                                <button class="button is-danger is-small is-light" onclick="deleteWebhook(${w.id})" title="Excluir webhook">
                                    <i class="bi bi-trash3"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `);
            });
        }).fail((xhr, status, error) => {
            console.error('Error loading webhooks:', error);
            $('#webhooksList').html('<p class="is-size-7 has-text-danger has-text-centered py-4">Erro ao carregar webhooks. Verifique o console.</p>');
        });
    }

    function addWebhook() {
        const url = $('#webhookUrl').val();
        const secret = $('#webhookSecret').val();
        const events = [];
        if ($('#eventLibraryUpdated').is(':checked')) events.push('library_updated');

        if (!url) {
            showToast('URL é obrigatória', 'error');
            return;
        }

        $.ajax({
            url: "/api/settings/webhooks",
            type: 'POST',
            data: JSON.stringify({ url, secret, events }),
            contentType: "application/json",
            success: () => {
                showToast('Webhook adicionado!', 'success');
                $('#webhookUrl').val('');
                $('#webhookSecret').val('');
                fillWebhooksList();
            }
        });
    }

    function deleteWebhook(id) {
        confirmAction({
            title: t('Excluir Webhook'),
            message: t('Deseja realmente excluir este webhook?'),
            confirmText: t('Excluir'),
            confirmClass: 'is-danger',
            onConfirm: () => {
                $.ajax({
                    url: `/api/settings/webhooks/${id}`,
                    type: 'DELETE',
                    success: () => {
                        showToast(t('Webhook removido'));
                        fillWebhooksList();
                    }
                });
            }
        });
    }

    // --- Renaming Functions ---

    function loadRenamingSettings() {
        $.getJSON('/api/settings/renaming', function (response) {
            if (response.success && response.settings) {
                $('#patternBase').val(response.settings.pattern_base);
                $('#patternUpd').val(response.settings.pattern_upd);
                $('#patternDlc').val(response.settings.pattern_dlc);
            }
        });
    }

    function saveRenamingSettings() {
        const data = {
            pattern_base: $('#patternBase').val(),
            pattern_upd: $('#patternUpd').val(),
            pattern_dlc: $('#patternDlc').val(),
            enabled: true
        };

        $.ajax({
            url: '/api/settings/renaming',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (resp) {
                if (resp.success) {
                    showToast(t('Padrões de renomeação salvos com sucesso!'), 'is-success');
                } else {
                    showToast(t('Erro ao salvar padrões.'), 'is-danger');
                }
            }
        });
    }

    function insertTag(tag) {
        // Find active input
        const focused = document.activeElement;
        if (focused && (focused.id.startsWith('pattern'))) {
            const start = focused.selectionStart;
            const end = focused.selectionEnd;
            const val = focused.value;
            focused.value = val.substring(0, start) + tag + val.substring(end);
            focused.focus();
            focused.selectionStart = focused.selectionEnd = start + tag.length;
        } else {
            $('#patternBase').val($('#patternBase').val() + tag);
        }
    }

    function previewRenaming() {
        const data = {
            pattern_base: $('#patternBase').val(),
            pattern_upd: $('#patternUpd').val(),
            pattern_dlc: $('#patternDlc').val()
        };

        $.ajax({
            url: '/api/renaming/preview',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (resp) {
                if (resp.success) {
                    let html = '';
                    resp.preview.forEach(p => {
                        html += `<div class="mb-2">
                                <span class="tag is-white border mr-2">${p.type}</span>
                                <span class="has-text-grey-light strikethrough mr-2">${p.original}</span>
                                <i class="bi bi-arrow-right mr-2 opacity-50"></i>
                                <span class="has-text-success has-text-weight-bold">${p.new}</span>
                            </div>`;
                    });
                    $('#previewContent').html(html || 'Nenhum arquivo encontrado para pré-visualização.');
                    $('#renamingPreview').removeClass('is-hidden');
                }
            }
        });
    }

    function runRenamingJob() {
        confirmAction({
            title: 'Renomeação em Massa',
            message: 'Isso irá renomear fisicamente os arquivos no seu disco. Tem certeza?',
            confirmText: 'Iniciar Renomeação',
            confirmClass: 'is-warning',
            onConfirm: () => {
                saveRenamingSettings();
                $.post('/api/renaming/run', function (resp) {
                    if (resp.success) {
                        showToast('Job de renomeação iniciado em segundo plano.', 'success');
                    }
                });
            }
        });
    }

    // Initialization
    $(document).ready(async () => {
        // Load UI state
        const lastTab = sessionStorage.getItem('lastSettingsTab') || 'General';
        $(`#settingsNav a[data-target="${lastTab}"]`).click();

        // Load renaming settings when that tab is clicked
        $('a[data-target="Renaming"]').click(function () {
            loadRenamingSettings();
        });

        fillUserTable();
        fillLibraryTable();
        loadCleanupStats();
        fillTitleDBSourcesTable();
        fillErrorsTable();
        fillFilesExplorer();
        fillWebhooksList();
        fillPluginsList();
        fillCloudStatus();

        try {
            const [regionsData, languagesData, settingsData] = await Promise.all([
                $.getJSON("/api/settings/regions"),
                $.getJSON("/api/settings/languages"),
                $.getJSON("/api/settings")
            ]);

            // Populate Regions
            const selectRegion = $('#selectRegion').empty();
            regionsData.regions.forEach(reg => selectRegion.append(new Option(reg, reg)));
            selectRegion.val(settingsData['titles/region']);

            // Populate Languages
            const selectLanguage = $('#selectLanguage').empty();
            languagesData.languages.forEach(l => selectLanguage.append(new Option(l, l)));
            selectLanguage.val(settingsData['titles/language']);

            // Auto-use latest
            $('#autoUseLatest').prop('checked', settingsData['titles/auto_use_latest'] === true);

            // General
            $('#languageSelect').val(document.cookie.match(/language=([^;]+)/)?.[1] || 'en');

            // Shop
            $('#shopHostInput').val(settingsData['shop/host']);
            $('#publicShopCheck').prop('checked', settingsData['shop/public']);
            $('#publicProfileCheck').prop('checked', settingsData['shop/public_profile']);
            $('#encryptShopCheck').prop('checked', settingsData['shop/encrypt']);
            $('#motdTextArea').val(settingsData['shop/motd']);

            // Show content
            $('#settingsLoading').addClass('is-hidden');
            $('#settingsContent').removeClass('is-hidden');

        } catch (e) {
            console.error("Failed to load settings:", e);
            showToast('Failed to load settings from server', 'error');
        }
    });

    // Close Modals on Outer Click
    $('.modal-background').on('click', function () {
        closeModal($(this).parent().attr('id'));
    });
    {% endraw %}
</script>

<style>
    .hover-bg-light:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }

    .truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
{% endblock %}