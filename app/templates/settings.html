{% extends "base.html" %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
{% include 'nav.html' %}

<section class="section">
    <div class="container is-fluid px-5">
        <div class="columns is-variable is-8">

            <!-- Sidebar Navigation -->
            <div class="column is-3">
                <aside class="menu is-sticky">
                    <p class="menu-label has-text-weight-black is-size-5 mb-5 tracking-tighter">
                        <i class="bi bi-sliders2-vertical has-text-primary mr-2"></i> {{ t('settings.menu_title') }}
                    </p>
                    <ul class="menu-list" id="settingsNav">
                        <li><a data-target="General" class="is-active"><i class="bi bi-gear-fill mr-2"></i> {{
                                t('settings.menu_general') }}</a>
                        </li>
                        <li><a data-target="Authentication"><i class="bi bi-people-fill mr-2"></i> {{
                                t('settings.menu_auth') }}</a></li>
                        <li><a data-target="Library"><i class="bi bi-folder2-open mr-2"></i> {{
                                t('settings.menu_library') }}</a></li>
                        <li><a data-target="FileExplorer"><i class="bi bi-files mr-2"></i> {{
                                t('settings.menu_explorer') }}</a>
                        </li>
                        <li><a data-target="Renaming"><i class="bi bi-pencil-square mr-2"></i> {{
                                t('settings.menu_renaming') }}</a></li>
                        <li><a data-target="TitleDB"><i class="bi bi-database-fill mr-2"></i> {{
                                t('settings.menu_titledb') }}</a>
                        </li>
                        <li><a data-target="Shop"><i class="bi bi-cart-fill mr-2"></i> {{ t('settings.menu_shop') }}</a>
                        </li>
                        <li><a data-target="Errors"><i class="bi bi-exclamation-octagon-fill mr-2"></i>
                                {{ t('settings.menu_errors') }}</a></li>
                        <li><a data-target="Tags"><i class="bi bi-tags-fill mr-2"></i> {{ t('settings.menu_tags') }}</a>
                        </li>
                        <li><a data-target="Activity"><i class="bi bi-clock-history mr-2"></i> {{
                                t('settings.menu_activity') }}</a></li>
                        <li><a data-target="Backups"><i class="bi bi-shield-check mr-2"></i> {{
                                t('settings.menu_backups') }}</a></li>
                        <!-- Webhooks, Cloud and Plugins removed -->
                        <li><a data-target="APIs"><i class="bi bi-cloud-arrow-down-fill mr-2"></i> {{
                                t('settings.menu_apis') }}</a>
                        </li>
                        <li><a data-target="ApiTokens"><i class="bi bi-key-fill mr-2"></i> {{ t('settings.menu_tokens')
                                }}</a></li>
                        <li><a data-target="System"><i class="bi bi-cpu-fill mr-2"></i> {{ t('settings.menu_system')
                                }}</a></li>
                        <li><a data-target="Help"><i class="bi bi-question-circle mr-2"></i> {{ t('settings.menu_help')
                                }}</a></li>
                    </ul>
                </aside>
            </div>

            <!-- Main Content Area -->
            <div class="column is-9">
                <!-- Loading Overlay -->
                <div id="settingsLoading" class="has-text-centered py-6">
                    <button class="button is-loading is-ghost is-large"></button>
                    <p class="mt-4 has-text-weight-bold">{{ t('common.loading_config') }}</p>
                </div>

                <div id="settingsContent" class="is-hidden animate-fade-in settings-container p-5">
                    <!-- Alerts -->
                    <div id="globalAlerts" class="mb-5">
                        {% if admin_account_created == false %}
                        <div class="notification is-ghost border p-4 mb-4"
                            style="border-left: 5px solid var(--color-danger) !important;">
                            <div class="is-flex is-align-items-center gap-3">
                                <i class="bi bi-exclamation-triangle-fill is-size-4 has-text-danger"></i>
                                <div>
                                    <strong class="is-block uppercase is-size-7 tracking-widest has-text-danger">{{
                                        t('settings.alert_admin_missing') }}</strong>
                                    <span class="is-size-7">{{ t('settings.alert_admin_missing_desc') }}</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if valid_keys == false %}
                        <div id="keysAlert" class="notification is-ghost border p-4 mb-4"
                            style="border-left: 5px solid var(--color-warning) !important;">
                            <div class="is-flex is-align-items-center gap-3">
                                <i class="bi bi-key-fill is-size-4 has-text-warning"></i>
                                <div>
                                    <strong class="is-block uppercase is-size-7 tracking-widest has-text-warning">{{
                                        t('settings.alert_keys_missing') }}</strong>
                                    <span class="is-size-7">
                                        {{ t('settings.alert_keys_missing_desc') }}
                                        <a target="_blank"
                                            href="https://gitlab.com/easyhacking/switch/-/wikis/home/getting-started/dump-keys"
                                            class="has-text-weight-bold is-underlined ml-1">{{ t('settings.guide')
                                            }}</a>
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Tab Sections -->

                    <!-- General Section -->
                    <section id="section-General" class="settings-section">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-gear-fill mr-2"></i> {{ t('settings.general_config') }}
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <div class="columns is-multiline">
                                    <div class="column is-6">
                                        <div class="field">
                                            <label class="label is-small">Região da Biblioteca</label>
                                            <div class="control is-expanded">
                                                <div class="select is-fullwidth">
                                                    <select id="selectRegion"></select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="column is-6">
                                        <div class="field">
                                            <label class="label is-small">Idioma da Biblioteca</label>
                                            <div class="control is-expanded">
                                                <div class="select is-fullwidth">
                                                    <select id="selectLanguage"></select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="column is-6">
                                        <div class="field">
                                            <label class="label is-small">Idioma da Aplicação</label>
                                            <div class="control is-expanded">
                                                <div class="select is-fullwidth">
                                                    <select id="languageSelect" onchange="changeLanguage(this.value)">
                                                        {% if get_available_languages %}
                                                        {% for code, name in get_available_languages().items() %}
                                                        <option value="{{ code }}" {% if code==get_locale() %}selected{%
                                                            endif %}>{{ name }}</option>
                                                        {% endfor %}
                                                        {% else %}
                                                        <option value="en">English</option>
                                                        <option value="pt_BR">Português (Brasil)</option>
                                                        {% endif %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-6 opacity-10">

                                <div class="block">
                                    <h3 class="title is-6 mb-4"><i class="bi bi-key-fill has-text-primary mr-2"></i>
                                        {{ t('settings.console_keys') }}</h3>
                                    <div class="notification is-ghost border p-5"
                                        style="border-left: 5px solid var(--color-primary) !important;">
                                        <div class="columns is-vcentered">
                                            <div class="column">
                                                <div class="file has-name is-fullwidth">
                                                    <label class="file-label">
                                                        <input class="file-input" type="file" id="consoleKeysInput"
                                                            name="file" accept=".keys,.txt" required>
                                                        <span class="file-cta">
                                                            <span class="file-icon"><i class="bi bi-upload"></i></span>
                                                            <span class="file-label">{{ t('settings.choose_file')
                                                                }}</span>
                                                        </span>
                                                        <span class="file-name" id="fileNameDisplay">{{
                                                            t('settings.no_file_chosen') }}</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="column is-narrow">
                                                <button class="button is-primary" onclick="submitTitlesSettings()">
                                                    <i class="bi bi-check-lg mr-2"></i> {{ t('settings.save_update') }}
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mt-2 is-flex is-align-items-center gap-2">
                                            {% if valid_keys %}
                                            <span class="tag is-success is-light"><i
                                                    class="bi bi-check-circle mr-1"></i> {{ t('Keys are valid')
                                                }}</span>
                                            {% else %}
                                            <span class="tag is-danger is-light"><i class="bi bi-x-circle mr-1"></i> {{
                                                t('Keys missing') }}</span>
                                            {% endif %}
                                            <span class="is-size-7 opacity-50 uppercase tracking-widest">{{ t('Required
                                                for identification') }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Authentication Section -->
                    <section id="section-Authentication" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-people-fill mr-2"></i> {{ t('User Management') }}
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <div class="table-container">
                                    <table class="table is-fullwidth is-hoverable" id="userTable">
                                        <thead>
                                            <tr>
                                                <th>{{ t('User') }}</th>
                                                <th>{{ t('Permissions') }}</th>
                                                <th class="has-text-right">{{ t('Actions') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>

                                <div class="block mt-6">
                                    <h3 class="title is-6 mb-4"><i
                                            class="bi bi-person-plus-fill has-text-primary mr-2"></i> {{ t('Add New
                                        User') }}</h3>
                                    <div class="notification is-ghost border p-5"
                                        style="border-left: 5px solid var(--color-primary) !important;">
                                        <form onsubmit="event.preventDefault(); submitNewUser();">
                                            <div class="columns">
                                                <div class="column">
                                                    <div class="field">
                                                        <label class="label is-small">{{ t('Username') }}</label>
                                                        <div class="control">
                                                            <input class="input" type="text" id="inputNewUser"
                                                                placeholder="Ex: admin" pattern="^[a-zA-Z0-9_-]{3,20}$"
                                                                title="3-20 caracteres (letras, números, _ ou -)"
                                                                required autocomplete="username">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="column">
                                                    <div class="field">
                                                        <label class="label is-small">{{ t('Password') }}</label>
                                                        <div class="control">
                                                            <input class="input" type="password"
                                                                id="inputNewUserPassword" minlength="6" required
                                                                autocomplete="new-password">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="field is-grouped is-grouped-multiline mb-5">
                                                <div class="control">
                                                    <label class="checkbox mr-4">
                                                        <input type="checkbox" id="checkboxNewUserShopAccess" checked>
                                                        {{
                                                        t('Shop Access') }}
                                                    </label>
                                                </div>
                                                <div class="control">
                                                    <label class="checkbox mr-4">
                                                        <input type="checkbox" id="checkboxNewUserBackupAccess"> {{
                                                        t('Backup Access') }}
                                                    </label>
                                                </div>
                                                <div class="control">
                                                    <label class="checkbox">
                                                        <input type="checkbox" id="checkboxNewUserAdminAccess"> {{
                                                        t('Admin
                                                        Access') }}
                                                    </label>
                                                </div>
                                            </div>

                                            <button class="button is-primary is-fullwidth-mobile" type="submit">
                                                {{ t('Create Account') }}
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Library Section -->
                    <section id="section-Library" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-folder2-open mr-2"></i> {{ t('Library Locations') }}
                                    <span class="ml-2 tag" id="watchdogStatus">
                                        <span class="icon"><i class="bi bi-check-circle text-success"></i></span>
                                        <span>Watchdog: {{ t('settings.checking') }}</span>
                                    </span>
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <!-- Watchdog status indicator -->
                                <div class="notification is-light is-info is-small py-2 px-3 mb-4"
                                    id="watchdogStatusBanner">
                                    <span id="watchdogStatusText">{{ t('settings.watchdog_checking') }}</span>
                                </div>

                                <!-- Estatísticas removidas conforme solicitação -->
                                <div class="table-container mb-5">
                                    <table class="table is-fullwidth" id="pathsTable">
                                        <thead>
                                            <tr>
                                                <th>{{ t('Storage Path') }}</th>
                                                <th class="has-text-centered">{{ t('common.games') }}</th>
                                                <th class="has-text-centered">{{ t('common.files') }}</th>
                                                <th class="has-text-centered">{{ t('common.size') }}</th>
                                                <th class="has-text-centered">{{ t('settings.last_scan') }}</th>
                                                <th class="has-text-right">{{ t('Actions') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>

                                <div class="columns is-vcentered">
                                    <div class="column">
                                        <div class="field has-addons">
                                            <div class="control is-expanded">
                                                <input class="input" type="text" id="libraryPathInput"
                                                    placeholder="/mnt/games">
                                            </div>
                                            <div class="control">
                                                <button class="button is-info is-light" onclick="openFileBrowser()">
                                                    <i class="bi bi-folder2-open"></i>
                                                </button>
                                            </div>
                                            <div class="control">
                                                <button class="button is-primary" onclick="submitNewLibraryPath()">
                                                    {{ t('Add Path') }}
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- File Browser Modal -->
                                    <div class="modal" id="fileBrowserModal">
                                        <div class="modal-background" onclick="closeFileBrowser()"></div>
                                        <div class="modal-card">
                                            <header class="modal-card-head">
                                                <p class="modal-card-title">{{ t('settings.select_folder_modal') }}</p>
                                                <button class="delete" aria-label="close"
                                                    onclick="closeFileBrowser()"></button>
                                            </header>
                                            <section class="modal-card-body p-0">
                                                <div class="p-3 border-bottom has-background-white-bis">
                                                    <p class="is-size-7 has-text-grey mb-1">{{
                                                        t('settings.current_path') }}</p>
                                                    <div class="field has-addons mb-0">
                                                        <div class="control is-expanded">
                                                            <input class="input is-small font-mono" type="text"
                                                                id="browserCurrentPath" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div id="fileBrowserList" class="list is-hoverable"
                                                    style="max-height: 400px; overflow-y: auto;">
                                                    <!-- Populated via JS -->
                                                </div>
                                            </section>
                                            <footer class="modal-card-foot is-justify-content-flex-end">
                                                <button class="button" onclick="closeFileBrowser()">{{
                                                    t('common.cancel') }}</button>
                                                <button class="button is-primary" onclick="selectBrowserPath()">{{
                                                    t('settings.select_current_folder') }}</button>
                                            </footer>
                                        </div>
                                    </div>

                                    <script>
                                        let currentBrowserPath = "/";

                                        function openFileBrowser() {
                                            document.getElementById('fileBrowserModal').classList.add('is-active');
                                            loadBrowserPath(currentBrowserPath);
                                        }

                                        function closeFileBrowser() {
                                            document.getElementById('fileBrowserModal').classList.remove('is-active');
                                        }

                                        function loadBrowserPath(path) {
                                            const list = document.getElementById('fileBrowserList');
                                            list.innerHTML = '<div class="p-5 has-text-centered"><i class="fas fa-spinner fa-spin"></i> ' + t('common.loading') + '</div>';

                                            window.safeFetch('/api/system/fs/list', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ path: path })
                                            })
                                                .then(r => r.json())
                                                .then(data => {
                                                    if (data.error) {
                                                        alert(data.error);
                                                        return;
                                                    }
                                                    currentBrowserPath = data.current_path;
                                                    document.getElementById('browserCurrentPath').value = currentBrowserPath;

                                                    list.innerHTML = '';
                                                    data.items.forEach(item => {
                                                        const a = document.createElement('a');
                                                        a.className = 'list-item is-flex is-align-items-center';
                                                        a.onclick = () => loadBrowserPath(item.path);

                                                        const icon = item.name === '..' ? 'bi-arrow-90deg-up' : 'bi-folder-fill has-text-warning';

                                                        a.innerHTML = `
                                                    <span class="icon mr-3"><i class="bi ${icon}"></i></span>
                                                    <span>${item.name}</span>
                                                `;
                                                        list.appendChild(a);
                                                    });
                                                })
                                                .catch(err => {
                                                    list.innerHTML = `<div class="p-4 has-text-danger">Erro: ${err}</div>`;
                                                });
                                        }

                                        function selectBrowserPath() {
                                            document.getElementById('libraryPathInput').value = currentBrowserPath;
                                            closeFileBrowser();
                                        }
                                    </script>

                                    <div class="column is-narrow">
                                        <button class="button is-warning is-outlined scanBtn mr-2"
                                            onclick="scanLibrary()">
                                            <span class="icon"><i class="bi bi-arrow-clockwise"></i></span>
                                            <span>{{ t('Full Scan') }}</span>
                                        </button>
                                        <button class="button is-warning is-outlined" id="btnCleanupOrphaned"
                                            onclick="cleanupOrphaned()">
                                            <span class="icon"><i class="bi bi-trash"></i></span>
                                            <span>{{ t('settings.btn_cleanup') }}</span>
                                        </button>
                                    </div>
                                </div>
                                <div id="cleanupStats" class="is-hidden mt-3">
                                    <div class="notification is-info is-light py-2 is-size-7">
                                        <span id="cleanupMissingFiles">0</span> {{ t('settings.stats_deleted') }} |
                                        <span id="cleanupMissingApps">0</span> {{ t('settings.stats_orphans') }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- File Explorer Section -->
                    <section id="section-FileExplorer" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-info">
                                    <i class="bi bi-files mr-2"></i> {{ t('settings.library_explorer') }}
                                </p>
                                <div class="card-header-icon pt-4 pr-5">
                                    <button class="button is-small is-dark is-outlined" onclick="fillFilesExplorer()">
                                        <i class="bi bi-arrow-clockwise mr-1"></i> {{ t('common.refresh') }}
                                    </button>
                                </div>
                            </header>
                            <div class="card-content pt-0">
                                <p class="is-size-7 mb-4 opacity-70">{{ t('settings.explorer_desc') }}</p>

                                <!-- Filters -->
                                <div class="box is-shadowless border p-3 mb-4"
                                    style="border-left: 4px solid var(--color-primary) !important;">
                                    <div class="columns is-mobile">
                                        <div class="column">
                                            <div class="field">
                                                <label class="label is-small">{{ t('common.search') }}</label>
                                                <div class="control has-icons-left">
                                                    <input class="input is-small" type="text" id="fileSearchInput"
                                                        placeholder="{{ t('settings.search_placeholder') }}">
                                                    <span class="icon is-small is-left">
                                                        <i class="bi bi-search"></i>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="column is-narrow">
                                            <div class="field">
                                                <label class="label is-small">{{ t('common.type') }}</label>
                                                <div class="control">
                                                    <div class="select is-small is-fullwidth">
                                                        <select id="fileTypeFilter">
                                                            <option value="">{{ t('common.all') }}</option>
                                                            <option value=".nsp">NSP</option>
                                                            <option value=".nsz">NSZ</option>
                                                            <option value=".xci">XCI</option>
                                                            <option value=".xcz">XCZ</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="column is-narrow">
                                            <div class="field">
                                                <label class="label is-small">{{ t('common.status') }}</label>
                                                <div class="control">
                                                    <div class="select is-small is-fullwidth">
                                                        <select id="fileStatusFilter">
                                                            <option value="">{{ t('common.all') }}</option>
                                                            <option value="identified">{{ t('common.identified') }}
                                                            </option>
                                                            <option value="error">{{ t('common.error') }}</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Files Table -->
                                <!-- Breadcrumb -->
                                <nav class="breadcrumb is-small mb-4 has-bullet-separator" aria-label="breadcrumbs">
                                    <ul id="fileExplorerBreadcrumb">
                                        <li class="is-active"><a href="javascript:void(0)"
                                                onclick="setExplorerPath('')"><i class="bi bi-hdd-fill mr-1"></i>
                                                Root</a></li>
                                    </ul>
                                </nav>

                                <div class="table-container">
                                    <table class="table is-fullwidth is-hoverable is-size-7 table-fixed"
                                        id="filesExplorerTable" style="table-layout: fixed;">
                                        <thead>
                                            <tr>
                                                <th style="width: 35%;">{{ t('common.file_path') }}</th>
                                                <th style="width: 25%;">{{ t('common.identified_title') }}</th>
                                                <th style="width: 15%;">{{ t('common.size') }}</th>
                                                <th style="width: 10%;">{{ t('common.type') }}</th>
                                                <th style="width: 10%; text-align: center;">{{ t('common.status') }}
                                                </th>
                                                <th style="width: 5%; text-align: right;">{{ t('common.actions') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Populated by JS -->
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination Info -->
                                <div class="is-flex is-justify-content-space-between is-align-items-center mt-3">
                                    <span class="is-size-7 opacity-50" id="filesExplorerCount">0 {{
                                        t('common.files_found') }}</span>
                                </div>
                            </div>
                        </div>
                    </section>
                    <!-- Renaming Section -->
                    <section id="section-Renaming" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-pencil-square mr-2"></i> {{ t('settings.renaming_auto') }}
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <div class="notification is-ghost border p-4 mb-5"
                                    style="border-left: 5px solid var(--color-info) !important;">
                                    <p class="is-size-7 opacity-70 mb-2">
                                        {{ t('settings.renaming_desc') }}
                                    </p>
                                    <div class="tags">
                                        <span class="tag is-white font-mono pointer"
                                            onclick="insertTag('{Name}')">{Name}</span>
                                        <span class="tag is-white font-mono pointer"
                                            onclick="insertTag('{TitleID}')">{TitleID}</span>
                                        <span class="tag is-white font-mono pointer"
                                            onclick="insertTag('{Version}')">{Version}</span>
                                        <span class="tag is-white font-mono pointer"
                                            onclick="insertTag('{Region}')">{Region}</span>
                                    </div>
                                </div>

                                <div class="field mb-5">
                                    <label class="label is-small">{{ t('settings.renaming_base') }}</label>
                                    <div class="control">
                                        <input class="input font-mono is-small" type="text" id="patternBase"
                                            placeholder="{Name} [{TitleID}] [v{Version}]">
                                    </div>
                                </div>

                                <div class="field mb-5">
                                    <label class="label is-small">{{ t('settings.renaming_update') }}</label>
                                    <div class="control">
                                        <input class="input font-mono is-small" type="text" id="patternUpd"
                                            placeholder="{Name} [UPD] [{TitleID}] [v{Version}]">
                                    </div>
                                </div>

                                <div class="field mb-6">
                                    <label class="label is-small">{{ t('settings.renaming_dlc') }}</label>
                                    <div class="control">
                                        <input class="input font-mono is-small" type="text" id="patternDlc"
                                            placeholder="{Name} [DLC] [{TitleID}] [v{Version}]">
                                    </div>
                                </div>

                                <div class="buttons">
                                    <button class="button is-primary" onclick="saveRenamingSettings()">
                                        <i class="bi bi-save2-fill mr-2"></i> {{ t('settings.save_patterns') }}
                                    </button>
                                    <button class="button is-ghost" onclick="previewRenaming()">
                                        <i class="bi bi-eye mr-2"></i> {{ t('settings.preview') }}
                                    </button>
                                    <button class="button is-danger is-light ml-auto" onclick="runRenamingJob()">
                                        <i class="bi bi-play-circle-fill mr-2"></i> {{ t('settings.rename_now') }}
                                    </button>
                                </div>

                                <!-- Preview Result -->
                                <div id="renamingPreview" class="is-hidden mt-5">
                                    <p class="heading has-text-weight-bold mb-3">{{ t('settings.preview_title') }}</p>
                                    <div class="box is-shadowless border is-size-7 font-mono" id="previewContent"
                                        style="border-left: 4px solid var(--color-primary) !important;">
                                        <!-- content -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- TitleDB Section -->
                    <section id="section-TitleDB" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-database-fill mr-2"></i> {{ t('TitleDB Sources') }}
                                </p>
                                <div class="card-header-icon pt-4 pr-5">
                                    <button class="button is-small is-warning is-outlined updateTitleDBBtn mr-2"
                                        onclick="forceTitleDBUpdate()">
                                        <i class="bi bi-cloud-download mr-1"></i> {{ t('Force Update') }}
                                    </button>
                                    <button class="button is-small is-ghost" onclick="refreshTitleDBDates()"
                                        title="{{ t('Refresh remote dates') }}">
                                        <i class="bi bi-calendar-event mr-1"></i>
                                    </button>
                                </div>
                            </header>
                            <div class="card-content pt-0">
                                {% if active_source %}
                                <nav class="level box is-shadowless notification py-3 mb-6"
                                    style="background: rgba(87,13,248,0.05)">
                                    <div class="level-item has-text-centered">
                                        <div>
                                            <p class="heading">{{ t('Active Source') }}</p>
                                            <p class="title is-5 has-text-primary">{{ active_source.name }}</p>
                                        </div>
                                    </div>
                                    <div class="level-item has-text-centered">
                                        <div>
                                            <p class="heading">{{ t('Last Processing') }}</p>
                                            <p class="title is-5">{{ active_source.last_process_date }}</p>
                                        </div>
                                    </div>
                                    <div class="level-item has-text-centered">
                                        <div>
                                            <p class="heading">{{ t('Titles Detected') }}</p>
                                            <p class="title is-5">{{ active_source.titles_count }}</p>
                                        </div>
                                    </div>
                                    <div class="level-item has-text-centered">
                                        <div>
                                            <p class="heading">{{ t('Status') }}</p>
                                            <span
                                                class="tag {{ 'is-success' if active_source.is_updated else 'is-warning' }} is-light">
                                                {{ t('Up to date') if active_source.is_updated else t('Outdated') }}
                                            </span>
                                        </div>
                                    </div>
                                </nav>
                                {% endif %}

                                <div class="table-container">
                                    <table class="table is-fullwidth" id="titledbSourcesTable">
                                        <thead>
                                            <tr>
                                                <th>{{ t('Source') }}</th>
                                                <th>{{ t('Last Modified (Remote)') }}</th>
                                                <th>{{ t('Last Download (Local)') }}</th>
                                                <th>{{ t('Priority') }}</th>
                                                <th>{{ t('Status') }}</th>
                                                <th class="has-text-right">{{ t('Actions') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>

                                <div class="block mt-6">
                                    <button class="button is-small is-primary is-outlined" id="toggleAddSource">
                                        <i class="bi bi-plus-lg mr-2"></i> {{ t('Add Custom Source') }}
                                    </button>

                                    <div id="addSourceForm" class="is-hidden mt-4 notification is-ghost border p-5"
                                        style="border-left: 5px solid var(--color-success) !important;">
                                        <div class="columns is-multiline">
                                            <div class="column is-6">
                                                <div class="field">
                                                    <label class="label is-small">{{ t('Name') }}</label>
                                                    <input class="input is-small" type="text" id="inputSourceName"
                                                        maxlength="50" required placeholder="Ex: My Custom Source">
                                                </div>
                                            </div>
                                            <div class="column is-6">
                                                <div class="field">
                                                    <label class="label is-small">{{ t('URL') }}</label>
                                                    <input class="input is-small" type="url" id="inputSourceUrl"
                                                        pattern="https?://.+"
                                                        title="Deve começar com http:// ou https://" required
                                                        placeholder="https://example.com/titledb.json">
                                                </div>
                                            </div>
                                            <div class="column is-6">
                                                <div class="field">
                                                    <label class="label is-small">{{ t('Type') }}</label>
                                                    <div class="select is-small is-fullwidth">
                                                        <select id="inputSourceType">
                                                            <option value="json" selected>JSON</option>
                                                            <option value="zip_legacy">Legacy ZIP</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="column is-6">
                                                <div class="field">
                                                    <label class="label is-small">{{ t('Priority') }}</label>
                                                    <input class="input is-small" type="number" id="inputSourcePriority"
                                                        value="50">
                                                </div>
                                            </div>
                                        </div>
                                        <button class="button is-primary is-small" onclick="submitNewSource()">{{
                                            t('Save Source') }}</button>
                                    </div>
                                </div>

                                <div class="box is-shadowless mt-4" style="background: rgba(87,13,248,0.03);">
                                    <label class="checkbox is-flex is-align-items-center">
                                        <input type="checkbox" id="autoUseLatest" class="mr-2">
                                        {{ t('Auto-use latest') }} - <span class="is-size-7 ml-2 opacity-75">{{
                                            t('Automatically use the source with the most recent data') }}</span>
                                    </label>
                                </div>

                                <div class="buttons mt-4">
                                    <button class="button is-primary" onclick="saveTitleDBSettings()">
                                        <i class="bi bi-check-lg mr-1"></i> {{ t('Save') }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Shop Section -->
                    <section id="section-Shop" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-cart-fill mr-2"></i> {{ t('Shop Configuration') }}
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <div class="field mb-6">
                                    <label class="label">{{ t('Public Access URL') }}</label>
                                    <div class="field has-addons">
                                        <p class="control"><a class="button is-static">https://</a></p>
                                        <div class="control is-expanded">
                                            <input class="input" id="shopHostInput" type="text"
                                                placeholder="tinfoil.domain.com">
                                        </div>
                                    </div>
                                    <p class="help opacity-50">{{ t('Used for host verification and remote access') }}
                                    </p>
                                </div>

                                <div class="field is-grouped mb-6">
                                    <div class="control">
                                        <label class="checkbox has-text-weight-bold mr-6">
                                            <input type="checkbox" id="publicShopCheck"> {{ t('Public Index') }}
                                        </label>
                                    </div>
                                    <div class="control">
                                        <label class="checkbox has-text-weight-bold">
                                            <input type="checkbox" id="encryptShopCheck" checked> {{ t('Encrypted Shop')
                                            }}
                                        </label>
                                    </div>
                                    <div class="control">
                                        <label class="checkbox has-text-weight-bold">
                                            <input type="checkbox" id="publicProfileCheck"> {{
                                            t('settings.shop_public_web') }}
                                        </label>
                                    </div>
                                </div>

                                <div class="field mb-6">
                                    <label class="label">{{ t('Message of the Day') }}</label>
                                    <div class="control">
                                        <textarea class="textarea font-mono is-small" id="motdTextArea" rows="4"
                                            placeholder="Welcome to MyFoil..."></textarea>
                                    </div>
                                </div>

                                <button class="button is-primary px-6" onclick="submitShopSettings()">
                                    {{ t('Save Shop Changes') }}
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- Errors Section -->
                    <section id="section-Errors" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-danger">
                                    <i class="bi bi-exclamation-octagon-fill mr-2"></i> Arquivos não Identificados
                                </p>
                                <div class="card-header-icon pt-4 pr-5">
                                    <button class="button is-small is-dark is-outlined" onclick="fillErrorsTable()">
                                        <i class="bi bi-arrow-clockwise mr-1"></i> Atualizar
                                    </button>
                                </div>
                            </header>
                            <div class="card-content pt-0">
                                <p class="is-size-7 mb-4 opacity-70">Abaixo estão listados os arquivos que o MyFoil não
                                    conseguiu identificar automaticamente. Você pode verificar o motivo do erro ou
                                    excluir o arquivo se for lixo.</p>
                                <div class="table-container">
                                    <div id="bulkActionsBar"
                                        class="notification is-ghost border py-2 px-3 mb-3 is-hidden"
                                        style="border-left: 5px solid var(--color-primary) !important;">
                                        <div class="is-flex is-justify-content-between is-align-items-center">
                                            <span class="is-size-7 has-text-weight-bold" id="selectedCountText">0 itens
                                                selecionados</span>
                                            <div class="buttons">
                                                <button class="button is-small is-danger is-light"
                                                    onclick="bulkDeleteFiles()">
                                                    <i class="bi bi-trash3 mr-1"></i> Excluir Selecionados
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <table class="table is-fullwidth is-hoverable" id="errorsTable">
                                        <thead>
                                            <tr>
                                                <th width="40"><input type="checkbox" id="selectAllErrors"
                                                        onclick="toggleAllErrors(this)">
                                                </th>
                                                <th>Arquivo</th>
                                                <th>Erro</th>
                                                <th class="has-text-right">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Tags Section -->
                    <section id="section-Tags" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-tags-fill mr-2"></i> Gerenciar Tags
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <div class="notification is-ghost border p-5 mb-5"
                                    style="border-left: 5px solid var(--color-primary) !important;">
                                    <div class="columns is-vcentered">
                                        <div class="column is-4">
                                            <input class="input" type="text" id="tagNameInput"
                                                placeholder="Nome da Tag">
                                        </div>
                                        <div class="column is-3">
                                            <input class="input" type="color" id="tagColorInput" value="#3273dc"
                                                style="height: 40px; padding: 2px;">
                                        </div>
                                        <div class="column is-3">
                                            <div class="select is-fullwidth">
                                                <select id="tagIconInput">
                                                    <option value="bi-tag">Etiqueta</option>
                                                    <option value="bi-star">Estrela</option>
                                                    <option value="bi-heart">Coração</option>
                                                    <option value="bi-fire">Fogo</option>
                                                    <option value="bi-controller">Controle</option>
                                                    <option value="bi-trophy">Troféu</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="column is-2">
                                            <button class="button is-primary is-fullwidth"
                                                onclick="createTag()">Criar</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-container">
                                    <table class="table is-fullwidth" id="tagsTable">
                                        <thead>
                                            <tr>
                                                <th>Tag</th>
                                                <th>Visualização</th>
                                                <th class="has-text-right">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Activity Section -->
                    <section id="section-Activity" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-clock-history mr-2"></i> Histórico de Atividade
                                </p>
                                <div class="card-header-icon pt-4 pr-5">
                                    <button class="button is-small is-ghost" onclick="fillActivityLogs()">
                                        <i class="bi bi-arrow-clockwise mr-1"></i> Atualizar
                                    </button>
                                </div>
                            </header>
                            <div class="card-content pt-0">
                                <div id="activityLogsList" class="activity-timeline">
                                    <!-- Log items injected via JS -->
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Webhooks Section -->
                    <section id="section-Webhooks" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-hdd-network mr-2"></i> Webhooks de Integração
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <p class="is-size-7 opacity-60 mb-5">
                                    Notifique serviços externos (Discord, Slack, Home Assistant) sobre eventos na sua
                                    biblioteca.
                                </p>

                                <div id="webhooksList" class="mb-5">
                                    <!-- Webhooks will be listed here -->
                                </div>

                                <div class="notification is-ghost border p-5 border"
                                    style="border-left: 5px solid var(--color-primary) !important;">
                                    <p class="heading has-text-weight-bold mb-4">Adicionar Novo Webhook</p>
                                    <div class="columns is-multiline">
                                        <div class="column is-12">
                                            <div class="field">
                                                <label class="label is-size-7">URL do Endpoint</label>
                                                <input class="input is-small" type="url" id="webhookUrl"
                                                    placeholder="https://discord.com/api/webhooks/...">
                                            </div>
                                        </div>
                                        <div class="column is-6">
                                            <div class="field">
                                                <label class="label is-size-7">Segredo (Opcional)</label>
                                                <input class="input is-small" type="text" id="webhookSecret"
                                                    placeholder="Para assinatura HMAC-SHA256">
                                            </div>
                                        </div>
                                        <div class="column is-6">
                                            <div class="field">
                                                <label class="label is-size-7">Eventos</label>
                                                <div class="control">
                                                    <label class="checkbox is-size-7">
                                                        <input type="checkbox" id="eventLibraryUpdated" checked>
                                                        Alteração na Biblioteca
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="button is-primary is-small" onclick="addWebhook()">Adicionar
                                        Webhook</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Plugins Section -->

                    <!-- APIs Section -->
                    <section id="section-APIs" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-cloud-arrow-down mr-2"></i> APIs Externas
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <p class="is-size-7 mb-4 opacity-70">
                                    Configure chaves de API para buscar avaliações, ratings e metadados
                                    adicionais de serviços externos.
                                </p>

                                <!-- RAWG API -->
                                <div class="box is-shadowless border p-4 mb-4"
                                    style="border-left: 5px solid var(--color-primary) !important;">
                                    <div class="columns is-vcentered">
                                        <div class="column">
                                            <h4 class="title is-6 mb-2">
                                                <i class="bi bi-star-fill has-text-warning mr-2"></i>
                                                RAWG API
                                            </h4>
                                            <p class="is-size-7 opacity-70 mb-3">
                                                Fornece ratings (Metacritic, usuários), screenshots,
                                                gêneros e tempo de jogo estimado.
                                            </p>
                                            <form onsubmit="return false;">
                                                <div class="field">
                                                    <label class="label is-small">API Key</label>
                                                    <div class="control">
                                                        <input class="input is-small" type="password" id="rawgApiKey"
                                                            placeholder="Obtenha em: https://rawg.io/apidocs"
                                                            autocomplete="new-password">
                                                    </div>
                                                    <p class="help is-size-7">
                                                        Limite: 20,000 requests/mês (gratuito)
                                                        <a href="https://rawg.io/apidocs" target="_blank"
                                                            class="has-text-link">Criar conta</a>
                                                    </p>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="column is-narrow">
                                            <button class="button is-small is-primary is-light"
                                                onclick="testRAWGConnection()">
                                                <i class="bi bi-check-circle mr-1"></i> Testar
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- IGDB API -->
                                <div class="box is-shadowless border p-4 mb-4"
                                    style="border-left: 5px solid #6441a5 !important;">
                                    <div class="columns is-vcentered">
                                        <div class="column">
                                            <h4 class="title is-6 mb-2">
                                                <i class="bi bi-twitch mr-2" style="color: #6441a5;"></i>
                                                IGDB API (Twitch)
                                            </h4>
                                            <p class="is-size-7 opacity-70 mb-3">
                                                Uma das bases de dados mais completas. Requer Client ID e Secret.
                                            </p>
                                            <form onsubmit="return false;">
                                                <div class="columns">
                                                    <div class="column">
                                                        <div class="field">
                                                            <label class="label is-small">Client ID</label>
                                                            <div class="control">
                                                                <input class="input is-small" type="text"
                                                                    id="igdbClientId"
                                                                    placeholder="Client ID do Twitch Dev Portal"
                                                                    autocomplete="username">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="column">
                                                        <div class="field">
                                                            <label class="label is-small">Client Secret</label>
                                                            <div class="control">
                                                                <input class="input is-small" type="password"
                                                                    id="igdbClientSecret" placeholder="Client Secret"
                                                                    autocomplete="new-password">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                            <p class="help is-size-7">
                                                Obtenha em: <a href="https://dev.twitch.tv/console" target="_blank"
                                                    class="has-text-link">Twitch Developer Portal</a>
                                            </p>
                                        </div>
                                        <div class="column is-narrow">
                                            <button class="button is-small is-primary is-light"
                                                onclick="testIGDBConnection()">
                                                <i class="bi bi-check-circle mr-1"></i> Testar
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Global API Settings -->
                                <div class="box is-shadowless border p-4 mb-4"
                                    style="border-left: 4px solid var(--color-primary) !important;">
                                    <h4 class="title is-6 mb-3">Configurações Globais de Metadados</h4>
                                    <div class="field">
                                        <label class="label is-small">Próximos Lançamentos (Dias à frente)</label>
                                        <div class="control" style="max-width: 200px;">
                                            <input class="input is-small" type="number" id="upcomingDaysAhead" min="1"
                                                max="365" placeholder="30">
                                        </div>
                                        <p class="help">Define quantos dias à frente buscar na página de "Próximos".</p>
                                    </div>
                                </div>

                                <!-- Metadata Stats -->
                                <div class="box is-shadowless border p-4 mb-4 bg-light-soft">
                                    <h4 class="title is-6 mb-3">Estatísticas de Metadados</h4>
                                    <div class="columns is-mobile has-text-centered">
                                        <div class="column">
                                            <p class="heading is-size-7 opacity-50">Jogos com Dados</p>
                                            <p class="title is-4 has-text-primary" id="statMetadataGames">--</p>
                                        </div>
                                        <div class="column">
                                            <p class="heading is-size-7 opacity-50">API RAWG</p>
                                            <span class="tag is-success is-light" id="statusRAWG">Ativa</span>
                                        </div>
                                        <div class="column">
                                            <p class="heading is-size-7 opacity-50">API IGDB</p>
                                            <span class="tag is-success is-light" id="statusIGDB">Ativa</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Automated Metadata Fetch -->
                                <div class="box is-shadowless border p-4 mb-4 bg-light-soft"
                                    id="metadata-fetch-status-container">
                                    <h4 class="title is-6 mb-3">Busca Automática de Metadados</h4>
                                    <div id="metadata-fetch-status-content">
                                        <div class="is-flex is-align-items-center mb-3">
                                            <div class="mr-4">
                                                <p class="heading is-size-7 opacity-50">Status de Agendamento</p>
                                                <span class="tag is-info is-light">2x por dia (12h)</span>
                                            </div>
                                            <div id="last-metadata-fetch-info">
                                                <p class="heading is-size-7 opacity-50">Última Execução</p>
                                                <span class="is-size-7" id="last-metadata-fetch-time">Nunca
                                                    executado</span>
                                            </div>
                                        </div>

                                        <div class="buttons">
                                            <button class="button is-small is-primary is-outlined"
                                                onclick="triggerMetadataFetch()">
                                                <i class="bi bi-stars mr-1"></i> Buscar Agora
                                            </button>
                                            <button class="button is-small is-warning is-outlined"
                                                onclick="triggerMetadataFetch(true)">
                                                <i class="bi bi-lightning-fill mr-1"></i> Forçar (Ignorar Agendamento)
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bulk Actions -->
                                <div class="notification is-ghost border p-4"
                                    style="border-left: 5px solid var(--color-info) !important;">
                                    <h4 class="title is-6 mb-3">Ações em Massa</h4>
                                    <div class="buttons">
                                        <button class="button is-info is-light" id="btnRefreshAllMetadata"
                                            onclick="refreshAllMetadata()">
                                            <i class="bi bi-arrow-repeat mr-2"></i>
                                            Atualizar Metadados de Todos os Jogos
                                        </button>
                                    </div>
                                    <p class="help is-size-7 opacity-70">
                                        ⚠️ Isso buscará notas e tempo de jogo para todos os itens identificados. Pode
                                        levar tempo.
                                    </p>
                                </div>

                                <button class="button is-primary mt-4" onclick="saveAPISettings()">
                                    <i class="bi bi-check-lg mr-1"></i> Salvar Configurações
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- System Section -->
                    <section id="section-System" class="settings-section is-hidden">
                        <div class="card box shadow-sm mb-5">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-cpu-fill mr-2"></i> Diagnóstico e Manutenção do Sistema
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <div class="columns is-multiline">
                                    <div class="column is-6">
                                        <div class="box is-shadowless border p-4">
                                            <h4 class="title is-6 mb-3"><i
                                                    class="bi bi-lightning-charge-fill has-text-warning mr-2"></i> Ações
                                                Rápidas</h4>
                                            <div class="buttons">
                                                <button class="button is-danger is-light is-small"
                                                    onclick="resetJobs()">
                                                    <i class="bi bi-arrow-counterclockwise mr-2"></i> Resetar Jobs &
                                                    Flags
                                                </button>
                                                <button class="button is-danger is-dark is-small"
                                                    onclick="resetRedis()">
                                                    <i class="bi bi-trash mr-2"></i> Resetar Redis (Fila/Cache)
                                                </button>
                                            </div>
                                            <p class="is-size-7 opacity-70 mt-2">Use o reset de jobs se o scan parecer
                                                travado. O reset do Redis limpa todas as tarefas pendentes na fila
                                                Celery.</p>
                                        </div>
                                    </div>
                                    <div class="column is-6">
                                        <div class="box is-shadowless border p-4">
                                            <h4 class="title is-6 mb-3"><i
                                                    class="bi bi-database-check has-text-success mr-2"></i> Testes de
                                                Sincronismo</h4>
                                            <div class="buttons">
                                                <button class="button is-info is-small" id="btnTestTitleDB"
                                                    onclick="testTitleDBSync()">
                                                    <i class="bi bi-play-fill mr-2"></i> Testar Sync TitleDB (Sync)
                                                </button>
                                            </div>
                                            <p class="is-size-7 opacity-70 mt-2">Executa o algoritmo de download e
                                                sincronização do TitleDB de forma síncrona, retornando o resultado
                                                imediato.</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="box is-shadowless border p-4 mt-4">
                                    <h4 class="title is-6 mb-3">
                                        <i class="bi bi-eye-fill has-text-primary mr-2"></i> Status do Watchdog
                                        (Detecçãoautomática de arquivos)
                                        <button class="button is-ghost is-small float-right"
                                            onclick="refreshWatchdogStatus()">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </h4>
                                    <div id="watchdogStatusDisplay" class="mb-3">
                                        <p class="is-size-7">Carregando status...</p>
                                    </div>
                                    <div class="buttons">
                                        <button class="button is-warning is-small" id="btnRestartWatchdog"
                                            onclick="restartWatchdog()">
                                            <i class="bi bi-arrow-counterclockwise mr-2"></i> Reiniciar Watchdog
                                        </button>
                                    </div>
                                </div>

                                <div class="box is-shadowless border p-4 mt-4">
                                    <h4 class="title is-6 mb-3">
                                        <i class="bi bi-list-task has-text-info mr-2"></i> Status da Fila (Celery)
                                        <button class="button is-ghost is-small float-right"
                                            onclick="refreshQueueStatus()">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </h4>
                                    <div id="queueStatusDisplay" class="is-size-7 font-mono overflow-auto"
                                        style="max-height: 300px; background: #f8f9fa; padding: 10px;">
                                        Clique em atualizar para ver as tarefas...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <script>
                            function resetJobs() {
                                if (!confirm("Deseja resetar todos os jobs travados e as flags de memória?")) return;
                                window.safeFetch('/api/jobs/reset', { method: 'POST' })
                                    .then(r => r.json())
                                    .then(data => alert(data.message || "Sucesso"));
                            }

                            function resetRedis() {
                                if (!confirm("CUIDADO: Isso irá limpar todo o banco do Redis e a fila de processamento. Continuar?")) return;
                                window.safeFetch('/api/system/redis/reset', { method: 'POST' })
                                    .then(r => r.json())
                                    .then(data => alert(data.message || "Sucesso"));
                            }

                            function testTitleDBSync() {
                                const btn = document.getElementById('btnTestTitleDB');
                                btn.classList.add('is-loading');
                                window.safeFetch('/api/system/titledb/test', { method: 'POST' })
                                    .then(r => r.json())
                                    .then(data => {
                                        alert(data.message + "\nTítulos: " + data.titles_in_db + "\nCache: " + data.titledb_cache_count);
                                    })
                                    .finally(() => btn.classList.remove('is-loading'));
                            }

                            function refreshQueueStatus() {
                                const display = document.getElementById('queueStatusDisplay');
                                display.innerHTML = "Carregando status da fila...";
                                window.safeFetch('/api/system/queue')
                                    .then(r => r.json())
                                    .then(data => {
                                        display.innerHTML = JSON.stringify(data, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;');
                                    })
                                    .catch(err => display.innerHTML = "Erro: " + err);
                            }

                            function refreshWatchdogStatus() {
                                const display = document.getElementById('watchdogStatusDisplay');
                                display.innerHTML = "<p class='is-size-7'>Carregando...</p>";

                                window.safeFetch('/api/system/watchdog/status')
                                    .then(r => r.json())
                                    .then(data => {
                                        if (data.success && data.running) {
                                            const statusColor = data.observer_alive ? 'has-text-success' : 'has-text-danger';
                                            const statusIcon = data.observer_alive ? 'check-circle-fill' : 'exclamation-triangle-fill';
                                            const statusText = data.observer_alive ? 'Rodando' : 'Parado/Erro';

                                            let html = `
                                                <p class="is-size-7 mb-2">
                                                    <strong>Status:</strong> 
                                                    <i class="bi bi-${statusIcon} ${statusColor}"></i> 
                                                    <span class="${statusColor}">${statusText}</span>
                                                </p>
                                                <p class="is-size-7 mb-2"><strong>Diretórios Monitorados:</strong> ${data.directories.length}</p>
                                            `;

                                            if (data.directories.length > 0) {
                                                html += '<ul class="is-size-7 ml-4">';
                                                data.directories.forEach(dir => {
                                                    html += `<li>${dir}</li>`;
                                                });
                                                html += '</ul>';
                                            }

                                            if (data.last_event_time) {
                                                html += `<p class="is-size-7 mt-2"><strong>Último Evento:</strong> ${new Date(data.last_event_time).toLocaleString('pt-BR')}</p>`;
                                            }

                                            if (data.error_count > 0) {
                                                html += `<p class="is-size-7 mt-2 has-text-warning"><strong>Erros:</strong> ${data.error_count}</p>`;
                                                if (data.last_error) {
                                                    html += `<p class="is-size-7 has-text-danger">Último erro: ${data.last_error}</p>`;
                                                }
                                            }

                                            if (data.restart_count > 0) {
                                                html += `<p class="is-size-7 mt-2 has-text-info"><strong>Auto-Reinicializações:</strong> ${data.restart_count}</p>`;
                                            }

                                            display.innerHTML = html;
                                        } else {
                                            display.innerHTML = `<p class="is-size-7 has-text-danger"><i class="bi bi-x-circle-fill"></i> Watchdog não inicializado ou parado</p>`;
                                        }
                                    })
                                    .catch(err => {
                                        display.innerHTML = `<p class="is-size-7 has-text-danger">Erro ao buscar status: ${err}</p>`;
                                    });
                            }

                            function restartWatchdog() {
                                if (!confirm("Reiniciar o watchdog? Ele será parado e iniciado novamente.")) return;

                                const btn = document.getElementById('btnRestartWatchdog');
                                btn.classList.add('is-loading');

                                window.safeFetch('/api/system/watchdog/restart', { method: 'POST' })
                                    .then(r => r.json())
                                    .then(data => {
                                        alert(data.message || "Operação concluída");
                                        refreshWatchdogStatus();
                                    })
                                    .catch(err => alert("Erro: " + err))
                                    .finally(() => btn.classList.remove('is-loading'));
                            }

                            // Auto-refresh watchdog status when tab is opened
                            document.addEventListener('DOMContentLoaded', () => {
                                const systemTab = document.querySelector('[data-target="System"]');
                                if (systemTab) {
                                    systemTab.addEventListener('click', () => {
                                        setTimeout(refreshWatchdogStatus, 200);
                                    });
                                }
                            });
                        </script>
                    </section>

                    <!-- Help Section -->
                    <section id="section-Help" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-info">
                                    <i class="bi bi-question-circle mr-2"></i> {{ t('settings.help_title') }}
                                </p>
                            </header>
                            <div class="card-content pt-0">

                                <!-- Keyboard Shortcuts -->
                                <div class="box is-shadowless border p-4 mb-4"
                                    style="border-left: 4px solid var(--color-info) !important;">
                                    <p class="heading has-text-weight-bold mb-3"><i class="bi bi-keyboard mr-2"></i>
                                        {{ t('settings.help_shortcuts') }}</p>
                                    <div class="columns is-multiline">
                                        <div class="column is-6">
                                            <table class="table is-fullwidth is-size-7">
                                                <thead>
                                                    <tr>
                                                        <th>{{ t('settings.help_shortcut_key') }}</th>
                                                        <th>{{ t('settings.help_shortcut_action') }}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><kbd>Ctrl/Cmd + K</kbd></td>
                                                        <td>{{ t('settings.shortcut_focus_search') }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td><kbd>ESC</kbd></td>
                                                        <td>{{ t('settings.shortcut_close_modals') }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td><kbd>← / →</kbd></td>
                                                        <td>{{ t('settings.shortcut_pagination') }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td><kbd>E</kbd> {{ t('settings.in_modal') }}</td>
                                                        <td>{{ t('settings.shortcut_edit_metadata') }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="column is-6">
                                            <table class="table is-fullwidth is-size-7">
                                                <thead>
                                                    <tr>
                                                        <th>{{ t('settings.help_shortcut_key') }}</th>
                                                        <th>{{ t('settings.help_shortcut_action') }}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><kbd>F</kbd> {{ t('settings.in_modal') }}</td>
                                                        <td>{{ t('settings.shortcut_toggle_wishlist') }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td><kbd>D</kbd> {{ t('settings.in_modal') }}</td>
                                                        <td>{{ t('settings.shortcut_download') }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td><kbd>Enter</kbd></td>
                                                        <td>{{ t('settings.shortcut_open_game') }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Start Guide -->
                                <div class="box is-shadowless border p-4 mb-4"
                                    style="border-left: 4px solid var(--color-success) !important;">
                                    <p class="heading has-text-weight-bold mb-3"><i class="bi bi-book mr-2"></i> {{
                                        t('settings.help_guide_title') }}</p>
                                    <div class="content is-size-7">
                                        <ol>
                                            <li><strong>{{ t('settings.guide_library') }}</strong> {{
                                                t('settings.guide_library_text') }}</li>
                                            <li><strong>{{ t('settings.guide_titledb') }}</strong> {{
                                                t('settings.guide_titledb_text') }}</li>
                                            <li><strong>{{ t('settings.guide_scan') }}</strong> {{
                                                t('settings.guide_scan_text') }}</li>
                                            <li><strong>{{ t('settings.guide_shop') }}</strong> {{
                                                t('settings.guide_shop_text') }}</li>
                                            <li><strong>{{ t('settings.guide_connect') }}</strong> {{
                                                t('settings.guide_connect_text') | safe }}
                                            </li>
                                        </ol>
                                    </div>
                                </div>

                                <!-- FAQ -->
                                <div class="box is-shadowless border p-4 mb-4"
                                    style="border-left: 4px solid var(--color-warning) !important;">
                                    <p class="heading has-text-weight-bold mb-3"><i
                                            class="bi bi-patch-question mr-2"></i> {{ t('settings.help_faq_title') }}
                                    </p>
                                    <div class="content is-size-7">
                                        <details class="mb-3">
                                            <summary class="has-text-weight-bold mb-2" style="cursor: pointer;">{{
                                                t('settings.faq_q1') }}</summary>
                                            <p>{{ t('settings.faq_a1') }}</p>
                                        </details>
                                        <details class="mb-3">
                                            <summary class="has-text-weight-bold mb-2" style="cursor: pointer;">{{
                                                t('settings.faq_q2') }}</summary>
                                            <p>{{ t('settings.faq_a2') }}</p>
                                        </details>
                                        <details class="mb-3">
                                            <summary class="has-text-weight-bold mb-2" style="cursor: pointer;">{{
                                                t('settings.faq_q3') }}</summary>
                                            <p>{{ t('settings.faq_a3') }}</p>
                                        </details>
                                        <details class="mb-3">
                                            <summary class="has-text-weight-bold mb-2" style="cursor: pointer;">{{
                                                t('settings.faq_q4') }}</summary>
                                            <p>{{ t('settings.faq_a4') }}</p>
                                        </details>
                                    </div>
                                </div>

                                <!-- Links -->
                                <div class="box is-shadowless border p-4"
                                    style="border-left: 4px solid var(--color-primary) !important;">
                                    <p class="heading has-text-weight-bold mb-3"><i class="bi bi-link-45deg mr-2"></i>
                                        {{ t('settings.help_links_title') }}</p>
                                    <div class="buttons">
                                        <a href="https://github.com/fernandodimas/MyFoil" target="_blank"
                                            class="button is-small is-dark">
                                            <i class="bi bi-github mr-2"></i> GitHub
                                        </a>
                                        <a href="https://github.com/fernandodimas/MyFoil/issues" target="_blank"
                                            class="button is-small is-info">
                                            <i class="bi bi-bug mr-2"></i> {{ t('settings.link_report_bug') }}
                                        </a>
                                        <a href="https://github.com/fernandodimas/MyFoil/wiki" target="_blank"
                                            class="button is-small is-link">
                                            <i class="bi bi-book mr-2"></i> {{ t('settings.link_wiki') }}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="section-Plugins" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-patch-check mr-2"></i> Plugins Instalados
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <p class="is-size-7 opacity-60 mb-5">
                                    Plugins permitem estender a funcionalidade do MyFoil com recursos personalizados.
                                </p>
                                <div id="pluginsList">
                                    <!-- Plugins injected by JS -->
                                </div>
                                <div class="notification is-ghost border is-size-7 mt-5"
                                    style="border-left: 5px solid var(--color-info) !important;">
                                    <i class="bi bi-info-circle mr-2"></i> Para instalar novos plugins, adicione-os na
                                    pasta <code>app/plugins/</code>.
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Backups Section -->
                    <section id="section-Backups" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-shield-check mr-2"></i> Gerenciamento de Backups
                                </p>
                                <div class="card-header-icon pt-4 pr-5">
                                    <button class="button is-small is-primary" onclick="createManualBackup()"
                                        id="btnCreateBackup">
                                        <i class="bi bi-plus-lg mr-1"></i> Criar Backup
                                    </button>
                                </div>
                            </header>
                            <div class="card-content pt-0">
                                <p class="is-size-7 mb-4 opacity-70">Gerencie os backups do banco de dados e
                                    configurações. Os backups são armazenados localmente na pasta de configuração.</p>

                                <div class="table-container">
                                    <table class="table is-fullwidth is-hoverable" id="backupsTable">
                                        <thead>
                                            <tr>
                                                <th>Arquivo</th>
                                                <th>Tipo</th>
                                                <th>Tamanho</th>
                                                <th>Data de Criação</th>
                                                <th class="has-text-right">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Preenchido via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Cloud Section -->
                    <section id="section-Cloud" class="settings-section is-hidden">
                        <div class="card box shadow-sm">
                            <header class="card-header border-none shadow-none">
                                <p class="card-header-title has-text-primary">
                                    <i class="bi bi-cloud-fill mr-2"></i> Integração Cloud
                                </p>
                            </header>
                            <div class="card-content pt-0">
                                <div class="notification is-warning mb-4">
                                    <p class="has-text-weight-bold mb-2"><i
                                            class="bi bi-exclamation-triangle mr-2"></i>Cloud Sync Descontinuado</p>
                                    <p class="is-size-7">O recurso de sincronização com Google Drive e Dropbox foi
                                        removido na versão 2.2.0 devido a obsolescência e manutenção. Use o sistema de
                                        backups local e transferência de arquivos direta como alternativa.</p>
                                </div>
                                <div class="columns">
                                    <div class="column is-6">
                                        <div class="box border is-shadowless" id="cloud-gdrive"
                                            style="border-left: 4px solid var(--color-primary) !important; opacity: 0.6;">
                                            <p class="has-text-weight-bold mb-3"><i class="bi bi-google mr-2"></i>
                                                Google Drive</p>
                                            <p class="is-size-7 opacity-60 mb-4">Sincronize sua biblioteca diretamente
                                                com uma pasta do Google Drive.</p>
                                            <div class="cloud-status mb-3 is-hidden">
                                                <span class="tag is-success is-light"><i
                                                        class="bi bi-check-circle mr-1"></i>
                                                    Conectado</span>
                                            </div>
                                            <button class="button is-small is-primary is-fullwidth btn-connect"
                                                onclick="connectCloud('gdrive')" disabled>Descontinuado</button>
                                            <p class="is-size-7 has-text-danger mt-2 is-hidden btn-config-needed">
                                                Configuração necessária (secret.json não encontrado)</p>
                                        </div>
                                    </div>
                                    <div class="column is-6">
                                        <div class="box border is-shadowless" id="cloud-dropbox"
                                            style="border-left: 4px solid var(--color-info) !important; opacity: 0.6;">
                                            <p class="has-text-weight-bold mb-3"><i class="bi bi-dropbox mr-2"></i>
                                                Dropbox</p>
                                            <p class="is-size-7 opacity-60 mb-4">Mantenha seu acervo seguro e acessível
                                                via Dropbox.</p>
                                            <div class="cloud-status mb-3 is-hidden">
                                                <span class="tag is-success is-light"><i
                                                        class="bi bi-check-circle mr-1"></i>
                                                    Conectado</span>
                                            </div>
                                            <button class="button is-small is-primary is-fullwidth btn-connect"
                                                onclick="connectCloud('dropbox')" disabled>Descontinuado</button>
                                            <p class="is-size-7 has-text-danger mt-2 is-hidden btn-config-needed">
                                                Configuração necessária (app_key.txt não encontrado)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- API Tokens Section -->
                    <section id="section-ApiTokens" class="settings-section is-hidden">
                        <div class="mb-5">
                            <h2 class="title is-4">Tokens de API</h2>
                            <p class="subtitle is-6 has-text-grey">Gerencie tokens de acesso para integrações e scripts
                                automatizados.</p>
                        </div>

                        <div class="card p-5 mb-5 shadow-sm border">
                            <div class="level">
                                <div class="level-left">
                                    <div>
                                        <strong class="is-block">Meus Tokens</strong>
                                        <span class="is-size-7 has-text-grey">Use estes tokens no header 'Authorization:
                                            Bearer &lt;token&gt;'</span>
                                    </div>
                                </div>
                                <div class="level-right">
                                    <button class="button is-primary is-small"
                                        onclick="tokensManager.openCreateModal()">
                                        <i class="bi bi-plus-lg mr-2"></i> Novo Token
                                    </button>
                                </div>
                            </div>

                            <div class="table-container mt-4">
                                <table class="table is-fullwidth is-hoverable is-striped">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Prefixo</th>
                                            <th>Criado em</th>
                                            <th>Último Uso</th>
                                            <th class="has-text-right">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tokensTableBody">
                                        <!-- Tokens loaded via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- Modals -->
                    <div class="modal" id="deleteUserModal">
                        <div class="modal-background"></div>
                        <div class="modal-card shadow-2xl">
                            <header class="modal-card-head border-none">
                                <p class="modal-card-title has-text-danger has-text-weight-black"><i
                                        class="bi bi-trash3-fill mr-2"></i> {{
                                    t('Delete User') }}</p>
                                <button class="delete" aria-label="close"
                                    onclick="closeModal('deleteUserModal')"></button>
                            </header>
                            <section class="modal-card-body py-6 modal-text opacity-70">
                                <!-- Text injected via JS -->
                            </section>
                            <footer class="modal-card-foot border-none is-justify-content-flex-end">
                                <button class="button" onclick="closeModal('deleteUserModal')">{{ t('Keep User')
                                    }}</button>
                                <button class="button is-danger btn-confirm">{{ t('Permanently Delete') }}</button>
                            </footer>
                        </div>
                    </div>

                    <div class="modal" id="deletePathModal">
                        <div class="modal-background"></div>
                        <div class="modal-card shadow-2xl">
                            <header class="modal-card-head border-none">
                                <p class="modal-card-title has-text-danger has-text-weight-black"><i
                                        class="bi bi-folder-x mr-2"></i> {{
                                    t('Remove Path') }}</p>
                                <button class="delete" aria-label="close"
                                    onclick="closeModal('deletePathModal')"></button>
                            </header>
                            <section class="modal-card-body py-6 modal-text opacity-70">
                                <!-- Text injected via JS -->
                            </section>
                            <footer class="modal-card-foot border-none is-justify-content-flex-end">
                                <button class="button" onclick="closeModal('deletePathModal')">{{ t('Cancel')
                                    }}</button>
                                <button class="button is-danger btn-confirm">{{ t('Remove Path') }}</button>
                            </footer>
                        </div>
                    </div>



                    <div class="modal" id="createTokenModal">
                        <div class="modal-background" onclick="tokensManager.closeCreateModal()"></div>
                        <div class="modal-card">
                            <header class="modal-card-head">
                                <p class="modal-card-title">Novo Token de API</p>
                                <button class="delete" aria-label="close"
                                    onclick="tokensManager.closeCreateModal()"></button>
                            </header>
                            <section class="modal-card-body">
                                <div class="field">
                                    <label class="label">Nome do Token/Aplicação</label>
                                    <div class="control">
                                        <input class="input" type="text" id="newTokenName"
                                            placeholder="Ex: Meu Script Python">
                                    </div>
                                </div>
                                <div id="generatedTokenContainer"
                                    class="is-hidden notification is-success is-light mt-4">
                                    <p class="has-text-weight-bold mb-2">Token Gerado com Sucesso!</p>
                                    <p class="is-size-7 mb-2">Copie este token agora. Você não poderá vê-lo novamente.
                                    </p>
                                    <div class="field has-addons">
                                        <div class="control is-expanded">
                                            <input class="input is-small is-family-monospace" type="text"
                                                id="generatedTokenValue" readonly>
                                        </div>
                                        <div class="control">
                                            <button class="button is-small is-info" onclick="tokensManager.copyToken()">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <footer class="modal-card-foot">
                                <button class="button is-primary" id="btnGenerateToken"
                                    onclick="tokensManager.generateToken()">Gerar</button>
                                <button class="button" onclick="tokensManager.closeCreateModal()">Fechar</button>
                            </footer>
                        </div>
                    </div>

                    <script src="/static/js/tokens.js?v={{ build_version }}"></script>
                    <script src="/static/js/settings_bundled.js?v={{ build_version }}"></script>
                    {% endblock %}