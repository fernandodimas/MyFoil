{% extends "base.html" %}

{% block content %}
{% include 'nav.html' %}

<section class="section">
    <div class="container is-fluid">

        <!-- Stats Section -->
        <div class="box p-0 overflow-hidden mb-6 shadow-sm">
            <div class="is-clickable p-4 is-flex is-justify-content-between is-align-items-center"
                onclick="$('#statsContent').toggleClass('is-hidden')">
                <div class="is-flex is-align-items-center gap-4">
                    <span class="has-text-weight-bold tracking-tight">Visão Geral</span>
                    <span class="tag is-primary is-medium has-text-weight-black">{{ total_files }}</span>
                </div>
                <span class="is-size-7 opacity-50">Clique para expandir</span>
            </div>

            <div id="statsContent" class="p-4 border-top">
                <div class="columns is-variable is-3">
                    <!-- Owned Stats -->
                    <div class="column">
                        <div class="notification is-success is-light border-success-soft">
                            <p class="heading opacity-70">Conteúdo Adquirido</p>
                            <p class="title is-4 mb-2">{{ total_games + total_updates + total_dlcs }}</p>
                            <p class="is-size-7 opacity-70">
                                {{ total_games }} Jogos | {{ total_updates }} Updates | {{ total_dlcs }} DLCs
                            </p>
                        </div>
                    </div>

                    <!-- Library Status -->
                    <div class="column">
                        <div class="notification is-warning is-light border-warning-soft">
                            <p class="heading opacity-70">Status da Biblioteca</p>
                            <p class="title is-4 mb-2">{{ games_missing_updates + games_missing_dlcs }}</p>
                            <p class="is-size-7 opacity-70">
                                {{ games_missing_updates }} Atualizações Pendentes<br>
                                {{ games_missing_dlcs }} DLCs Faltando
                            </p>
                        </div>
                    </div>

                    <!-- Missing Content -->
                    <div class="column">
                        <div class="notification is-danger is-light border-danger-soft">
                            <p class="heading opacity-70">Conteúdo Faltando</p>
                            <p class="title is-4 mb-2">{{ missing_games + missing_dlcs }}</p>
                            <p class="is-size-7 opacity-70">
                                {{ missing_games }} Jogos Base | {{ missing_dlcs }} DLCs
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls Row -->
        <div class="box p-3 mb-6 shadow-sm">
            <div class="level is-mobile is-multiline">
                <div class="level-left">
                    <div class="level-item">
                        <!-- Bulma Dropdown for Filters -->
                        <div class="dropdown" id="filterDropdown">
                            <div class="dropdown-trigger">
                                <button class="button is-primary is-small" aria-haspopup="true"
                                    aria-controls="dropdown-menu">
                                    <span class="icon is-small"><i class="bi bi-funnel-fill"></i></span>
                                </button>
                            </div>
                            <div class="dropdown-menu" id="dropdown-menu" role="menu">
                                <div class="dropdown-content p-2" style="min-width: 200px;">
                                    <label class="checkbox block py-1 px-2">
                                        <input type="checkbox" class="filterInput" id="filterCheckBase"> <span
                                            class="ml-2">JOGO BASE</span>
                                    </label>
                                    <label class="checkbox block py-1 px-2">
                                        <input type="checkbox" class="filterInput" id="filterCheckDlc"> <span
                                            class="ml-2">DLC</span>
                                    </label>
                                    <hr class="dropdown-divider">
                                    <label class="checkbox block py-1 px-2">
                                        <input type="checkbox" class="filterInput" id="filterCheckOwned"> <span
                                            class="ml-2">Adquirido</span>
                                    </label>
                                    <label class="checkbox block py-1 px-2">
                                        <input type="checkbox" class="filterInput" id="filterCheckMissing"> <span
                                            class="ml-2">Faltando</span>
                                    </label>
                                    <hr class="dropdown-divider">
                                    <label class="checkbox block py-1 px-2">
                                        <input type="checkbox" class="filterInput" id="filterCheckUpToDate"> <span
                                            class="ml-2">Atualizado</span>
                                    </label>
                                    <label class="checkbox block py-1 px-2">
                                        <input type="checkbox" class="filterInput" id="filterCheckMissingUpdate"> <span
                                            class="ml-2">Falta Atualização</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="level-item">
                        <div class="buttons has-addons">
                            <button id="btnFilterBase" class="button is-small is-outlined"
                                onclick="toggleTypeFilter('BASE')">BASE</button>
                            <button id="btnFilterDlc" class="button is-small is-outlined"
                                onclick="toggleTypeFilter('DLC')">DLC</button>
                        </div>
                    </div>
                </div>

                <div class="level-right">
                    <div class="level-item">
                        <div class="buttons has-addons" id="viewToggleButtons">
                            <button class="button is-small" onclick="setView('card')" id="btnViewCard" title="Grade"><i
                                    class="bi bi-grid-fill"></i></button>
                            <button class="button is-small" onclick="setView('icon')" id="btnViewIcon" title="Ícones"><i
                                    class="bi bi-app"></i></button>
                            <button class="button is-small" onclick="setView('list')" id="btnViewList" title="Lista"><i
                                    class="bi bi-list-ul"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Library Content -->
        <div id="libraryContainer" class="columns is-multiline is-variable is-3">
            <!-- Dynamic content injected via JS -->
        </div>

        <!-- No Results -->
        <div id="noResults" class="is-hidden has-text-centered py-6">
            <div class="notification is-light">
                <i class="bi bi-search is-size-1 opacity-20 block mb-4"></i>
                <h3 class="title is-4">Nenhum jogo encontrado</h3>
                <p class="subtitle is-6 opacity-50">Tente ajustar seus filtros ou verifique as configurações.</p>
            </div>
        </div>

        <!-- Pagination -->
        <nav class="pagination is-centered mt-6" role="navigation" aria-label="pagination">
            <a class="pagination-previous" id="btnPrev" onclick="changePage(-1)">Anterior</a>
            <a class="pagination-next" id="btnNext" onclick="changePage(1)">Próxima</a>
            <ul class="pagination-list" id="paginationSummary">
                <!-- Injected via JS -->
            </ul>
        </nav>

    </div>
</section>

<!-- Game Details Modal -->
<div class="modal" id="gameDetailsModal">
    <div class="modal-background"></div>
    <div class="modal-card" style="max-height: 90vh;">
        <header class="modal-card-head border-none">
            <p class="modal-card-title has-text-weight-black tracking-tight" id="modalTitle"></p>
            <button class="delete" aria-label="close" onclick="closeModal('gameDetailsModal')"></button>
        </header>
        <section class="modal-card-body overflow-y-auto" id="modalContent">
            <!-- Injected via JS -->
        </section>
        <footer class="modal-card-foot border-none is-justify-content-flex-end">
            <button class="button is-primary" onclick="closeModal('gameDetailsModal')">Fechar</button>
        </footer>
    </div>
</div>

<style>
    .gap-4 {
        gap: 1rem;
    }

    .gap-2 {
        gap: 0.5rem;
    }

    .mb-6 {
        margin-bottom: 1.5rem;
    }

    .mr-2 {
        margin-right: 0.5rem;
    }

    .ml-2 {
        margin-left: 0.5rem;
    }

    .p-0 {
        padding: 0 !important;
    }

    .border-top {
        border-top: 1px solid rgba(0, 0, 0, 0.05);
    }

    .border-success-soft {
        border: 1px solid rgba(72, 199, 142, 0.2);
    }

    .border-warning-soft {
        border: 1px solid rgba(255, 221, 87, 0.3);
    }

    .border-danger-soft {
        border: 1px solid rgba(241, 70, 104, 0.2);
    }

    .game-card {
        height: 100%;
        transition: transform 0.2s;
    }

    .game-card:hover {
        transform: translateY(-5px);
    }

    .game-icon-item {
        width: 120px;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .game-icon-item:hover {
        transform: scale(1.05);
    }

    /* Custom list styles for Bulma */
    .game-list-table tr {
        cursor: pointer;
        transition: background 0.2s;
    }

    .game-list-table tr:hover {
        background-color: rgba(87, 13, 248, 0.05);
    }
</style>

{% raw %}
<script>
    let games = []; // Will be populated from Jinja global
    try {
        games = games_data;
    } catch (e) { }

    let filteredGames = [...games];
    let currentPage = 1;
    let pageSize = 24;
    let currentView = localStorage.getItem('viewMode') || 'card';

    // Helper functions
    const openModal = (id) => $(`#${id}`).addClass('is-active');
    const closeModal = (id) => $(`#${id}`).removeClass('is-active');

    // Bulma Dropdown Toggle
    $('#filterDropdown .dropdown-trigger').on('click', function (e) {
        e.stopPropagation();
        $('#filterDropdown').toggleClass('is-active');
    });
    $(document).on('click', () => $('#filterDropdown').removeClass('is-active'));
    $('.dropdown-content').on('click', (e) => e.stopPropagation());

    function setView(view) {
        currentView = view;
        localStorage.setItem('viewMode', view);
        $('#viewToggleButtons .button').removeClass('is-primary');
        $(`#btnView${view.charAt(0).toUpperCase() + view.slice(1)}`).addClass('is-primary');
        renderLibrary();
    }

    function renderLibrary() {
        const container = $('#libraryContainer').empty();
        const start = (currentPage - 1) * pageSize;
        const paged = filteredGames.slice(start, start + pageSize);

        $('#noResults').toggleClass('is-hidden', paged.length > 0);

        if (currentView === 'card') renderCardView(paged);
        else if (currentView === 'icon') renderIconView(paged);
        else renderListView(paged);

        updatePagination();
    }

    function renderCardView(items) {
        items.forEach(game => {
            const card = $(`
                <div class="column is-3-desktop is-4-tablet is-12-mobile">
                    <div class="card game-card box is-paddingless is-shadowless border" onclick="showGameDetails(${game.id})">
                        <div class="card-image">
                            <figure class="image is-16by9">
                                <img src="${game.iconUrl || '/static/no-icon.png'}" alt="${game.name}" style="object-fit: cover;">
                            </figure>
                        </div>
                        <div class="card-content p-4">
                            <p class="title is-6 mb-2 line-clamp-1">${game.name}</p>
                            <p class="subtitle is-7 opacity-50 mb-3">${game.publisher || '--'}</p>
                            <div class="tags">
                                <span class="tag is-primary is-light is-small font-mono">${game.app_id}</span>
                                <span class="tag is-info is-light is-small">v${game.version_name || game.version}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            $('#libraryContainer').append(card);
        });
    }

    function renderIconView(items) {
        const wrapper = $('<div class="column is-12 is-flex is-flex-wrap-wrap is-justify-content-center gap-4"></div>');
        items.forEach(game => {
            wrapper.append(`
                <div class="game-icon-item" onclick="showGameDetails(${game.id})" title="${game.name}">
                    <figure class="image is-square box p-0 overflow-hidden shadow-sm">
                        <img src="${game.iconUrl || '/static/no-icon.png'}" alt="${game.name}">
                    </figure>
                </div>
            `);
        });
        $('#libraryContainer').append(wrapper);
    }

    function renderListView(items) {
        const table = $(`
            <div class="column is-12">
                <div class="table-container box is-paddingless shadow-sm overflow-hidden">
                    <table class="table is-fullwidth is-hoverable game-list-table">
                        <thead>
                            <tr class="is-selected" style="background: #570df8">
                                <th>Título</th>
                                <th>ID</th>
                                <th>Versão</th>
                                <th class="is-hidden-mobile">Tamanho</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        `);
        items.forEach(game => {
            table.find('tbody').append(`
                <tr onclick="showGameDetails(${game.id})">
                    <td><strong>${game.name}</strong></td>
                    <td class="font-mono is-size-7">${game.app_id}</td>
                    <td><span class="tag is-light">v${game.version}</span></td>
                    <td class="is-hidden-mobile opacity-50 font-mono is-size-7">${game.size_formatted || '--'}</td>
                </tr>
            `);
        });
        $('#libraryContainer').append(table);
    }

    function showGameDetails(id) {
        $.getJSON(`/api/app_info/${id}`, (game) => {
            $('#modalTitle').text(game.name);
            let filesHtml = game.files && game.files.length > 0 ? `
                <div class="mt-5">
                    <p class="heading has-text-weight-bold mb-3 has-text-primary">Arquivos Associados</p>
                    <div class="field">
                        ${game.files.map(f => `
                            <div class="box is-shadowless border p-3 mb-3">
                                <div class="columns is-vcentered is-mobile">
                                    <div class="column">
                                        <p class="is-size-7 has-text-weight-bold truncate" title="${f.filename}">${f.filename}</p>
                                        <p class="is-size-7 opacity-50 truncate" title="${f.filepath}">${f.filepath}</p>
                                        <p class="is-size-7 opacity-70">${f.size_formatted}</p>
                                    </div>
                                    <div class="column is-narrow">
                                        <a href="/api/get_game/${f.id}" class="button is-primary is-small" download="${f.filename}">
                                            <span class="icon is-small"><i class="bi bi-download"></i></span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '<p class="notification is-warning is-light mt-5">Nenhum arquivo local encontrado.</p>';

            let content = `
                <div class="columns">
                    <div class="column is-4">
                        <figure class="image is-square box p-0 shadow-sm overflow-hidden mb-4">
                            <img src="${game.iconUrl || '/static/no-icon.png'}" alt="Icon">
                        </figure>
                        <div class="tags are-medium">
                            <span class="tag is-primary is-fullwidth font-mono">${game.app_id}</span>
                            <span class="tag is-info is-fullwidth">${game.version_name || 'v' + game.version}</span>
                        </div>
                    </div>
                    <div class="column is-8">
                        <p class="subtitle is-6 has-text-weight-bold mb-2">Resumo</p>
                        <p class="is-size-7 mb-4 opacity-70">${game.description || 'Nenhuma descrição disponível.'}</p>
                        
                        <div class="columns is-multiline is-mobile is-gapless mb-4">
                            <div class="column is-6"><p class="is-size-7"><strong>Editora:</strong> ${game.publisher || '--'}</p></div>
                            <div class="column is-6"><p class="is-size-7"><strong>Lançamento:</strong> ${game.release_date || '--'}</p></div>
                        </div>

                        ${game.dlcs && game.dlcs.length ? `
                            <p class="heading has-text-primary has-text-weight-bold mt-5 mb-2">DLCs Disponíveis (${game.dlcs.length})</p>
                            <div class="tags">
                                ${game.dlcs.map(d => `<span class="tag is-light is-size-7">${d.name}</span>`).join('')}
                            </div>
                        ` : ''}

                        ${filesHtml}
                    </div>
                </div>
            `;
            $('#modalContent').html(content);
            openModal('gameDetailsModal');
        });
    }

    function applyFilters() {
        const query = $('#navbarSearch').val().toLowerCase();
        const showBase = $('#filterCheckBase').is(':checked');
        const showDlc = $('#filterCheckDlc').is(':checked');
        const showOwned = $('#filterCheckOwned').is(':checked');
        const showMissing = $('#filterCheckMissing').is(':checked');
        const showUpToDate = $('#filterCheckUpToDate').is(':checked');
        const showMissingUpdate = $('#filterCheckMissingUpdate').is(':checked');

        filteredGames = games.filter(g => {
            const matchesSearch = !query || (g.name && g.name.toLowerCase().includes(query)) || (g.app_id && g.app_id.toLowerCase().includes(query));

            let matchesType = true;
            if (showBase && !showDlc) matchesType = g.app_type === 'BASE';
            else if (showDlc && !showBase) matchesType = g.app_type === 'DLC';

            let matchesSource = true;
            if (showOwned && !showMissing) matchesSource = g.owned;
            else if (showMissing && !showOwned) matchesSource = !g.owned;

            let matchesStatus = true;
            if (showUpToDate && !showMissingUpdate) matchesStatus = g.has_latest_version;
            else if (showMissingUpdate && !showUpToDate) matchesStatus = !g.has_latest_version;

            return matchesSearch && matchesType && matchesSource && matchesStatus;
        });

        currentPage = 1;
        renderLibrary();
    }

    function toggleTypeFilter(type) {
        const check = type === 'BASE' ? '#filterCheckBase' : '#filterCheckDlc';
        $(check).prop('checked', !$(check).is(':checked'));
        updateShortcutButtons();
        applyFilters();
    }

    function updateShortcutButtons() {
        $('#btnFilterBase').toggleClass('is-primary', $('#filterCheckBase').is(':checked'));
        $('#btnFilterDlc').toggleClass('is-primary', $('#filterCheckDlc').is(':checked'));
    }

    function changePage(delta) {
        currentPage += delta;
        renderLibrary();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updatePagination() {
        const totalPages = Math.ceil(filteredGames.length / pageSize) || 1;
        $('#btnPrev').toggleClass('is-disabled', currentPage === 1);
        $('#btnNext').toggleClass('is-disabled', currentPage === totalPages);

        $('#paginationSummary').html(`
            <li><span class="pagination-link is-current bg-primary shadow-sm border-none">Página ${currentPage} de ${totalPages}</span></li>
            <li class="ml-4 is-size-7 opacity-50 has-text-weight-bold">(${filteredGames.length} itens)</li>
        `);
    }

    // Event Listeners
    $('.filterInput').on('change', () => { updateShortcutButtons(); applyFilters(); });
    $('#navbarSearch').on('input', applyFilters);
    $('.modal-background').on('click', () => closeModal('gameDetailsModal'));

    {% endraw %}
</script>

<script>
    // Initialize empty
    games = [];
    filteredGames = [];

    // Fetch games from API
    $(document).ready(() => {
        // Show loading state if needed, though view is already set
        const loadingHtml = `
        <div class="column is-12 has-text-centered p-6">
            <span class="loader is-loading is-inline-block" style="width: 3rem; height: 3rem; border-width: 3px;"></span>
            <p class="mt-4 is-size-6 has-text-weight-bold opacity-60">Carregando Biblioteca...</p>
        </div>
        `;
        $('#libraryContainer').html(loadingHtml);

        $.getJSON('/api/library', function (data) {
            games = data || [];
            // Log to debug invalid icons
            games.forEach(g => {
                if (!g.iconUrl) console.log('Missing icon for:', g.name);
            });

            filteredGames = [...games];
            applyFilters();
        })
            .fail(function () {
                $('#libraryContainer').html(`<div class="notification is-danger">Falha ao carregar biblioteca</div>`);
            });

        // Populated globally outside raw block
        setView(currentView);
    });
</script>

{% endblock %}