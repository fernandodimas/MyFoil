{% extends "base.html" %}

{% block content %}
{% include 'nav.html' %}

<section class="section">
    <div class="container is-fluid px-5">


        <!-- Controls Row -->
        <div class="box p-2 mb-4 shadow-sm border-none">
            <div class="level is-mobile is-multiline">
                <div class="level-left">
                    <div class="level-item mr-2">
                        <!-- Bulma Dropdown for Filters -->
                        <div class="dropdown" id="filterDropdown">
                            <div class="dropdown-trigger">
                                <button class="button is-primary is-small" aria-haspopup="true"
                                    aria-controls="dropdown-menu">
                                    <span class="icon is-small"><i class="bi bi-funnel-fill"></i></span>
                                    <span class="is-hidden-mobile ml-1">Filtros</span>
                                </button>
                            </div>
                            <div class="dropdown-menu" id="dropdown-menu" role="menu">
                                <div class="dropdown-content p-2" style="min-width: 220px;">
                                    <label class="checkbox block py-1 px-2 hover-bg-light rounded">
                                        <input type="checkbox" class="filterInput" id="filterCheckOwned" checked> <span
                                            class="ml-2">Possuídos (Local)</span>
                                    </label>
                                    <label class="checkbox block py-1 px-2 hover-bg-light rounded">
                                        <input type="checkbox" class="filterInput" id="filterCheckMissing"> <span
                                            class="ml-2">Faltantes (TitleDB)</span>
                                    </label>
                                    <hr class="dropdown-divider">
                                    <div class="field px-2">
                                        <label class="label is-size-7 opacity-50">Filtrar por Gênero</label>
                                        <div class="control">
                                            <div class="select is-small is-fullwidth">
                                                <select id="filterGender" class="filterInput">
                                                    <option value="">Todos os Gêneros</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <hr class="dropdown-divider">
                                    <label class="checkbox block py-1 px-2 hover-bg-light rounded">
                                        <input type="checkbox" class="filterInput" id="filterCheckUpToDate"> <span
                                            class="ml-2">Apenas Atualizados</span>
                                    </label>
                                    <label class="checkbox block py-1 px-2 hover-bg-light rounded">
                                        <input type="checkbox" class="filterInput" id="filterCheckMissingUpdate"> <span
                                            class="ml-2">Possui Pendências</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="level-item mr-2">
                        <div class="buttons has-addons">
                            <button class="button is-small is-light" id="btnFilterPendingUpd"
                                title="Pendente Atualização">
                                <span class="icon is-small"><i class="bi bi-arrow-up-circle"></i></span>
                                <span class="is-hidden-mobile">Update</span>
                            </button>
                            <button class="button is-small is-light" id="btnFilterPendingDlc" title="Pendente DLC">
                                <span class="icon is-small"><i class="bi bi-plus-circle"></i></span>
                                <span class="is-hidden-mobile">DLC</span>
                            </button>
                        </div>
                    </div>

                    <div class="level-item">
                        <button class="button is-small is-outlined is-danger border-none" onclick="clearFilters()"
                            title="Limpar Filtros">
                            <span class="icon is-small"><i class="bi bi-x-circle"></i></span>
                            <span class="is-hidden-mobile">Limpar</span>
                        </button>
                    </div>
                </div>

                <div class="level-right">
                    <div class="level-item mr-2 is-hidden-mobile">
                        <!-- Summary info -->
                        <span class="is-size-7 opacity-50" id="totalItemsCount">-- itens</span>
                    </div>
                    <div class="level-item mr-2 is-hidden-mobile">
                        <div class="field is-horizontal is-align-items-center">
                            <div class="field-body">
                                <input id="gridZoom" class="slider is-small is-primary m-0" type="range" min="180"
                                    max="400" step="10" value="240" oninput="updateGridZoom(this.value)">
                            </div>
                        </div>
                    </div>
                    <div class="level-item">
                        <div class="buttons has-addons" id="viewToggleButtons">
                            <button class="button is-small" onclick="setView('card')" id="btnViewCard" title="Grade"><i
                                    class="bi bi-grid-fill"></i></button>
                            <button class="button is-small" onclick="setView('icon')" id="btnViewIcon" title="Ícones"><i
                                    class="bi bi-image"></i></button>
                            <button class="button is-small" onclick="setView('list')" id="btnViewList" title="Lista"><i
                                    class="bi bi-list-ul"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Library Content -->
        <div id="libraryContainer" class="columns is-multiline is-variable is-3">
            <!-- Dynamic content injected via JS -->
        </div>

        <!-- No Results -->
        <div id="noResults" class="is-hidden has-text-centered py-6">
            <div class="notification is-light">
                <i class="bi bi-search is-size-1 opacity-20 block mb-4"></i>
                <h3 class="title is-4">Nenhum jogo encontrado</h3>
                <p class="subtitle is-6 opacity-50">Tente ajustar seus filtros ou verifique as configurações.</p>
            </div>
        </div>

        <!-- Pagination -->
        <nav class="pagination is-centered mt-6" role="navigation" aria-label="pagination">
            <a class="pagination-previous" id="btnFirst" onclick="goToPage(1)">Primeira</a>
            <a class="pagination-previous" id="btnPrev" onclick="changePage(-1)">Anterior</a>
            <a class="pagination-next" id="btnNext" onclick="changePage(1)">Próxima</a>
            <a class="pagination-next" id="btnLast" onclick="goToPage(-1)">Última</a>
            <ul class="pagination-list" id="paginationSummary">
                <!-- Injected via JS -->
            </ul>
        </nav>

        <div class="level mt-4 is-mobile">
            <div class="level-left"></div>
            <div class="level-right">
                <div class="level-item">
                    <span class="is-size-7 mr-2 opacity-50">Itens por página:</span>
                    <div class="buttons has-addons">
                        <button class="button is-small p-2 btn-page-size" data-size="24"
                            onclick="setPageSize(24)">24</button>
                        <button class="button is-small p-2 btn-page-size" data-size="48"
                            onclick="setPageSize(48)">48</button>
                        <button class="button is-small p-2 btn-page-size" data-size="96"
                            onclick="setPageSize(96)">96</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<!-- Footer with System Information -->
<footer class="footer has-background-dark has-text-light py-2 mt-6">
    <div class="container is-fluid">
        <div class="columns is-vcentered is-mobile is-multiline">
            <div class="column is-12-mobile is-4-tablet">
                <p class="is-size-7 opacity-70">
                    <span class="has-text-weight-bold">Build:</span> {{ BUILD_VERSION }}
                </p>
            </div>
            <div class="column is-12-mobile is-4-tablet has-text-centered-tablet">
                <p class="is-size-7 opacity-70">
                    <span class="has-text-weight-bold">Identificação:</span> <span id="idSource">Carregando...</span>
                </p>
            </div>
            <div class="column is-12-mobile is-4-tablet has-text-right-tablet">
                <p class="is-size-7 opacity-70">
                    <span class="has-text-weight-bold">Updates:</span> <span id="updateSource">Carregando...</span>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- Game Details Modal -->
<div class="modal" id="gameDetailsModal">
    <div class="modal-background"></div>
    <div class="modal-card" style="max-height: 90vh;">
        <header class="modal-card-head border-none">
            <p class="modal-card-title has-text-weight-black tracking-tight" id="modalTitle"></p>
            <button class="delete" aria-label="close" onclick="closeModal('gameDetailsModal')"></button>
        </header>
        <section class="modal-card-body overflow-y-auto" id="modalContent">
            <!-- Injected via JS -->
        </section>
        <footer class="modal-card-foot border-none is-justify-content-flex-end">
            <button class="button is-primary" onclick="closeModal('gameDetailsModal')">Fechar</button>
        </footer>
    </div>
</div>

<style>
    .gap-4 {
        gap: 1rem;
    }

    .gap-2 {
        gap: 0.5rem;
    }

    .mb-6 {
        margin-bottom: 1.5rem;
    }

    .mr-2 {
        margin-right: 0.5rem;
    }

    .ml-2 {
        margin-left: 0.5rem;
    }

    .p-0 {
        padding: 0 !important;
    }

    .border-top {
        border-top: 1px solid rgba(0, 0, 0, 0.05);
    }

    .border-success-soft {
        border: 1px solid rgba(72, 199, 142, 0.2);
    }

    .border-warning-soft {
        border: 1px solid rgba(255, 221, 87, 0.3);
    }

    .border-danger-soft {
        border: 1px solid rgba(241, 70, 104, 0.2);
    }

    .game-card {
        height: 100%;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .game-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    }

    .card-image img {
        transition: transform 0.3s;
    }

    .game-card:hover .card-image img {
        transform: scale(1.05);
    }

    #libraryContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(var(--card-width, 240px), 1fr));
        gap: 1.25rem;
    }

    @media screen and (min-width: 1600px) {
        .container.is-fluid {
            max-width: 1550px !important;
            margin: 0 auto !important;
        }
    }

    @media screen and (min-width: 1920px) {
        .container.is-fluid {
            max-width: 1850px !important;
            margin: 0 auto !important;
        }
    }

    @media screen and (min-width: 769px) {
        .modal-card {
            width: 800px;
        }
    }

    @media screen and (min-width: 1216px) {
        .modal-card {
            width: 1000px;
        }
    }

    @media screen and (min-width: 1408px) {
        .modal-card {
            width: 1250px;
        }
    }

    .dlc-tag {
        display: inline-flex !important;
        align-items: center;
        height: auto !important;
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
        line-height: 1.25 !important;
    }

    .game-card {
        display: flex;
        flex-direction: column;
        height: 100%;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(0, 0, 0, 0.05);
        background: #fff;
    }

    .card-image img {
        transition: transform 0.3s;
        background-color: #f5f5f5;
        /* Fallback color for missing banners */
    }

    .game-card:hover .card-image img {
        transform: scale(1.02);
    }

    .bg-light-soft {
        background: #fafafa;
    }

    .border-none {
        border: none !important;
    }

    .hover-bg-light:hover {
        background: #f5f5f5;
    }

    .rounded {
        border-radius: 4px;
    }

    .break-word {
        word-wrap: break-word;
        word-break: break-all;
        overflow-wrap: break-word;
    }

    #modalTitle {
        word-break: break-word;
    }

    .opacity-10 {
        opacity: 0.1;
    }

    .opacity-20 {
        opacity: 0.2;
    }

    .opacity-30 {
        opacity: 0.3;
    }

    .opacity-50 {
        opacity: 0.5;
    }

    .opacity-60 {
        opacity: 0.6;
    }

    .opacity-70 {
        opacity: 0.7;
    }

    .opacity-80 {
        opacity: 0.8;
    }
</style>

{% raw %}
<script>
    let games = [];
    let filteredGames = [];
    let currentPage = 1;
    let pageSize = 24;
    let currentView = localStorage.getItem('viewMode') || 'card';

    // Helper functions
    const openModal = (id) => $(`#${id}`).addClass('is-active');
    const closeModal = (id) => $(`#${id}`).removeClass('is-active');

    // Bulma Dropdown Toggle
    $('#filterDropdown .dropdown-trigger').on('click', function (e) {
        e.stopPropagation();
        $('#filterDropdown').toggleClass('is-active');
    });
    $(document).on('click', () => $('#filterDropdown').removeClass('is-active'));
    $('.dropdown-content').on('click', (e) => e.stopPropagation());

    function setView(view) {
        currentView = view;
        localStorage.setItem('viewMode', view);
        $('#viewToggleButtons .button').removeClass('is-primary');
        $(`#btnView${view.charAt(0).toUpperCase() + view.slice(1)}`).addClass('is-primary');
        renderLibrary();
    }

    function updateGridZoom(val) {
        document.documentElement.style.setProperty('--card-width', `${val}px`);
        localStorage.setItem('gridZoom', val);
    }

    function renderLibrary() {
        const container = $('#libraryContainer').empty();
        const start = (currentPage - 1) * pageSize;
        const paged = filteredGames.slice(start, start + pageSize);

        $('#noResults').toggleClass('is-hidden', paged.length > 0);

        if (currentView === 'card') renderCardView(paged);
        else if (currentView === 'icon') renderIconView(paged);
        else renderListView(paged);

        updatePagination();
    }

    function renderCardView(items) {
        items.forEach(game => {
            const statusDotClass = game.status_color === 'orange' ? 'bg-orange' : (game.status_color === 'green' ? 'bg-green' : 'bg-gray');
            const card = $(`
                <div class="grid-item">
                    <div class="card game-card box is-paddingless is-shadowless" onclick="showGameDetails('${game.id}')">
                        <div class="card-image position-relative overflow-hidden">
                            <figure class="image is-16by9">
                                <img src="${game.iconUrl || '/static/img/no-icon.png'}" alt="${game.name}" style="object-fit: cover;">
                            </figure>
                        </div>
                        <div class="card-content p-3">
                            <div class="mb-2">
                                <p class="is-size-7 font-mono opacity-40 mb-0">${game.id}</p>
                            </div>
                            
                            <p class="is-size-6 has-text-weight-bold mb-3 truncate" title="${game.name}">${game.name}</p>
                            
                            <div class="is-flex is-justify-content-between is-align-items-center">
                                <div class="is-flex is-align-items-center gap-1">
                                    <span class="status-dot ${statusDotClass}"></span>
                                    ${!game.has_latest_version && game.has_base ? '<span class="tag is-warning is-light is-small py-0 px-1" style="height: 1.1rem; font-size: 0.6rem; font-weight: bold;">UPDATE</span>' : ''}
                                    ${!game.has_all_dlcs && game.has_base ? '<span class="tag is-warning is-light is-small py-0 px-1" style="height: 1.1rem; font-size: 0.6rem; font-weight: bold;">DLC</span>' : ''}
                                </div>
                                <span class="tag is-white p-0 font-mono is-size-7 has-text-weight-bold has-text-primary">v${game.display_version}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            $('#libraryContainer').append(card);
        });
    }

    function renderIconView(items) {
        items.forEach(game => {
            const statusDotClass = game.status_color === 'orange' ? 'bg-orange' : (game.status_color === 'green' ? 'bg-green' : 'bg-gray');
            const card = $(`
                <div class="grid-item">
                    <div class="card game-card box is-paddingless is-shadowless" onclick="showGameDetails('${game.id}')" title="${game.name}">
                        <div class="card-image">
                            <figure class="image is-square bg-light relative">
                                <img src="${game.iconUrl || '/static/img/no-icon.png'}" alt="${game.name}" class="p-0" loading="lazy">
                                <div class="status-indicator position-absolute" style="bottom: 5px; right: 5px;">
                                    <span class="status-dot ${statusDotClass}"></span>
                                </div>
                            </figure>
                        </div>
                    </div>
                </div>
            `);
            $('#libraryContainer').append(card);
        });
    }

    function renderListView(items) {
        const table = $(`
            <div class="column is-12" style="width: 100%;">
                <div class="table-container box is-paddingless shadow-sm overflow-hidden border-none">
                    <table class="table is-fullwidth is-hoverable game-list-table mb-0">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #570df8">
                                <th width="65" class="has-text-centered p-1">Ícone</th>
                                <th>Título do Jogo</th>
                                <th width="140">Title ID</th>
                                <th width="80" class="has-text-centered">Versão</th>
                                <th class="is-hidden-mobile" width="100">Tamanho</th>
                                <th class="is-hidden-mobile" width="100">Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        `);
        items.forEach(game => {
            const statusColor = game.status_color === 'orange' ? 'has-text-warning' : (game.status_color === 'green' ? 'has-text-success' : 'has-text-grey');
            const statusText = game.status_color === 'orange' ? 'Pendente' : (game.status_color === 'green' ? 'Completo' : 'Incompleto');

            table.find('tbody').append(`
                <tr onclick="showGameDetails('${game.id || game.title_id}')">
                    <td class="p-1 has-text-centered"><img src="${game.iconUrl || '/static/img/no-icon.png'}" style="width: 32px; height: 32px; border-radius: 4px; object-fit: cover;"></td>
                    <td class="is-vcentered"><strong class="is-size-7-mobile">${game.name || 'Unknown'}</strong></td>
                    <td class="font-mono is-size-7 is-vcentered">${game.id || game.title_id || '--'}</td>
                    <td class="is-vcentered has-text-centered"><span class="tag is-light is-small">v${game.display_version || '0'}</span></td>
                    <td class="is-hidden-mobile is-vcentered font-mono is-size-7">${game.size_formatted || '--'}</td>
                    <td class="is-hidden-mobile ${statusColor} has-text-weight-bold is-size-7 is-vcentered">${statusText}</td>
                </tr>
            `);
        });
        $('#libraryContainer').append(table);
    }

    function showGameDetails(id) {
        $.getJSON(`/api/app_info/${id}`, (game) => {
            $('#modalTitle').text(game.name);

            // Base Files Section
            let filesHtml = game.files && game.files.length > 0 ? `
                <div class="mb-5">
                    <p class="heading has-text-weight-bold mb-3 has-text-primary">Arquivos Base Encontrados (${game.files.length})</p>
                    ${game.files.map(f => `
                        <div class="box is-shadowless border p-3 mb-2 bg-light-soft">
                            <div class="columns is-vcentered is-mobile is-gapless">
                                <div class="column">
                                    <p class="is-size-7 has-text-weight-bold break-word" title="${f.filename}">${f.filename}</p>
                                    <p class="is-size-7 opacity-50 break-word" title="${f.filepath}">${f.filepath}</p>
                                </div>
                                <div class="column is-narrow ml-2 is-flex align-items-center">
                                    <a href="/api/get_game/${f.id}" class="button is-primary is-small mr-1" title="Download">
                                        <span class="icon is-small"><i class="bi bi-download"></i></span>
                                    </a>
                                    <button class="button is-danger is-small is-light" onclick="deleteGameFile(${f.id}, '${game.id}')" title="Excluir Arquivo">
                                        <span class="icon is-small"><i class="bi bi-trash-fill"></i></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : (game.has_base ? '<p class="notification is-warning is-light p-2 is-size-7">Arquivo base não identificado localmente.</p>' : '');

            // Updates Section
            let updatesHtml = game.updates && game.updates.length > 0 ? `
                <div class="mb-5">
                    <p class="heading has-text-weight-bold mb-3 has-text-link">Histórico de Atualizações</p>
                    <div class="table-container">
                        <table class="table is-narrow is-fullwidth is-size-7">
                            <thead>
                                <tr>
                                    <th>Versão</th>
                                    <th>Lançamento</th>
                                    <th class="has-text-centered">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${game.updates.map(u => {
                const file = u.files && u.files.length > 0 ? u.files[0] : null;
                return `
                                    <tr>
                                        <td class="has-text-weight-bold">v${u.version}</td>
                                        <td class="opacity-70">${u.release_date || '--'}</td>
                                        <td class="has-text-centered">
                                            ${u.owned ? `
                                                <div class="field is-grouped is-grouped-centered">
                                                    <p class="control">
                                                        <a href="/api/get_game/${file.id}" class="button is-primary is-small" title="Download">
                                                            <i class="bi bi-download"></i>
                                                        </a>
                                                    </p>
                                                    <p class="control">
                                                        <button class="button is-danger is-small is-light" onclick="deleteGameFile(${file.id}, '${game.id}')" title="Excluir">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </p>
                                                </div>
                                            ` : '<span class="tag is-danger is-light is-small">Falta</span>'}
                                        </td>
                                    </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            ` : '';

            // DLCs Section
            let dlcsHtml = game.dlcs && game.dlcs.length > 0 ? `
                <div class="mb-5">
                    <p class="heading has-text-weight-bold mb-3 has-text-success">Conteúdo Adicional (DLCs)</p>
                    <div class="is-flex is-flex-wrap-wrap gap-2">
                        ${game.dlcs.map(d => {
                const file = d.files && d.files.length > 0 ? d.files[0] : null;
                return `
                            <div class="tags has-addons mb-0">
                                <span class="tag ${d.owned ? 'is-success' : 'is-danger'} is-light is-small dlc-tag" title="${d.app_id}" onclick="showGameDetails('${d.app_id}')" style="cursor: pointer; max-width: 200px; white-space: normal; word-wrap: break-word;">
                                    ${d.owned ? '<i class="bi bi-check-circle-fill mr-1"></i>' : '<i class="bi bi-x-circle mr-1"></i>'}
                                    ${d.name}
                                </span>
                                ${d.owned && file ? `
                                    <a href="/api/get_game/${file.id}" class="tag is-primary is-small" title="Download"><i class="bi bi-download"></i></a>
                                    <a class="tag is-danger is-small is-light" onclick="deleteGameFile(${file.id}, '${game.id}')" title="Excluir"><i class="bi bi-trash"></i></a>
                                ` : ''}
                            </div>
                            `;
            }).join('')}
                    </div>
                </div>
            ` : '';

            let content = `
                <div class="modal-banner-container mb-4" style="margin: -20px -20px 20px -20px; position: relative; height: 200px; overflow: hidden; background: #eee;">
                    <img src="${game.bannerUrl || game.iconUrl || '/static/img/no-icon.png'}" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <div class="columns">
                    <div class="column is-4">
                        <figure class="image is-square box p-0 shadow-sm overflow-hidden mb-4">
                            <img src="${game.iconUrl || '/static/img/no-icon.png'}" alt="Icon">
                        </figure>
                        <div class="box p-3 is-shadowless border bg-light-soft">
                            <p class="is-size-7 mb-1"><strong>ID:</strong> <span class="font-mono">${game.app_id}</span></p>
                            <p class="is-size-7 mb-1"><strong>Gênero:</strong> ${Array.isArray(game.category) ? game.category.join(', ') : (game.category || '--')}</p>
                            <p class="is-size-7 mb-1"><strong>Editora:</strong> ${game.publisher || '--'}</p>
                            <p class="is-size-7 mb-1"><strong>Lançamento:</strong> ${game.release_date || '--'}</p>
                            <p class="is-size-7"><strong>Versão Atual:</strong> v${game.owned_version}</p>
                        </div>
                    </div>
                    <div class="column is-8">
                        <p class="heading has-text-weight-bold mb-2">Descrição</p>
                        <div class="content is-size-7 opacity-70 mb-5" style="max-height: 150px; overflow-y: auto;">
                            ${game.description || 'Nenhuma descrição disponível.'}
                        </div>
                        
                        ${filesHtml}
                        ${updatesHtml}
                        ${dlcsHtml}
                    </div>
                </div>
            `;
            $('#modalContent').html(content);
            openModal('gameDetailsModal');
        });
    }

    function applyFilters() {
        const query = ($('#navbarSearch').val() || '').toLowerCase();
        const showOwned = $('#filterCheckOwned').is(':checked');
        const showMissing = $('#filterCheckMissing').is(':checked');
        const showUpToDate = $('#filterCheckUpToDate').is(':checked');
        const showMissingUpdate = $('#filterCheckMissingUpdate').is(':checked');
        const gender = $('#filterGender').val();

        filteredGames = games.filter(g => {
            const matchesSearch = !query || (g.name && g.name.toLowerCase().includes(query)) || (g.id && g.id.toLowerCase().includes(query));

            let matchesSource = true;
            if (showOwned && !showMissing) matchesSource = g.has_base;
            else if (showMissing && !showOwned) matchesSource = !g.has_base;

            let matchesStatus = true;
            if (showUpToDate && !showMissingUpdate) matchesStatus = g.status_color === 'green';
            else if (showMissingUpdate && !showUpToDate) matchesStatus = g.status_color === 'orange';

            const matchesGender = !gender || (g.category && g.category.includes(gender));

            return matchesSearch && matchesSource && matchesStatus && matchesGender;
        });

        $('#totalItemsCount').text(`${filteredGames.length} Jogos`);
        currentPage = 1;
        renderLibrary();
    }

    function clearFilters() {
        // Reset checkboxes
        $('#filterCheckOwned').prop('checked', true);
        $('#filterCheckMissing, #filterCheckUpToDate, #filterCheckMissingUpdate').prop('checked', false);
        $('#btnFilterPendingUpd, #btnFilterPendingDlc').removeClass('is-primary').addClass('is-light');

        // Reset gender
        $('#filterGender').val('');

        // Reset search
        $('#navbarSearch').val('');

        // Apply
        applyFilters();
    }

    $('#btnFilterPendingUpd').on('click', function () {
        const active = $(this).toggleClass('is-primary is-light').hasClass('is-primary');
        $('#filterCheckMissingUpdate').prop('checked', active);
        if (active) $('#btnFilterPendingDlc').removeClass('is-primary').addClass('is-light');
        applyFilters();
    });

    $('#btnFilterPendingDlc').on('click', function () {
        const active = $(this).toggleClass('is-primary is-light').hasClass('is-primary');
        $('#filterCheckMissingUpdate').prop('checked', active);
        if (active) $('#btnFilterPendingUpd').removeClass('is-primary').addClass('is-light');
        applyFilters();
    });


    function setPageSize(size) {
        pageSize = size;
        localStorage.setItem('pageSize', size);
        currentPage = 1;
        updatePageSizeButtons();
        renderLibrary();
    }

    function updatePageSizeButtons() {
        $('.btn-page-size').removeClass('is-primary');
        $(`.btn-page-size[data-size="${pageSize}"]`).addClass('is-primary');
    }

    function goToPage(page) {
        const totalPages = Math.ceil(filteredGames.length / pageSize) || 1;
        if (page === -1) currentPage = totalPages;
        else currentPage = page;
        renderLibrary();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function changePage(delta) {
        const totalPages = Math.ceil(filteredGames.length / pageSize) || 1;
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderLibrary();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function deleteGameFile(fileId, titleId) {
        if (!confirm('Tem certeza que deseja excluir ESTE arquivo do disco? Esta ação não pode ser desfeita.')) return;

        $.post(`/api/files/delete/${fileId}`, (res) => {
            if (res.success) {
                // Refresh modal info
                showGameDetails(titleId);
                // Also trigger library refresh
                showToast('Arquivo excluído com sucesso.');
            } else {
                showToast('Erro ao excluir: ' + (res.error || 'Erro desconhecido'), 'error');
            }
        });
    }

    function updatePagination() {
        const totalPages = Math.ceil(filteredGames.length / pageSize) || 1;
        $('#btnFirst').toggleClass('is-disabled', currentPage === 1);
        $('#btnPrev').toggleClass('is-disabled', currentPage === 1);
        $('#btnNext').toggleClass('is-disabled', currentPage === totalPages);
        $('#btnLast').toggleClass('is-disabled', currentPage === totalPages);

        $('#paginationSummary').html(`
            <li><span class="pagination-link is-current bg-primary shadow-sm border-none">Página ${currentPage} de ${totalPages}</span></li>
            <li class="ml-4 is-size-7 opacity-50 has-text-weight-bold">(${filteredGames.length} itens)</li>
        `);
    }

    // Event Listeners
    $('.filterInput').on('change', applyFilters);
    $('#navbarSearch').on('input', applyFilters);
    $('.modal-background').on('click', () => closeModal('gameDetailsModal'));

    // Load system information for footer
    $.getJSON('/api/system/info', function (data) {
        $('#idSource').text(data.id_source);
        $('#updateSource').text(data.update_source);
    }).fail(function () {
        $('#idSource').text('N/A');
        $('#updateSource').text('N/A');
    });

    {% endraw %}
</script>

<script>
    // Initialize empty
    games = [];
    filteredGames = [];

    // Fetch games from API
    $(document).ready(() => {
        // Show loading state if needed, though view is already set
        const loadingHtml = `
        <div class="column is-12 has-text-centered p-6">
            <span class="loader is-loading is-inline-block" style="width: 3rem; height: 3rem; border-width: 3px;"></span>
            <p class="mt-4 is-size-6 has-text-weight-bold opacity-60">Carregando Biblioteca...</p>
        </div>
        `;
        $('#libraryContainer').html(loadingHtml);

        $.getJSON('/api/library', function (data) {
            games = data || [];

            // Populate Genders
            const genders = new Set();
            games.forEach(g => {
                if (g.category && Array.isArray(g.category)) {
                    g.category.forEach(c => genders.add(c));
                }
            });
            const genderSelect = $('#filterGender').empty().append('<option value="">Todos os Gêneros</option>');
            Array.from(genders).sort().forEach(g => genderSelect.append(new Option(g, g)));

            filteredGames = [...games];
            applyFilters();
        })
            .fail(function () {
                $('#libraryContainer').html(`<div class="notification is-danger">Falha ao carregar biblioteca</div>`);
            });

        // Initialize zoom from localStorage
        const savedZoom = localStorage.getItem('gridZoom') || 240;
        $('#gridZoom').val(savedZoom);
        updateGridZoom(savedZoom);

        // Initialize pageSize from localStorage
        pageSize = parseInt(localStorage.getItem('pageSize')) || 24;
        updatePageSizeButtons();

        // Populated globally outside raw block
        setView(currentView);
    });
</script>

{% endblock %}