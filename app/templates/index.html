{% extends "base.html" %}

{% block content %}
{% include 'nav.html' %}

<div class="container mx-auto px-4 py-8">

    <!-- Stats Section -->
    <div class="collapse collapse-plus bg-base-100 shadow-xl mb-8">
        <input type="checkbox" />
        <div class="collapse-title flex items-center justify-between pr-12">
            <div class="flex items-center gap-4">
                <span class="text-lg font-bold">{{ t('Total Files') }}</span>
                <span class="badge badge-primary badge-lg">{{ total_files }}</span>
            </div>
            <span class="text-sm opacity-50">{{ t('Click for details') }}</span>
        </div>
        <div class="collapse-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4">
                <!-- Owned Stats -->
                <div class="stats shadow bg-success text-success-content">
                    <div class="stat">
                        <div class="stat-title text-success-content opacity-70">{{ t('Owned Content') }}</div>
                        <div class="stat-value text-2xl mb-2">{{ total_games + total_updates + total_dlcs }}</div>
                        <div class="stat-desc text-success-content opacity-70">
                            {{ total_games }} {{ t('Games') }} | {{ total_updates }} {{ t('Updates') }} | {{ total_dlcs
                            }} {{ t('DLCs') }}
                        </div>
                    </div>
                </div>

                <!-- Library Status -->
                <div class="stats shadow bg-warning text-warning-content">
                    <div class="stat">
                        <div class="stat-title text-warning-content opacity-70">{{ t('Library Status') }}</div>
                        <div class="stat-value text-2xl mb-2">{{ games_missing_updates + games_missing_dlcs }}</div>
                        <div class="stat-desc text-warning-content opacity-70">
                            {{ games_missing_updates }} {{ t('Games needing Update') }}<br>
                            {{ games_missing_dlcs }} {{ t('Games missing DLCs') }}
                        </div>
                    </div>
                </div>

                <!-- Missing Content -->
                <div class="stats shadow bg-error text-error-content">
                    <div class="stat">
                        <div class="stat-title text-error-content opacity-70">{{ t('Missing Content') }}</div>
                        <div class="stat-value text-2xl mb-2">{{ missing_games + missing_updates + missing_dlcs }}</div>
                        <div class="stat-desc text-error-content opacity-70">
                            {{ missing_games }} {{ t('Missing Base Games') }}<br>
                            {{ missing_updates }} {{ t('Missing Updates') }} | {{ missing_dlcs }} {{ t('Missing DLCs')
                            }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Controls Row -->
    <div
        class="flex flex-col md:flex-row gap-4 items-center justify-between mb-8 bg-base-100 p-4 rounded-2xl shadow-sm">

        <div class="flex flex-wrap items-center gap-2">
            <!-- Filter Dropdown -->
            <div class="dropdown">
                <div tabindex="0" role="button" class="btn btn-primary btn-square"><i class="bi bi-funnel-fill"></i>
                </div>
                <ul tabindex="0"
                    class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 border border-base-200 mt-2">
                    <li><label class="label cursor-pointer justify-start gap-2"><input type="checkbox"
                                class="checkbox checkbox-xs filterLabel" id="filterCheckBase"> <span>BASE</span></label>
                    </li>
                    <li><label class="label cursor-pointer justify-start gap-2"><input type="checkbox"
                                class="checkbox checkbox-xs filterLabel" id="filterCheckDlc"> <span>DLC</span></label>
                    </li>
                    <div class="divider my-0"></div>
                    <li><label class="label cursor-pointer justify-start gap-2"><input type="checkbox"
                                class="checkbox checkbox-xs filterLabel" id="filterCheckOwned">
                            <span>Owned</span></label></li>
                    <li><label class="label cursor-pointer justify-start gap-2"><input type="checkbox"
                                class="checkbox checkbox-xs filterLabel" id="filterCheckMissing">
                            <span>Missing</span></label></li>
                    <div class="divider my-0"></div>
                    <li><label class="label cursor-pointer justify-start gap-2"><input type="checkbox"
                                class="checkbox checkbox-xs filterLabel" id="filterCheckUpToDate"> <span>Up to
                                date</span></label></li>
                    <li><label class="label cursor-pointer justify-start gap-2"><input type="checkbox"
                                class="checkbox checkbox-xs filterLabel" id="filterCheckMissingUpdate"> <span>Missing
                                Update</span></label></li>
                </ul>
            </div>

            <!-- Search Input -->
            <div class="relative w-full max-w-xs">
                <input type="text" id="textFilter" placeholder="{{ t('Search titles...') }}"
                    class="input input-bordered w-full pr-10" />
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none opacity-50">
                    <i class="bi bi-search"></i>
                </div>
            </div>
        </div>

        <div class="flex flex-wrap items-center gap-4">
            <!-- View Mode -->
            <div class="join border border-base-300">
                <button class="join-item btn btn-sm btn-ghost view-toggle-btn active" data-view="card"
                    title="{{ t('Card View') }}"><i class="bi bi-grid-fill"></i></button>
                <button class="join-item btn btn-sm btn-ghost view-toggle-btn" data-view="icon"
                    title="{{ t('Icon View') }}"><i class="bi bi-grid-3x3-gap-fill"></i></button>
                <button class="join-item btn btn-sm btn-ghost view-toggle-btn" data-view="list"
                    title="{{ t('List View') }}"><i class="bi bi-list-ul"></i></button>
            </div>

            <!-- Items Per Page -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-sm btn-outline">{{ t('Items per page') }} <i
                        class="bi bi-chevron-down"></i></div>
                <ul tabindex="0"
                    class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-32 border border-base-200 mt-2">
                    <li><button class="items-per-page" data-value="12">12</button></li>
                    <li><button class="items-per-page" data-value="24">24</button></li>
                    <li><button class="items-per-page" data-value="48">48</button></li>
                </ul>
            </div>

            <!-- Card Size -->
            <div class="hidden md:flex items-center gap-2">
                <i class="bi bi-image text-xs opacity-50"></i>
                <input type="range" min="1" max="5" value="3" class="range range-xs range-primary w-24"
                    id="cardSizeRange" />
                <i class="bi bi-image text-lg opacity-50"></i>
            </div>
        </div>
    </div>

    <!-- Games Container -->
    <div id="gameGrid" class="grid-container"></div>

    <!-- Pagination -->
    <div class="flex justify-center mt-12 mb-8">
        <div id="paginationControls" class="join"></div>
    </div>
</div>

<style>
    /* Custom grid helper */
    .grid-container {
        display: grid;
        gap: 1.5rem;
    }

    .view-toggle-btn.active {
        background-color: var(--p);
        color: var(--pc);
    }

    .game-card-hover {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .game-card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
    let games;
    let filteredGames;
    let itemsPerPage = 12;
    let currentPage = 1;
    let totalGames = 0;
    let cardSize = 3;
    let currentView = 'card';

    function fetchGames() {
        return new Promise((resolve, reject) => {
            $.get(`/api/titles`, function (data) {
                totalGames = data.total;
                games = data.games;
                filteredGames = games;
                resolve();
            }).fail(reject);
        });
    }

    function renderGames() {
        $('#cardSizeRange').val(cardSize);
        const gameGrid = $('#gameGrid');
        gameGrid.empty();

        if (currentView === 'card') {
            renderCardView();
        } else if (currentView === 'icon') {
            renderIconView();
        } else if (currentView === 'list') {
            renderListView();
        }
    }

    function getGridCols() {
        switch (cardSize) {
            case 1: return 'grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8'; // Small
            case 2: return 'grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6';
            case 3: return 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4'; // Default
            case 4: return 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3';
            case 5: return 'grid-cols-1 md:grid-cols-2'; // Large
            default: return 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4';
        }
    }

    function renderCardView() {
        const gameGrid = $('#gameGrid');
        gameGrid.removeClass().addClass(`grid-container grid ${getGridCols()} gap-6`);

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedGames = filteredGames.slice(start, end);

        paginatedGames.forEach(game => {
            const card = $(`
                <div class="card bg-base-100 shadow-xl overflow-hidden game-card-hover cursor-pointer group">
                    <figure class="relative aspect-video">
                        <img src="${game.bannerUrl}" alt="${game.name}" class="object-cover w-full h-full group-hover:scale-110 transition-transform duration-500" />
                        <div class="absolute top-2 right-2 flex gap-1">
                            ${game.owned === false ? '<span class="badge badge-warning badge-sm">Missing</span>' : '<span class="badge badge-info badge-sm">' + game.app_type + '</span>'}
                        </div>
                    </figure>
                    <div class="card-body p-4 gap-1">
                        <h2 class="card-title text-sm leading-tight line-clamp-2 min-h-[3rem]">${game.title_id_name || game.name}</h2>
                        <div class="flex justify-between items-end mt-2">
                             <span class="text-[10px] opacity-50 font-mono tracking-tight">${game.title_id}</span>
                             <div class="flex gap-1 items-center">
                                ${game.has_latest_version !== undefined ? `
                                    <div class="tooltip tooltip-top" data-tip="Updates: ${game.has_latest_version ? 'Up to date' : 'Update Available'}">
                                        <i class="bi ${game.has_latest_version ? 'bi-check-circle-fill text-success' : 'bi-arrow-down-circle text-warning'} text-sm"></i>
                                    </div>
                                ` : ''}
                             </div>
                        </div>
                    </div>
                </div>
            `);
            gameGrid.append(card);
        });
        updatePaginationControls(filteredGames.length);
    }

    function renderIconView() {
        const gameGrid = $('#gameGrid');
        gameGrid.removeClass().addClass('flex flex-wrap gap-4 justify-center');

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const baseGames = filteredGames.filter(game => game.app_type === 'BASE');
        const paginatedGames = baseGames.slice(start, end);

        const size = 6 + (cardSize * 2);

        paginatedGames.forEach(game => {
            const icon = $(`
                <div class="tooltip" data-tip="${game.name}">
                    <img src="${game.iconUrl || '/static/img/no-icon.png'}" class="w-${size} h-${size} md:w-${size * 2} md:h-${size * 2} rounded-xl shadow-lg ring-1 ring-base-content/10 hover:ring-primary hover:scale-105 transition-all cursor-pointer object-cover" 
                         onerror="this.src='/static/img/no-icon.png'"/>
                </div>
            `);
            gameGrid.append(icon);
        });
        updatePaginationControls(baseGames.length);
    }

    function renderListView() {
        const gameGrid = $('#gameGrid');
        gameGrid.removeClass().addClass('flex flex-col gap-4');

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;

        const gameGroups = {};
        filteredGames.forEach(game => {
            const baseId = game.title_id;
            if (!gameGroups[baseId]) {
                gameGroups[baseId] = { base: null, dlcs: [], updates: [] };
            }
            if (game.app_type === 'BASE') gameGroups[baseId].base = game;
            else if (game.app_type === 'DLC') gameGroups[baseId].dlcs.push(game);
            else if (game.app_type === 'UPDATE') gameGroups[baseId].updates.push(game);
        });

        const groupedArray = Object.values(gameGroups).filter(g => g.base !== null);
        const paginatedGroups = groupedArray.slice(start, end);

        paginatedGroups.forEach((group, index) => {
            const game = group.base;
            const accordionId = `collapse${index}`;
            const ownedDLCs = group.dlcs.filter(d => d.owned !== false).length;
            const totalDLCs = group.dlcs.length;

            let dlcBadgeClass = 'badge-ghost';
            if (totalDLCs > 0) {
                if (ownedDLCs === 0) dlcBadgeClass = 'badge-error';
                else if (ownedDLCs < totalDLCs) dlcBadgeClass = 'badge-warning';
                else dlcBadgeClass = 'badge-success';
            }

            const hasUpdates = group.updates.length > 0;
            const missingUpdate = group.updates.some(u => u.owned === false);
            const updateBadgeClass = missingUpdate ? 'badge-warning' : 'badge-success';

            let latestVersion = 0;
            let hasMultipleVersions = false;
            const ownedUpdates = group.updates.filter(u => u.owned !== false);
            if (ownedUpdates.length > 0) {
                const versions = ownedUpdates.map(u => parseInt(u.app_version || u.version || 0));
                latestVersion = Math.max(...versions);
                hasMultipleVersions = versions.some(v => v < latestVersion);
            }
            const versionDisplay = latestVersion > 0 ? ` [v${latestVersion}${hasMultipleVersions ? '+' : ''}]` : '';

            const item = $(`
                <div class="collapse collapse-arrow bg-base-100 shadow-sm border border-base-200">
                    <input type="radio" name="game-accordion" /> 
                    <div class="collapse-title flex items-center gap-4">
                        <div class="avatar">
                            <div class="w-12 rounded-lg">
                                <img src="${game.iconUrl || game.bannerUrl || '/static/img/no-icon.png'}" onerror="this.src='/static/img/no-icon.png'" />
                            </div>
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-sm md:text-base">${game.title_id_name || game.name}</span>
                                <span class="text-[10px] font-mono opacity-50 hidden md:inline">${game.title_id}${versionDisplay}</span>
                            </div>
                            <div class="flex gap-1 mt-1">
                                ${game.owned === false ? '<span class="badge badge-warning badge-xs">Missing Base</span>' : ''}
                                ${totalDLCs > 0 ? `<span class="badge ${dlcBadgeClass} badge-xs">${ownedDLCs}/${totalDLCs} DLCs</span>` : ''}
                                ${hasUpdates ? `<span class="badge ${updateBadgeClass} badge-xs">UPDATE</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="collapse-content overflow-x-auto">
                        <table class="table table-sm w-full mt-4">
                            <thead>
                                <tr class="bg-base-200">
                                    <th>{{ t('Type') }}</th>
                                    <th>{{ t('Name') }}</th>
                                    <th>{{ t('ID') }}</th>
                                    <th>{{ t('Version') }}</th>
                                    <th>{{ t('Status') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.updates.map(upd => `
                                    <tr>
                                        <td><span class="badge badge-primary badge-xs">UPD</span></td>
                                        <td>${upd.name || 'Update'}</td>
                                        <td class="font-mono text-xs opacity-50">${upd.app_id}</td>
                                        <td>v${upd.app_version || upd.version || '0'}</td>
                                        <td><span class="badge ${upd.owned === false ? 'badge-warning' : 'badge-success'} badge-xs">${upd.owned === false ? 'Missing' : 'Owned'}</span></td>
                                    </tr>
                                `).join('')}
                                ${group.dlcs.map(dlc => `
                                    <tr>
                                        <td><span class="badge badge-info badge-xs">DLC</span></td>
                                        <td>${dlc.name}</td>
                                        <td class="font-mono text-xs opacity-50">${dlc.app_id}</td>
                                        <td>v0</td>
                                        <td><span class="badge ${dlc.owned === false ? 'badge-warning' : 'badge-success'} badge-xs">${dlc.owned === false ? 'Missing' : 'Owned'}</span></td>
                                    </tr>
                                `).join('')}
                                ${group.dlcs.length === 0 && group.updates.length === 0 ? `<tr><td colspan="5" class="text-center opacity-50 py-4">{{ t('No DLCs or Updates available') }}</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `);
            gameGrid.append(item);
        });
        updatePaginationControls(groupedArray.length);
    }

    function updatePaginationControls(totalItems) {
        const pagination = $('#paginationControls');
        pagination.empty();

        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (totalPages <= 1) return;

        const prev = $(`<button class="join-item btn btn-sm ${currentPage === 1 ? 'btn-disabled' : ''}">«</button>`);
        prev.click(() => { if (currentPage > 1) { currentPage--; renderGames(); } });
        pagination.append(prev);

        const startP = Math.max(1, currentPage - 2);
        const endP = Math.min(totalPages, currentPage + 2);

        for (let i = startP; i <= endP; i++) {
            const btn = $(`<button class="join-item btn btn-sm ${i === currentPage ? 'btn-active btn-primary' : ''}">${i}</button>`);
            btn.click(() => { currentPage = i; renderGames(); });
            pagination.append(btn);
        }

        const next = $(`<button class="join-item btn btn-sm ${currentPage === totalPages ? 'btn-disabled' : ''}">»</button>`);
        next.click(() => { if (currentPage < totalPages) { currentPage++; renderGames(); } });
        pagination.append(next);
    }

    $(document).ready(function () {
        itemsPerPage = parseInt(localStorage.getItem('itemsPerPage')) || 12;
        currentView = localStorage.getItem('currentView') || 'card';
        cardSize = parseInt(localStorage.getItem('cardSize')) || 3;

        $(`.view-toggle-btn[data-view="${currentView}"]`).addClass('active');

        fetchGames().then(renderGames);

        $('#textFilter').on('input', function () {
            const searchText = $(this).val().toLowerCase();
            filteredGames = games.filter(game =>
                game.name?.toLowerCase().includes(searchText) ||
                game.title_id?.toLowerCase().includes(searchText)
            );
            currentPage = 1;
            renderGames();
        });

        $('#cardSizeRange').on('input', function () {
            cardSize = parseInt($(this).val());
            localStorage.setItem('cardSize', cardSize);
            renderGames();
        });

        $('.view-toggle-btn').click(function () {
            $('.view-toggle-btn').removeClass('active');
            $(this).addClass('active');
            currentView = $(this).data('view');
            localStorage.setItem('currentView', currentView);
            currentPage = 1;
            renderGames();
        });

        $('.items-per-page').click(function () {
            itemsPerPage = $(this).data('value');
            localStorage.setItem('itemsPerPage', itemsPerPage);
            currentPage = 1;
            renderGames();
        });

        $('.filterLabel').change(function () {
            const base = $('#filterCheckBase').is(':checked');
            const dlc = $('#filterCheckDlc').is(':checked');
            const owned = $('#filterCheckOwned').is(':checked');
            const missing = $('#filterCheckMissing').is(':checked');
            const upToDate = $('#filterCheckUpToDate').is(':checked');
            const outdated = $('#filterCheckMissingUpdate').is(':checked');

            filteredGames = games.filter(game => {
                let show = true;
                if (base || dlc) {
                    show = (base && game.app_type === 'BASE') || (dlc && game.app_type === 'DLC');
                }
                if (show && (owned || missing)) {
                    show = (owned && game.owned !== false) || (missing && game.owned === false);
                }
                // Update filters logic can be added here
                return show;
            });
            currentPage = 1;
            renderGames();
        });
    });
</script>
{% endblock %}