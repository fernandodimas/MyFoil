{% extends "base.html" %}

{% block content %}
{% include 'nav.html' %}

<div class="container is-fluid px-5 mt-5 pb-6">


    <!-- Controls Row -->
    <div class="box p-2 mb-4 shadow-sm border-none bg-glass" style="position: relative; z-index: 30;">
        <div class="is-flex is-flex-wrap-wrap is-align-items-center gap-2 px-1 py-1">

            <!-- Left Group: Primary Filters -->
            <div class="is-flex gap-2 is-justify-content-center-mobile is-flex-grow-1-mobile">
                <!-- Filters Dropdown -->
                <div class="dropdown" id="filterDropdown">
                    <div class="dropdown-trigger">
                        <button class="button is-primary is-small" aria-haspopup="true">
                            <span class="icon is-small"><i class="bi bi-funnel-fill"></i></span>
                            <span class="is-hidden-mobile ml-1">Filtros</span>
                            <span class="icon is-small ml-1 is-hidden-tablet"><i class="bi bi-caret-down-fill"
                                    style="font-size: 0.5rem"></i></span>
                        </button>
                    </div>
                    <div class="dropdown-menu" id="dropdown-menu" role="menu">
                        <div class="dropdown-content p-4" style="min-width: 260px;">
                            <div class="field mb-3">
                                <label class="label is-size-7 opacity-70">Gênero</label>
                                <div class="control">
                                    <div class="select is-small is-fullwidth">
                                        <select id="filterGender" class="filterInput">
                                            <option value="">Todos os Gêneros</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label is-size-7 opacity-70">Tag</label>
                                <div class="control">
                                    <div class="select is-small is-fullwidth">
                                        <select id="filterTag" class="filterInput">
                                            <option value="">Todas as Tags</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sorting Dropdown -->
                <div class="dropdown" id="sortDropdown">
                    <div class="dropdown-trigger">
                        <button class="button is-info is-small is-light" aria-haspopup="true">
                            <span class="icon is-small"><i class="bi bi-sort-down"></i></span>
                            <span class="is-hidden-mobile ml-1">Ordenar</span>
                        </button>
                    </div>
                    <div class="dropdown-menu" id="sort-menu" role="menu">
                        <div class="dropdown-content p-2" style="min-width: 200px;">
                            <a class="dropdown-item is-size-7 sort-option" data-sort="name-asc">A-Z (Nome)</a>
                            <a class="dropdown-item is-size-7 sort-option" data-sort="name-desc">Z-A (Nome)</a>
                            <hr class="dropdown-divider">
                            <a class="dropdown-item is-size-7 sort-option" data-sort="release-desc">Lançamento
                                (Novo)</a>
                            <a class="dropdown-item is-size-7 sort-option" data-sort="release-asc">Lançamento
                                (Antigo)</a>
                            <hr class="dropdown-divider">
                            <a class="dropdown-item is-size-7 sort-option" data-sort="added-desc">Adicionado
                                Recentemente</a>
                            <a class="dropdown-item is-size-7 sort-option" data-sort="added-asc">Adicionado
                                Antigamente</a>
                            <hr class="dropdown-divider">
                            <a class="dropdown-item is-size-7 sort-option" data-sort="id-asc">Title ID
                                (Crescente)</a>
                            <a class="dropdown-item is-size-7 sort-option" data-sort="status-desc">Status de
                                Atualização</a>
                        </div>
                    </div>
                </div>

                <!-- Quick Status Filters -->
                <div class="buttons has-addons m-0">
                    <button class="button is-small is-light" id="btnFilterPendingBase" title="Falta Arquivo Base">
                        <span class="icon is-small"><i class="bi bi-disc"></i></span>
                        <span class="is-hidden-mobile ml-1">Base</span>
                    </button>
                    <button class="button is-small is-light" id="btnFilterPendingUpd" title="Pendente Atualização">
                        <span class="icon is-small"><i class="bi bi-arrow-up-circle"></i></span>
                        <span class="is-hidden-mobile ml-1">Update</span>
                    </button>
                    <button class="button is-small is-light" id="btnFilterPendingDlc" title="Pendente DLC">
                        <span class="icon is-small"><i class="bi bi-plus-circle"></i></span>
                        <span class="is-hidden-mobile ml-1">DLC</span>
                    </button>
                </div>

                <button class="button is-small is-outlined is-danger" onclick="clearFilters()" title="Limpar Filtros">
                    <span class="icon is-small"><i class="bi bi-x"></i></span>
                </button>
            </div>

            <!-- Right Group: Secondary Controls (Pushed to the right on desktop) -->
            <div class="is-flex gap-2 is-align-items-center is-justify-content-center-mobile is-flex-grow-1-mobile"
                style="margin-left: auto;">
                <div class="is-hidden-mobile mr-2">
                    <span class="is-size-7 opacity-50 font-mono" id="totalItemsCount">-- itens</span>
                </div>

                <div class="is-flex is-align-items-center is-hidden-mobile" style="min-width: 100px;">
                    <i class="bi bi-zoom-in is-size-7 mr-2 opacity-50"></i>
                    <input id="gridZoom" class="slider is-small is-primary m-0" type="range" min="180" max="400"
                        step="10" value="240" oninput="updateGridZoom(this.value)">
                </div>

                <div class="buttons has-addons m-0" id="viewToggleButtons">
                    <button class="button is-small p-2" onclick="setView('card')" id="btnViewCard" title="Grade"><i
                            class="bi bi-grid-fill"></i></button>
                    <button class="button is-small p-2" onclick="setView('icon')" id="btnViewIcon" title="Ícones"><i
                            class="bi bi-image"></i></button>
                    <button class="button is-small p-2" onclick="setView('list')" id="btnViewList" title="Lista"><i
                            class="bi bi-list-ul"></i></button>
                </div>
            </div>

            <div class="is-hidden-tablet is-flex-grow-1 has-text-centered">
                <span class="is-size-7 opacity-50" id="totalItemsCountMobile">-- itens</span>
            </div>
        </div>
    </div>

    <!-- Library Content -->
    <div id="libraryContainer" class="columns is-multiline is-variable is-3">
        <!-- Dynamic content injected via JS -->
    </div>

    <!-- No Results -->
    <div id="noResults" class="is-hidden has-text-centered py-6">
        <div class="notification is-light">
            <i class="bi bi-search is-size-1 opacity-20 block mb-4"></i>
            <h3 class="title is-4">Nenhum jogo encontrado</h3>
            <p class="subtitle is-6 opacity-50">Tente ajustar seus filtros ou verifique as configurações.</p>
        </div>
    </div>

    <!-- Pagination -->
    <nav class="pagination is-centered mt-6" role="navigation" aria-label="pagination">
        <a class="pagination-previous" id="btnFirst" onclick="goToPage(1)">Primeira</a>
        <a class="pagination-previous" id="btnPrev" onclick="changePage(-1)">Anterior</a>
        <a class="pagination-next" id="btnNext" onclick="changePage(1)">Próxima</a>
        <a class="pagination-next" id="btnLast" onclick="goToPage(-1)">Última</a>
        <ul class="pagination-list" id="paginationSummary">
            <!-- Injected via JS -->
        </ul>
    </nav>

    <div class="level mt-4 is-mobile">
        <div class="level-left"></div>
        <div class="level-right">
            <div class="level-item">
                <span class="is-size-7 mr-2 opacity-50">Itens por página:</span>
                <div class="buttons has-addons">
                    <button class="button is-small p-2 btn-page-size" data-size="24"
                        onclick="setPageSize(24)">24</button>
                    <button class="button is-small p-2 btn-page-size" data-size="48"
                        onclick="setPageSize(48)">48</button>
                    <button class="button is-small p-2 btn-page-size" data-size="96"
                        onclick="setPageSize(96)">96</button>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<style>
    .gap-4 {
        gap: 1rem;
    }

    .gap-2 {
        gap: 0.5rem;
    }

    .mb-6 {
        margin-bottom: 1.5rem;
    }

    .mr-2 {
        margin-right: 0.5rem;
    }

    .ml-2 {
        margin-left: 0.5rem;
    }

    .p-0 {
        padding: 0 !important;
    }

    .border-top {
        border-top: 1px solid rgba(0, 0, 0, 0.05);
    }

    .border-success-soft {
        border: 1px solid rgba(72, 199, 142, 0.2);
    }

    .border-warning-soft {
        border: 1px solid rgba(255, 221, 87, 0.3);
    }

    .border-danger-soft {
        border: 1px solid rgba(241, 70, 104, 0.2);
    }

    .game-card {
        height: 100%;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .game-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    }

    .card-image img {
        transition: transform 0.3s;
    }

    .game-card:hover .card-image img {
        transform: scale(1.05);
    }

    #libraryContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(var(--card-width, 240px), 1fr));
        gap: 1.25rem;
    }

    #libraryContainer.is-list-view {
        display: block;
    }



    @media screen and (min-width: 769px) {
        .modal-card {
            width: 800px;
        }
    }

    @media screen and (min-width: 1216px) {
        .modal-card {
            width: 1000px;
        }
    }

    @media screen and (min-width: 1408px) {
        .modal-card {
            width: 1250px;
        }
    }

    .dlc-tag {
        display: inline-flex !important;
        align-items: center;
        height: auto !important;
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
        line-height: 1.25 !important;
    }

    .truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    @media screen and (max-width: 768px) {
        .is-flex-grow-1-mobile {
            flex-grow: 1 !important;
        }

        .is-justify-content-center-mobile {
            justify-content: center !important;
        }
    }

    .game-card {
        display: flex;
        flex-direction: column;
        height: 100%;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(0, 0, 0, 0.05);
        background: #fff;
    }

    .card-image img {
        transition: transform 0.3s;
        background-color: #f5f5f5;
        /* Fallback color for missing banners */
    }

    .game-card:hover .card-image img {
        transform: scale(1.02);
    }

    .bg-light-soft {
        background: #fafafa;
    }

    .border-none {
        border: none !important;
    }

    .hover-bg-light:hover {
        background: #f5f5f5;
    }

    .rounded {
        border-radius: 4px;
    }

    .break-word {
        word-wrap: break-word;
        word-break: break-all;
        overflow-wrap: break-word;
    }

    #modalTitle {
        word-break: break-word;
    }

    .opacity-10 {
        opacity: 0.1;
    }

    .opacity-20 {
        opacity: 0.2;
    }

    .opacity-30 {
        opacity: 0.3;
    }

    .opacity-50 {
        opacity: 0.5;
    }

    .opacity-60 {
        opacity: 0.6;
    }

    .opacity-70 {
        opacity: 0.7;
    }

    .opacity-80 {
        opacity: 0.8;
    }
</style>



<script>
    {% raw %}

    let games = [];
    let filteredGames = [];
    let currentPage = 1;
    let pageSize = 24;
    let currentSort = localStorage.getItem('myfoil_library_sort') || 'name-asc';
    let currentView = localStorage.getItem('viewMode') || 'card';


    // Helper functions


    function initGenders(gamesList) {
        const genders = new Set();
        gamesList.forEach(g => {
            if (g && g.category && Array.isArray(g.category)) {
                g.category.forEach(c => genders.add(c));
            }
        });

        const currentVal = $('#filterGender').val();
        const genderSelect = $('#filterGender').empty().append(`<option value="">${t('All Genres')}</option>`);
        Array.from(genders).sort().forEach(g => genderSelect.append(new Option(g, g)));
        if (currentVal) $('#filterGender').val(currentVal);
    }

    function initTags(gamesList) {
        const tags = new Set();
        gamesList.forEach(g => {
            if (g && g.tags && Array.isArray(g.tags)) {
                g.tags.forEach(t => tags.add(t));
            }
        });

        const currentVal = $('#filterTag').val();
        const tagSelect = $('#filterTag').empty().append(`<option value="">${t('All Tags')}</option>`);
        Array.from(tags).sort().forEach(t => tagSelect.append(new Option(t, t)));
        if (currentVal) $('#filterTag').val(currentVal);
    }


    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + K: Focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            $('#navbarSearch').focus();
        }

        // ESC: Close all modals
        if (e.key === 'Escape') {
            $('.modal').removeClass('is-active');
        }

        // Arrow keys for pagination if search is not focused
        if (document.activeElement.id !== 'navbarSearch') {
            if (e.key === 'ArrowLeft' && currentPage > 1) {
                changePage(currentPage - 1);
            } else if (e.key === 'ArrowRight' && currentPage < Math.ceil(filteredGames.length / pageSize)) {
                changePage(currentPage + 1);
            }
        }
    });

    function setView(view) {
        currentView = view;
        localStorage.setItem('viewMode', view);
        $('#viewToggleButtons .button').removeClass('is-primary');
        $(`#btnView${view.charAt(0).toUpperCase() + view.slice(1)}`).addClass('is-primary');
        renderLibrary();
    }

    function updateGridZoom(val) {
        document.documentElement.style.setProperty('--card-width', `${val}px`);
        localStorage.setItem('gridZoom', val);
    }

    function renderLibrary() {
        const container = $('#libraryContainer').empty();
        const start = (currentPage - 1) * pageSize;
        const paged = filteredGames.slice(start, start + pageSize);

        $('#noResults').toggleClass('is-hidden', paged.length > 0);

        // Handle list view width
        if (currentView === 'list') {
            container.addClass('is-list-view');
        } else {
            container.removeClass('is-list-view');
        }

        if (currentView === 'card') renderCardView(paged);
        else if (currentView === 'icon') renderIconView(paged);
        else renderListView(paged);

        updatePagination();
    }

    function refreshLibrary() {
        console.log("Refreshing library data...");
        $.getJSON('/api/library', function (data) {
            games = data || [];
            localStorage.setItem('myfoil_library_cache', JSON.stringify(games));
            initGenders(games);
            initTags(games);

            // If we're on page 1, we can just apply filters to refresh everything
            // but if we're on another page, we might want to stay there
            // For simplicity, let's just apply filters which will trigger renderLibrary
            applyFilters();
            showToast(t('Library updated!'), 'success');
        });
    }

    function renderCardView(items) {
        items.forEach(game => {
            const statusDotClass = game.status_color === 'orange' ? 'bg-orange' : (game.status_color === 'green' ? 'bg-green' : 'bg-gray');
            const card = $(`
                <div class="grid-item">
                    <div class="card game-card is-paddingless is-shadowless" onclick="showGameDetails('${game.id}')">
                        <div class="card-image position-relative overflow-hidden">
                            <figure class="image is-16by9">
                                <img src="${game.bannerUrl || game.iconUrl || '/static/img/no-icon.png'}" alt="${game.name}" style="object-fit: cover;">
                            </figure>
                        </div>
                        <div class="card-content p-3">
                            <div class="is-flex is-justify-content-between is-align-items-start is-flex-wrap-wrap mb-2" style="gap: 4px;">
                                <span class="font-mono is-size-7 opacity-40">${game.id}</span>
                                <span class="font-mono is-size-7 has-text-weight-bold" style="margin-left: auto;">v${game.display_version}</span>
                            </div>
                            
                            <p class="is-size-6 has-text-weight-bold mb-3 truncate" title="${game.name}">${game.name}</p>
                            
                            <div class="is-flex is-justify-content-between is-align-items-center">
                                <div class="is-flex is-align-items-center gap-1">
                                    <span class="status-dot ${statusDotClass}"></span>
                                    <span class="is-size-7 opacity-70 font-mono" title="Tamanho em disco">${game.size_formatted || '--'}</span>
                                </div>
                                <div class="is-flex gap-1 is-justify-content-end" style="margin-left: auto;">
                                    ${!game.has_latest_version && game.has_base ? '<span class="tag tag-update has-text-weight-bold">UPDATE</span>' : ''}
                                    ${!game.has_all_dlcs && game.has_base ? '<span class="tag tag-dlc has-text-weight-bold">DLC</span>' : ''}
                                    ${game.has_redundant_updates ? '<span class="tag tag-redundant has-text-weight-bold" title="Updates redundantes detectados">X-UPD</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            $('#libraryContainer').append(card);
        });
    }

    function renderIconView(items) {
        items.forEach(game => {
            const statusDotClass = game.status_color === 'orange' ? 'bg-orange' : (game.status_color === 'green' ? 'bg-green' : 'bg-gray');
            const card = $(`
                <div class="grid-item">
                    <div class="card game-card is-paddingless is-shadowless" onclick="showGameDetails('${game.id}')" title="${game.name}">
                        <div class="card-image">
                            <figure class="image is-square bg-light relative">
                                <img src="${game.iconUrl || '/static/img/no-icon.png'}" alt="${game.name}" class="p-0" loading="lazy" style="object-fit: cover; width: 100%; height: 100%;">
                                <div class="status-indicator position-absolute" style="bottom: 5px; right: 5px;">
                                    <span class="status-dot ${statusDotClass}"></span>
                                </div>
                            </figure>
                        </div>
                    </div>
                </div>
            `);
            $('#libraryContainer').append(card);
        });
    }

    function renderListView(items) {
        const table = $(`
            <div class="column is-12" style="width: 100%;">
                <div class="table-container box is-paddingless shadow-sm overflow-hidden border-none">
                    <table class="table is-fullwidth is-hoverable game-list-table mb-0">
                        <thead>
                            <tr class="has-background-light-soft" style="border-bottom: 2px solid #7c3aed">
                                <th width="65" class="has-text-centered p-1">Ícone</th>
                                <th>Título do Jogo</th>
                                <th width="140">Title ID</th>
                                <th width="80" class="has-text-centered">Versão</th>
                                <th class="is-hidden-mobile" width="100">Tamanho</th>
                                <th class="is-hidden-mobile" width="100">Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        `);
        items.forEach(game => {
            const statusColor = game.status_color === 'orange' ? 'has-text-warning' : (game.status_color === 'green' ? 'has-text-success' : 'has-text-grey');
            const statusText = game.status_color === 'orange' ? t('Missing') : (game.status_color === 'green' ? t('Owned') : t('Incomplete'));

            table.find('tbody').append(`
                <tr onclick="showGameDetails('${game.id || game.title_id}')">
                    <td class="p-1 has-text-centered"><img src="${game.iconUrl || '/static/img/no-icon.png'}" style="width: 32px; height: 32px; border-radius: 4px; object-fit: cover;"></td>
                    <td class="is-vcentered">
                        <strong class="is-size-7-mobile">${game.name || 'Unknown'}</strong>
                        ${game.has_redundant_updates ? '<span class="tag tag-redundant ml-2 has-text-weight-bold">X-UPD</span>' : ''}
                    </td>
                    <td class="font-mono is-size-7 is-vcentered">${game.id || game.title_id || '--'}</td>
                    <td class="is-vcentered has-text-centered"><span class="tag is-light is-small">v${game.display_version || '0'}</span></td>
                    <td class="is-hidden-mobile is-vcentered font-mono is-size-7">${game.size_formatted || '--'}</td>
                    <td class="is-hidden-mobile ${statusColor} has-text-weight-bold is-size-7 is-vcentered">${statusText}</td>
                </tr>
            `);
        });
        $('#libraryContainer').append(table);
    }



    function applyFilters() {
        const query = ($('#navbarSearch').val() || '').toLowerCase();
        const gender = $('#filterGender').val();
        const tag = $('#filterTag').val();

        // Specific button filters
        const showOnlyBase = $('#btnFilterPendingBase').hasClass('is-primary');
        const showOnlyUpdates = $('#btnFilterPendingUpd').hasClass('is-primary');
        const showOnlyDlcs = $('#btnFilterPendingDlc').hasClass('is-primary');

        filteredGames = games.filter(g => {
            if (!g) return false;
            const gName = g.name || '';
            const gId = g.id || '';
            const matchesSearch = !query || gName.toLowerCase().includes(query) || gId.toLowerCase().includes(query);
            const matchesGender = !gender || (g.category && g.category.includes(gender));
            const matchesTag = !tag || (g.tags && g.tags.includes(tag));

            let matchesStatus = true;
            if (showOnlyBase) matchesStatus = matchesStatus && !g.has_base;
            if (showOnlyUpdates) matchesStatus = matchesStatus && (g.has_base && !g.has_latest_version);
            if (showOnlyDlcs) matchesStatus = matchesStatus && (g.has_base && !g.has_all_dlcs);

            return matchesSearch && matchesGender && matchesTag && matchesStatus;
        });

        // Apply Sorting
        filteredGames.sort((a, b) => {
            const [field, order] = currentSort.split('-');
            let comparison = 0;

            if (field === 'name') {
                comparison = (a.name || '').localeCompare(b.name || '');
            } else if (field === 'release') {
                const dateA = String(a.release_date || a.latest_release_date || '0000-00-00');
                const dateB = String(b.release_date || b.latest_release_date || '0000-00-00');
                comparison = dateA.localeCompare(dateB);
                if (comparison === 0) {
                    comparison = (a.name || '').localeCompare(b.name || '');
                }
            } else if (field === 'added') {
                comparison = (a.added_at || 0) - (b.added_at || 0);
            } else if (field === 'id') {
                comparison = (a.id || '').localeCompare(b.id || '');
            } else if (field === 'status') {
                comparison = (a.status_score || 0) - (b.status_score || 0);
                if (comparison === 0) {
                    comparison = (a.name || '').localeCompare(b.name || '');
                }
            }

            return order === 'asc' ? comparison : -comparison;
        });

        $('#totalItemsCount, #totalItemsCountMobile').text(`${filteredGames.length} Jogos`);
        currentPage = 1;
        renderLibrary();
    }


    function clearFilters() {
        $('#navbarSearch').val('');
        $('#filterGender').val('');
        $('#filterTag').val('');
        $('#btnFilterPendingBase, #btnFilterPendingUpd, #btnFilterPendingDlc').removeClass('is-primary').addClass('is-light');
        applyFilters();
    }

    $('#btnFilterPendingBase').on('click', function () {
        $(this).toggleClass('is-primary is-light');
        if ($(this).hasClass('is-primary')) {
            $('#btnFilterPendingUpd, #btnFilterPendingDlc').removeClass('is-primary').addClass('is-light');
        }
        applyFilters();
    });

    $('#btnFilterPendingUpd').on('click', function () {
        $(this).toggleClass('is-primary is-light');
        if ($(this).hasClass('is-primary')) {
            $('#btnFilterPendingBase, #btnFilterPendingDlc').removeClass('is-primary').addClass('is-light');
        }
        applyFilters();
    });

    $('#btnFilterPendingDlc').on('click', function () {
        $(this).toggleClass('is-primary is-light');
        if ($(this).hasClass('is-primary')) {
            $('#btnFilterPendingBase, #btnFilterPendingUpd').removeClass('is-primary').addClass('is-light');
        }
        applyFilters();
    });



    function setPageSize(size) {
        pageSize = size;
        localStorage.setItem('pageSize', size);
        currentPage = 1;
        updatePageSizeButtons();
        renderLibrary();
    }

    function updatePageSizeButtons() {
        $('.btn-page-size').removeClass('is-primary');
        $(`.btn-page-size[data-size="${pageSize}"]`).addClass('is-primary');
    }

    function goToPage(page) {
        const totalPages = Math.ceil(filteredGames.length / pageSize) || 1;
        if (page === -1) currentPage = totalPages;
        else currentPage = page;
        renderLibrary();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function changePage(delta) {
        const totalPages = Math.ceil(filteredGames.length / pageSize) || 1;
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderLibrary();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    let fileToDeleteId = null;
    let fileToDeleteTitleId = null;



    function updatePagination() {
        const totalPages = Math.ceil(filteredGames.length / pageSize) || 1;
        $('#btnFirst').toggleClass('is-disabled', currentPage === 1);
        $('#btnPrev').toggleClass('is-disabled', currentPage === 1);
        $('#btnNext').toggleClass('is-disabled', currentPage === totalPages);
        $('#btnLast').toggleClass('is-disabled', currentPage === totalPages);

        $('#paginationSummary').html(`
            <li><span class="pagination-link is-current bg-primary shadow-sm border-none">Página ${currentPage} de ${totalPages}</span></li>
            <li class="ml-4 is-size-7 opacity-50 has-text-weight-bold">(${filteredGames.length} itens)</li>
        `);
    }

    // Event Listeners
    $('.filterInput').on('change', applyFilters);
    $('#navbarSearch').on('input', applyFilters);

    // Sorting dropdown toggle
    $('#sortDropdown .dropdown-trigger button').on('click', function (e) {
        e.stopPropagation();
        $('#sortDropdown').toggleClass('is-active');
        $('#filterDropdown').removeClass('is-active');
    });

    // Filter dropdown toggle
    $('#filterDropdown .dropdown-trigger button').on('click', function (e) {
        e.stopPropagation();
        $('#filterDropdown').toggleClass('is-active');
        $('#sortDropdown').removeClass('is-active');
    });

    $(document).on('click', () => {
        $('#filterDropdown').removeClass('is-active');
        $('#sortDropdown').removeClass('is-active');
    });

    $('.sort-option').on('click', function () {
        currentSort = $(this).data('sort');
        localStorage.setItem('myfoil_library_sort', currentSort);
        $('.sort-option').removeClass('is-active has-text-weight-bold');
        $(this).addClass('is-active has-text-weight-bold');
        $('#sortDropdown').removeClass('is-active');
        applyFilters();
    });

    // Mark current sort as active on load
    $(document).ready(() => {
        $(`.sort-option[data-sort="${currentSort}"]`).addClass('is-active has-text-weight-bold');
    });

    // Modal closers
    $('.modal-background').on('click', () => {
        closeModal('gameDetailsModal');
        closeModal('editMetadataModal');
    });




    {% endraw %}
</script>

<script>

    // Initialize empty
    games = [];
    filteredGames = [];

    // Fetch games from API
    // Fetch games from API
    $(document).ready(() => {
        // 1. Try to load from cache first
        const cached = localStorage.getItem('myfoil_library_cache');
        if (cached) {
            try {
                games = JSON.parse(cached);
                initGenders(games);
                initTags(games);
                filteredGames = [...games];
                applyFilters(); // Render cached data immediately
            } catch (e) {
                console.error("Cache parse error", e);
            }
        } else {
            const loadingHtml = `
            <div class="column is-12 has-text-centered p-6">
                <span class="loader is-loading is-inline-block" style="width: 3rem; height: 3rem; border-width: 3px;"></span>
                <p class="mt-4 is-size-6 has-text-weight-bold opacity-60">Carregando Biblioteca...</p>
            </div>
            `;
            $('#libraryContainer').html(loadingHtml);
        }

        // 2. Fetch fresh data
        refreshLibrary();

        // Initialize zoom from localStorage
        const savedZoom = localStorage.getItem('gridZoom') || 240;
        $('#gridZoom').val(savedZoom);
        updateGridZoom(savedZoom);

        // Initialize pageSize from localStorage
        pageSize = parseInt(localStorage.getItem('pageSize')) || 24;
        updatePageSizeButtons();

        // Populated globally outside raw block
        setView(currentView);
    });


</script>

{% endblock %}