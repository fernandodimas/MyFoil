{% extends "base.html" %}

{% block content %}
{% include 'nav.html' %}

<section class="section">
    <div class="container is-fluid px-5">


        <!-- Controls Row -->
        <div class="box p-2 mb-4 shadow-sm border-none bg-glass">
            <div class="is-flex is-flex-wrap-wrap is-align-items-center gap-2 px-1 py-1">

                <!-- Left Group: Primary Filters -->
                <div class="is-flex gap-2 is-justify-content-center-mobile is-flex-grow-1-mobile">
                    <!-- Filters Dropdown -->
                    <div class="dropdown" id="filterDropdown">
                        <div class="dropdown-trigger">
                            <button class="button is-primary is-small" aria-haspopup="true">
                                <span class="icon is-small"><i class="bi bi-funnel-fill"></i></span>
                                <span class="is-hidden-mobile ml-1">Filtros</span>
                                <span class="icon is-small ml-1 is-hidden-tablet"><i class="bi bi-caret-down-fill"
                                        style="font-size: 0.5rem"></i></span>
                            </button>
                        </div>
                        <div class="dropdown-menu" id="dropdown-menu" role="menu">
                            <div class="dropdown-content p-4" style="min-width: 260px;">
                                <div class="field mb-3">
                                    <label class="label is-size-7 opacity-70">Gênero</label>
                                    <div class="control">
                                        <div class="select is-small is-fullwidth">
                                            <select id="filterGender" class="filterInput">
                                                <option value="">Todos os Gêneros</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label is-size-7 opacity-70">Tag</label>
                                    <div class="control">
                                        <div class="select is-small is-fullwidth">
                                            <select id="filterTag" class="filterInput">
                                                <option value="">Todas as Tags</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sorting Dropdown -->
                    <div class="dropdown" id="sortDropdown">
                        <div class="dropdown-trigger">
                            <button class="button is-info is-small is-light" aria-haspopup="true">
                                <span class="icon is-small"><i class="bi bi-sort-down"></i></span>
                                <span class="is-hidden-mobile ml-1">Ordenar</span>
                            </button>
                        </div>
                        <div class="dropdown-menu" id="sort-menu" role="menu">
                            <div class="dropdown-content p-2" style="min-width: 200px;">
                                <a class="dropdown-item is-size-7 sort-option" data-sort="name-asc">A-Z (Nome)</a>
                                <a class="dropdown-item is-size-7 sort-option" data-sort="name-desc">Z-A (Nome)</a>
                                <hr class="dropdown-divider">
                                <a class="dropdown-item is-size-7 sort-option" data-sort="release-desc">Lançamento
                                    (Novo)</a>
                                <a class="dropdown-item is-size-7 sort-option" data-sort="release-asc">Lançamento
                                    (Antigo)</a>
                                <hr class="dropdown-divider">
                                <a class="dropdown-item is-size-7 sort-option" data-sort="added-desc">Adicionado
                                    Recentemente</a>
                                <a class="dropdown-item is-size-7 sort-option" data-sort="added-asc">Adicionado
                                    Antigamente</a>
                                <hr class="dropdown-divider">
                                <a class="dropdown-item is-size-7 sort-option" data-sort="id-asc">Title ID
                                    (Crescente)</a>
                                <a class="dropdown-item is-size-7 sort-option" data-sort="status-desc">Status de
                                    Atualização</a>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Status Filters -->
                    <div class="buttons has-addons m-0">
                        <button class="button is-small is-light" id="btnFilterPendingBase" title="Falta Arquivo Base">
                            <span class="icon is-small"><i class="bi bi-disc"></i></span>
                            <span class="is-hidden-mobile ml-1">Base</span>
                        </button>
                        <button class="button is-small is-light" id="btnFilterPendingUpd" title="Pendente Atualização">
                            <span class="icon is-small"><i class="bi bi-arrow-up-circle"></i></span>
                            <span class="is-hidden-mobile ml-1">Update</span>
                        </button>
                        <button class="button is-small is-light" id="btnFilterPendingDlc" title="Pendente DLC">
                            <span class="icon is-small"><i class="bi bi-plus-circle"></i></span>
                            <span class="is-hidden-mobile ml-1">DLC</span>
                        </button>
                    </div>

                    <button class="button is-small is-outlined is-danger" onclick="clearFilters()"
                        title="Limpar Filtros">
                        <span class="icon is-small"><i class="bi bi-x"></i></span>
                    </button>
                </div>

                <!-- Right Group: Secondary Controls (Pushed to the right on desktop) -->
                <div class="is-flex gap-3 is-align-items-center is-justify-content-center-mobile is-flex-grow-1-mobile"
                    style="margin-left: auto;">
                    <div class="is-hidden-mobile">
                        <span class="is-size-7 opacity-50 font-mono" id="totalItemsCount">-- itens</span>
                    </div>

                    <div class="is-flex is-align-items-center is-hidden-mobile" style="min-width: 100px;">
                        <i class="bi bi-zoom-in is-size-7 mr-2 opacity-50"></i>
                        <input id="gridZoom" class="slider is-small is-primary m-0" type="range" min="180" max="400"
                            step="10" value="240" oninput="updateGridZoom(this.value)">
                    </div>

                    <div class="buttons has-addons m-0" id="viewToggleButtons">
                        <button class="button is-small p-2" onclick="setView('card')" id="btnViewCard" title="Grade"><i
                                class="bi bi-grid-fill"></i></button>
                        <button class="button is-small p-2" onclick="setView('icon')" id="btnViewIcon" title="Ícones"><i
                                class="bi bi-image"></i></button>
                        <button class="button is-small p-2" onclick="setView('list')" id="btnViewList" title="Lista"><i
                                class="bi bi-list-ul"></i></button>
                    </div>
                </div>

                <div class="is-hidden-tablet is-flex-grow-1 has-text-centered">
                    <span class="is-size-7 opacity-50" id="totalItemsCountMobile">-- itens</span>
                </div>
            </div>
        </div>

        <!-- Library Content -->
        <div id="libraryContainer" class="columns is-multiline is-variable is-3">
            <!-- Dynamic content injected via JS -->
        </div>

        <!-- No Results -->
        <div id="noResults" class="is-hidden has-text-centered py-6">
            <div class="notification is-light">
                <i class="bi bi-search is-size-1 opacity-20 block mb-4"></i>
                <h3 class="title is-4">Nenhum jogo encontrado</h3>
                <p class="subtitle is-6 opacity-50">Tente ajustar seus filtros ou verifique as configurações.</p>
            </div>
        </div>

        <!-- Pagination -->
        <nav class="pagination is-centered mt-6" role="navigation" aria-label="pagination">
            <a class="pagination-previous" id="btnFirst" onclick="goToPage(1)">Primeira</a>
            <a class="pagination-previous" id="btnPrev" onclick="changePage(-1)">Anterior</a>
            <a class="pagination-next" id="btnNext" onclick="changePage(1)">Próxima</a>
            <a class="pagination-next" id="btnLast" onclick="goToPage(-1)">Última</a>
            <ul class="pagination-list" id="paginationSummary">
                <!-- Injected via JS -->
            </ul>
        </nav>

        <div class="level mt-4 is-mobile">
            <div class="level-left"></div>
            <div class="level-right">
                <div class="level-item">
                    <span class="is-size-7 mr-2 opacity-50">Itens por página:</span>
                    <div class="buttons has-addons">
                        <button class="button is-small p-2 btn-page-size" data-size="24"
                            onclick="setPageSize(24)">24</button>
                        <button class="button is-small p-2 btn-page-size" data-size="48"
                            onclick="setPageSize(48)">48</button>
                        <button class="button is-small p-2 btn-page-size" data-size="96"
                            onclick="setPageSize(96)">96</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<!-- Page Content follows -->


<!-- Game Details Modal -->
<div class="modal" id="gameDetailsModal">
    <div class="modal-background"></div>
    <div class="modal-card" style="max-height: 90vh; overflow: hidden; border-radius: 12px;">
        <section class="modal-card-body p-0 overflow-y-auto" id="modalContent">
            <!-- Injected via JS -->
        </section>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal" id="confirmDeleteModal" style="z-index: 9999;">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head has-background-danger-dark border-none">
            <p class="modal-card-title has-text-white has-text-weight-bold">Confirmar Exclusão</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <div class="content has-text-centered p-4">
                <i class="bi bi-exclamation-triangle-fill has-text-danger is-size-1 mb-3"></i>
                <p class="is-size-5 has-text-weight-medium">Tem certeza que deseja excluir este arquivo?</p>
                <p class="is-size-6 opacity-70">Esta ação removerá o arquivo permanentemente do seu disco. Não pode ser
                    desfeita.</p>
            </div>
        </section>
        <footer class="modal-card-foot border-none is-justify-content-center">
            <button class="button is-danger px-6" id="btnConfirmDelete" onclick="confirmDeleteFile()">Excluir</button>
            <button class="button close-modal">Cancelar</button>
        </footer>
    </div>
</div>

<style>
    .gap-4 {
        gap: 1rem;
    }

    .gap-2 {
        gap: 0.5rem;
    }

    .mb-6 {
        margin-bottom: 1.5rem;
    }

    .mr-2 {
        margin-right: 0.5rem;
    }

    .ml-2 {
        margin-left: 0.5rem;
    }

    .p-0 {
        padding: 0 !important;
    }

    .border-top {
        border-top: 1px solid rgba(0, 0, 0, 0.05);
    }

    .border-success-soft {
        border: 1px solid rgba(72, 199, 142, 0.2);
    }

    .border-warning-soft {
        border: 1px solid rgba(255, 221, 87, 0.3);
    }

    .border-danger-soft {
        border: 1px solid rgba(241, 70, 104, 0.2);
    }

    .game-card {
        height: 100%;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .game-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    }

    .card-image img {
        transition: transform 0.3s;
    }

    .game-card:hover .card-image img {
        transform: scale(1.05);
    }

    #libraryContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(var(--card-width, 240px), 1fr));
        gap: 1.25rem;
    }

    #libraryContainer.is-list-view {
        display: block;
    }

    @media screen and (min-width: 1600px) {
        .container.is-fluid {
            max-width: 1550px !important;
            margin: 0 auto !important;
        }
    }

    @media screen and (min-width: 1920px) {
        .container.is-fluid {
            max-width: 1850px !important;
            margin: 0 auto !important;
        }
    }

    @media screen and (min-width: 769px) {
        .modal-card {
            width: 800px;
        }
    }

    @media screen and (min-width: 1216px) {
        .modal-card {
            width: 1000px;
        }
    }

    @media screen and (min-width: 1408px) {
        .modal-card {
            width: 1250px;
        }
    }

    .dlc-tag {
        display: inline-flex !important;
        align-items: center;
        height: auto !important;
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
        line-height: 1.25 !important;
    }

    .truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    @media screen and (max-width: 768px) {
        .is-flex-grow-1-mobile {
            flex-grow: 1 !important;
        }

        .is-justify-content-center-mobile {
            justify-content: center !important;
        }
    }

    .game-card {
        display: flex;
        flex-direction: column;
        height: 100%;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(0, 0, 0, 0.05);
        background: #fff;
    }

    .card-image img {
        transition: transform 0.3s;
        background-color: #f5f5f5;
        /* Fallback color for missing banners */
    }

    .game-card:hover .card-image img {
        transform: scale(1.02);
    }

    .bg-light-soft {
        background: #fafafa;
    }

    .border-none {
        border: none !important;
    }

    .hover-bg-light:hover {
        background: #f5f5f5;
    }

    .rounded {
        border-radius: 4px;
    }

    .break-word {
        word-wrap: break-word;
        word-break: break-all;
        overflow-wrap: break-word;
    }

    #modalTitle {
        word-break: break-word;
    }

    .opacity-10 {
        opacity: 0.1;
    }

    .opacity-20 {
        opacity: 0.2;
    }

    .opacity-30 {
        opacity: 0.3;
    }

    .opacity-50 {
        opacity: 0.5;
    }

    .opacity-60 {
        opacity: 0.6;
    }

    .opacity-70 {
        opacity: 0.7;
    }

    .opacity-80 {
        opacity: 0.8;
    }
</style>

<script>
    {% raw %}

    let games = [];
    let filteredGames = [];
    let currentPage = 1;
    let pageSize = 24;
    let currentSort = localStorage.getItem('myfoil_library_sort') || 'name-asc';
    let currentView = localStorage.getItem('viewMode') || 'card';


    // Helper functions
    const openModal = (id) => $(`#${id}`).addClass('is-active');
    const closeModal = (id) => $(`#${id}`).removeClass('is-active');

    function initGenders(gamesList) {
        const genders = new Set();
        gamesList.forEach(g => {
            if (g && g.category && Array.isArray(g.category)) {
                g.category.forEach(c => genders.add(c));
            }
        });

        const currentVal = $('#filterGender').val();
        const genderSelect = $('#filterGender').empty().append(`<option value="">${t('All Genres')}</option>`);
        Array.from(genders).sort().forEach(g => genderSelect.append(new Option(g, g)));
        if (currentVal) $('#filterGender').val(currentVal);
    }

    function initTags(gamesList) {
        const tags = new Set();
        gamesList.forEach(g => {
            if (g && g.tags && Array.isArray(g.tags)) {
                g.tags.forEach(t => tags.add(t));
            }
        });

        const currentVal = $('#filterTag').val();
        const tagSelect = $('#filterTag').empty().append(`<option value="">${t('All Tags')}</option>`);
        Array.from(tags).sort().forEach(t => tagSelect.append(new Option(t, t)));
        if (currentVal) $('#filterTag').val(currentVal);
    }


    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + K: Focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            $('#navbarSearch').focus();
        }

        // ESC: Close all modals
        if (e.key === 'Escape') {
            $('.modal').removeClass('is-active');
        }

        // Arrow keys for pagination if search is not focused
        if (document.activeElement.id !== 'navbarSearch') {
            if (e.key === 'ArrowLeft' && currentPage > 1) {
                changePage(currentPage - 1);
            } else if (e.key === 'ArrowRight' && currentPage < Math.ceil(filteredGames.length / pageSize)) {
                changePage(currentPage + 1);
            }
        }
    });

    function setView(view) {
        currentView = view;
        localStorage.setItem('viewMode', view);
        $('#viewToggleButtons .button').removeClass('is-primary');
        $(`#btnView${view.charAt(0).toUpperCase() + view.slice(1)}`).addClass('is-primary');
        renderLibrary();
    }

    function updateGridZoom(val) {
        document.documentElement.style.setProperty('--card-width', `${val}px`);
        localStorage.setItem('gridZoom', val);
    }

    function renderLibrary() {
        const container = $('#libraryContainer').empty();
        const start = (currentPage - 1) * pageSize;
        const paged = filteredGames.slice(start, start + pageSize);

        $('#noResults').toggleClass('is-hidden', paged.length > 0);

        // Handle list view width
        if (currentView === 'list') {
            container.addClass('is-list-view');
        } else {
            container.removeClass('is-list-view');
        }

        if (currentView === 'card') renderCardView(paged);
        else if (currentView === 'icon') renderIconView(paged);
        else renderListView(paged);

        updatePagination();
    }

    function refreshLibrary() {
        console.log("Refreshing library data...");
        $.getJSON('/api/library', function (data) {
            games = data || [];
            localStorage.setItem('myfoil_library_cache', JSON.stringify(games));
            initGenders(games);
            initTags(games);

            // If we're on page 1, we can just apply filters to refresh everything
            // but if we're on another page, we might want to stay there
            // For simplicity, let's just apply filters which will trigger renderLibrary
            applyFilters();
            showToast(t('Library updated!'), 'success');
        });
    }

    function renderCardView(items) {
        items.forEach(game => {
            const statusDotClass = game.status_color === 'orange' ? 'bg-orange' : (game.status_color === 'green' ? 'bg-green' : 'bg-gray');
            const card = $(`
                <div class="grid-item">
                    <div class="card game-card is-paddingless is-shadowless" onclick="showGameDetails('${game.id}')">
                        <div class="card-image position-relative overflow-hidden">
                            <figure class="image is-16by9">
                                <img src="${game.bannerUrl || game.iconUrl || '/static/img/no-icon.png'}" alt="${game.name}" style="object-fit: cover;">
                            </figure>
                        </div>
                        <div class="card-content p-3">
                            <div class="is-flex is-justify-content-between is-align-items-start is-flex-wrap-wrap mb-2" style="gap: 4px;">
                                <span class="tag is-white p-0 font-mono is-size-7 opacity-40" style="height: auto; line-height: 1.2;">${game.id}</span>
                                <span class="tag is-white p-0 font-mono is-size-7 has-text-weight-bold has-text-primary" style="height: auto; line-height: 1.2; margin-left: auto;">v${game.display_version}</span>
                            </div>
                            
                            <p class="is-size-6 has-text-weight-bold mb-3 truncate" title="${game.name}">${game.name}</p>
                            
                            <div class="is-flex is-justify-content-between is-align-items-center">
                                <div class="is-flex is-align-items-center gap-1">
                                    <span class="status-dot ${statusDotClass}"></span>
                                    <span class="is-size-7 opacity-70 font-mono" title="Tamanho em disco">${game.size_formatted || '--'}</span>
                                </div>
                                <div class="is-flex gap-1 is-justify-content-end">
                                    ${!game.has_latest_version && game.has_base ? '<span class="tag is-warning is-light is-small has-text-weight-bold" style="font-size: 0.6rem; height: 1.1rem; border: 1px solid rgba(255,193,7,0.3)">UPDATE</span>' : ''}
                                    ${!game.has_all_dlcs && game.has_base ? '<span class="tag is-warning is-light is-small has-text-weight-bold" style="font-size: 0.6rem; height: 1.1rem; border: 1px solid rgba(255,193,7,0.3)">DLC</span>' : ''}
                                    ${game.has_redundant_updates ? '<span class="tag is-danger is-light is-small has-text-weight-bold" style="font-size: 0.6rem; height: 1.1rem; border: 1px solid rgba(255,56,96,0.3)" title="Updates redundantes detectados">X-UPD</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            $('#libraryContainer').append(card);
        });
    }

    function renderIconView(items) {
        items.forEach(game => {
            const statusDotClass = game.status_color === 'orange' ? 'bg-orange' : (game.status_color === 'green' ? 'bg-green' : 'bg-gray');
            const card = $(`
                <div class="grid-item">
                    <div class="card game-card is-paddingless is-shadowless" onclick="showGameDetails('${game.id}')" title="${game.name}">
                        <div class="card-image">
                            <figure class="image is-square bg-light relative">
                                <img src="${game.iconUrl || '/static/img/no-icon.png'}" alt="${game.name}" class="p-0" loading="lazy">
                                <div class="status-indicator position-absolute" style="bottom: 5px; right: 5px;">
                                    <span class="status-dot ${statusDotClass}"></span>
                                </div>
                            </figure>
                        </div>
                    </div>
                </div>
            `);
            $('#libraryContainer').append(card);
        });
    }

    function renderListView(items) {
        const table = $(`
            <div class="column is-12" style="width: 100%;">
                <div class="table-container box is-paddingless shadow-sm overflow-hidden border-none">
                    <table class="table is-fullwidth is-hoverable game-list-table mb-0">
                        <thead>
                            <tr class="has-background-light-soft" style="border-bottom: 2px solid #7c3aed">
                                <th width="65" class="has-text-centered p-1">Ícone</th>
                                <th>Título do Jogo</th>
                                <th width="140">Title ID</th>
                                <th width="80" class="has-text-centered">Versão</th>
                                <th class="is-hidden-mobile" width="100">Tamanho</th>
                                <th class="is-hidden-mobile" width="100">Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        `);
        items.forEach(game => {
            const statusColor = game.status_color === 'orange' ? 'has-text-warning' : (game.status_color === 'green' ? 'has-text-success' : 'has-text-grey');
            const statusText = game.status_color === 'orange' ? t('Missing') : (game.status_color === 'green' ? t('Owned') : t('Incomplete'));

            table.find('tbody').append(`
                <tr onclick="showGameDetails('${game.id || game.title_id}')">
                    <td class="p-1 has-text-centered"><img src="${game.iconUrl || '/static/img/no-icon.png'}" style="width: 32px; height: 32px; border-radius: 4px; object-fit: cover;"></td>
                    <td class="is-vcentered">
                        <strong class="is-size-7-mobile">${game.name || 'Unknown'}</strong>
                        ${game.has_redundant_updates ? '<span class="tag is-danger is-light is-small ml-2 has-text-weight-bold" style="font-size: 0.6rem;">X-UPD</span>' : ''}
                    </td>
                    <td class="font-mono is-size-7 is-vcentered">${game.id || game.title_id || '--'}</td>
                    <td class="is-vcentered has-text-centered"><span class="tag is-light is-small">v${game.display_version || '0'}</span></td>
                    <td class="is-hidden-mobile is-vcentered font-mono is-size-7">${game.size_formatted || '--'}</td>
                    <td class="is-hidden-mobile ${statusColor} has-text-weight-bold is-size-7 is-vcentered">${statusText}</td>
                </tr>
            `);
        });
        $('#libraryContainer').append(table);
    }

    function showGameDetails(id) {
        $.getJSON(`/api/app_info/${id}`, (game) => {
            $('#modalTitle').text(game.name);

            // Base Files Section
            let filesHtml = game.files && game.files.length > 0 ? `
                <div class="mb-5">
                    <p class="heading has-text-weight-bold mb-3 has-text-primary">Arquivos Base Encontrados (${game.files.length})</p>
                    ${game.files.map(f => `
                        <div class="box is-shadowless border p-3 mb-2 bg-light-soft">
                            <div class="columns is-vcentered is-mobile is-gapless">
                                <div class="column">
                                    <p class="is-size-7 has-text-weight-bold break-word" title="${f.filename}">${f.filename}</p>
                                    <p class="is-size-7 opacity-50 break-word" title="${f.filepath}">${f.filepath}</p>
                                </div>
                                <div class="column is-narrow ml-2 is-flex align-items-center">
                                    <span class="tag is-light font-mono mr-2">${f.size_formatted || '--'}</span>
                                    <a href="/api/get_game/${f.id}" class="button is-primary is-small mr-1" title="Download">
                                        <span class="icon is-small"><i class="bi bi-download"></i></span>
                                    </a>
                                    <button class="button is-danger is-small is-light" onclick="deleteGameFile(${f.id}, '${game.id}')" title="Excluir Arquivo">
                                        <span class="icon is-small"><i class="bi bi-trash-fill"></i></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : (game.has_base ? `<p class="notification is-warning is-light p-2 is-size-7" style="border: 1px solid rgba(0,0,0,0.1)">${t('Missing Base File')}</p>` : '');

            // Updates Section
            const sortedUpdates = [...(game.updates || [])].sort((a, b) => b.version - a.version);
            let updatesHtml = '';

            if (sortedUpdates.length === 0) {
                updatesHtml = `
                    <div class="mb-5">
                        <p class="heading has-text-weight-bold mb-3 has-text-link">${t('Updates')}</p>
                        <p class="is-size-7 opacity-50 italic">${t('No DLCs or Updates available')}</p>
                    </div>
                `;
            } else {
                const latest = sortedUpdates[0];
                const others = sortedUpdates.slice(1);

                const renderUpdateRow = (u) => {
                    const file = u.files && u.files.length > 0 ? u.files[0] : null;
                    const isRedundant = u !== latest && game.updates.length > 1; // Check if it's not the latest and there are other updates
                    return `
                        <tr>
                            <td class="has-text-weight-bold">v${u.version}</td>
                            <td class="opacity-70">${u.release_date || '--'}</td>
                            <td class="has-text-centered">
                                ${u.owned && file ? `
                                    <div class="field is-grouped is-grouped-centered is-align-items-center">
                                        <span class="tag is-light font-mono mr-2 is-hidden-mobile">${file.size_formatted || '--'}</span>
                                        ${isRedundant ? '<span class="tag is-danger is-light is-small mr-1 has-text-weight-bold" style="font-size: 0.6rem;">REDUNDANTE</span>' : ''}
                                        <p class="control">
                                            <a href="/api/get_game/${file.id}" class="button is-primary is-small" title="Download">
                                                <i class="bi bi-download"></i>
                                            </a>
                                        </p>
                                        <p class="control">
                                            <button class="button is-danger is-small is-light" onclick="deleteGameFile(${file.id}, '${game.id}')" title="Excluir">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </p>
                                    </div>
                                ` : (u.owned ? '<span class="tag is-warning is-light is-small">Erro</span>' : '<span class="tag is-danger is-light is-small">Falta</span>')}
                            </td>
                        </tr>
                    `;
                };

                updatesHtml = `
                    <div class="mb-5">
                        <div class="is-flex is-justify-content-between is-align-items-center mb-3">
                            <p class="heading has-text-weight-bold has-text-link mb-0">Histórico de Atualizações</p>
                            ${others.length > 0 ? `<button class="button is-ghost is-small p-0" onclick="$('#otherUpdates').toggleClass('is-hidden'); $(this).find('i').toggleClass('bi-chevron-down bi-chevron-up')">
                                <span class="is-size-7 mr-1 text-primary">${others.length} mais</span>
                                <i class="bi bi-chevron-down text-primary"></i>
                            </button>` : ''}
                        </div>
                        <div class="table-container">
                            <table class="table is-narrow is-fullwidth is-size-7">
                                <thead>
                                    <tr>
                                        <th>Versão</th>
                                        <th>Lançamento</th>
                                        <th class="has-text-centered">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${renderUpdateRow(latest)}
                                </tbody>
                                <tbody id="otherUpdates" class="is-hidden">
                                    ${others.map(u => renderUpdateRow(u)).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // DLCs Section
            let dlcsHtml = game.dlcs && game.dlcs.length > 0 ? `
                <div class="mb-5">
                    <p class="heading has-text-weight-bold mb-3 has-text-success">Conteúdo Adicional (DLCs)</p>
                    <div class="table-container">
                        <table class="table is-narrow is-fullwidth is-size-7">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>ID</th>
                                    <th class="has-text-centered">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${game.dlcs.map(d => {
                const file = d.files && d.files.length > 0 ? d.files[0] : null;
                return `
                                    <tr>
                                        <td class="has-text-weight-bold" onclick="showGameDetails('${d.app_id}')" style="cursor: pointer; color: inherit;" title="Ver detalhes desta DLC">${d.name}</td>
                                        <td class="opacity-50 font-mono">${d.app_id}</td>
                                        <td class="has-text-centered">
                                            ${d.owned && file ? `
                                                <div class="field is-grouped is-grouped-centered is-align-items-center">
                                                    <span class="tag is-light font-mono mr-2 is-hidden-mobile">${file.size_formatted || '--'}</span>
                                                    <p class="control">
                                                        <a href="/api/get_game/${file.id}" class="button is-primary is-light is-small" title="Download">
                                                            <i class="bi bi-download"></i>
                                                        </a>
                                                    </p>
                                                    <p class="control">
                                                        <button class="button is-danger is-small is-light" onclick="deleteGameFile(${file.id}, '${game.id}')" title="Excluir">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </p>
                                                </div>
                                            ` : (d.owned ? '<span class="tag is-warning is-light is-small">Erro</span>' : '<span class="tag is-danger is-light is-small">Falta</span>')}
                                        </td>
                                    </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            ` : '';

            let content = `
                <div class="modal-banner-container" style="position: relative; height: 240px; overflow: hidden; background: #1a1a1a;">
                    <img src="${game.bannerUrl || game.iconUrl || '/static/img/no-icon.png'}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.6; filter: blur(2px);">
                    <button class="delete is-large" aria-label="close" onclick="closeModal('gameDetailsModal')" style="position: absolute; top: 1.5rem; right: 1.5rem; background-color: rgba(255,255,255,0.2); backdrop-filter: blur(8px); z-index: 20; border: 1px solid rgba(255,255,255,0.1);"></button>
                </div>
                <div class="p-6">
                    <div class="columns is-variable is-6">
                        <div class="column is-4">
                            <figure class="image is-square box p-0 shadow-lg overflow-hidden mb-5" style="margin-top: -100px; position: relative; z-index: 15; border: 4px solid #fff; border-radius: 12px; transition: transform 0.3s ease;">
                                <img src="${game.iconUrl || '/static/img/no-icon.png'}" alt="Icon" style="height: 100%; width: 100%; object-fit: cover;">
                            </figure>
                            <div class="box p-4 is-shadowless border bg-light-soft" style="border-radius: 12px;">
                                <div class="mb-3">
                                    <p class="is-size-7 heading mb-1 opacity-50">Publisher</p>
                                    <p class="is-size-6 has-text-weight-bold">${game.publisher || '--'}</p>
                                </div>
                                <div class="mb-3">
                                    <p class="is-size-7 heading mb-1 opacity-50">Lançamento</p>
                                    <p class="is-size-6">${game.release_date || '--'}</p>
                                </div>
                                <div class="mb-3">
                                    <p class="is-size-7 heading mb-1 opacity-50">Versão</p>
                                    <p class="is-size-6"><span class="tag is-info is-light has-text-weight-bold">v${game.display_version}</span></p>
                                </div>
                                <div class="mb-3">
                                    <p class="is-size-7 heading mb-1 opacity-50">Total em Disco</p>
                                    <p class="is-size-6 has-text-weight-bold font-mono">${game.size_formatted || '--'}</p>
                                </div>
                                <div>
                                    <p class="is-size-7 heading mb-1 opacity-50">${t('Genre')}</p>
                                    <div class="tags">
                                        ${Array.isArray(game.category) ? game.category.map(c => `<span class="tag is-small is-light">${c}</span>`).join('') : `<span class="tag is-small is-light">${game.category || '--'}</span>`}
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <a href="${window.currentLocale === 'pt_BR' ? 'https://www.nintendo.com/pt-br/search/#q=' + encodeURIComponent(game.name) : 'https://www.nintendo.com/us/search/#q=' + encodeURIComponent(game.name)}" target="_blank" class="button is-small is-light is-fullwidth" style="border-color: #e60012; color: #e60012;">
                                        <span class="icon"><i class="bi bi-shop"></i></span>
                                        <span>eShop</span>
                                    </a>
                                </div>
                                <hr class="my-4 opacity-5">
                                <div class="mb-3">
                                    <p class="is-size-7 heading mb-1 opacity-50">${t('Custom Tags')}</p>
                                    <div id="gameModalTags" class="tags mb-2">
                                        <!-- Tags will be loaded here -->
                                    </div>
                                    <div class="field has-addons">
                                        <div class="control is-expanded">
                                            <div class="select is-small is-fullwidth">
                                                <select id="modalAddTagSelect">
                                                    <option value="">${t('Add Tag...')}</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="control">
                                            <button class="button is-small is-primary" onclick="addTagToGame('${game.id}')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <hr class="my-4 opacity-5">
                                <div class="wishlist-section">
                                    <button id="btnWishlist" class="button is-fullwidth is-small is-light" onclick="toggleWishlist('${game.id}')">
                                        <span class="icon"><i class="bi bi-heart"></i></span>
                                        <span>${t('Wishlist')}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="column is-8">
                            <div class="mb-6">
                                <h2 class="title is-3 mb-4" style="font-weight: 800; letter-spacing: -0.5px;">${game.name}</h2>
                                <div class="content is-size-6 opacity-80" style="line-height: 1.7;">
                                    ${game.description || t('No description available')}
                                </div>
                            </div>
                            
                            <hr class="my-5 opacity-10">
                            
                            <div class="details-sections mt-4">
                                ${filesHtml}
                                ${updatesHtml}
                                ${dlcsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $('#modalContent').html(content);
            loadGameTagsAndWishlist(game.id);
            openModal('gameDetailsModal');
        });
    }

    function applyFilters() {
        const query = ($('#navbarSearch').val() || '').toLowerCase();
        const gender = $('#filterGender').val();
        const tag = $('#filterTag').val();

        // Specific button filters
        const showOnlyBase = $('#btnFilterPendingBase').hasClass('is-primary');
        const showOnlyUpdates = $('#btnFilterPendingUpd').hasClass('is-primary');
        const showOnlyDlcs = $('#btnFilterPendingDlc').hasClass('is-primary');

        filteredGames = games.filter(g => {
            if (!g) return false;
            const gName = g.name || '';
            const gId = g.id || '';
            const matchesSearch = !query || gName.toLowerCase().includes(query) || gId.toLowerCase().includes(query);
            const matchesGender = !gender || (g.category && g.category.includes(gender));
            const matchesTag = !tag || (g.tags && g.tags.includes(tag));

            let matchesStatus = true;
            if (showOnlyBase) matchesStatus = matchesStatus && !g.has_base;
            if (showOnlyUpdates) matchesStatus = matchesStatus && (g.has_base && !g.has_latest_version);
            if (showOnlyDlcs) matchesStatus = matchesStatus && (g.has_base && !g.has_all_dlcs);

            return matchesSearch && matchesGender && matchesTag && matchesStatus;
        });

        // Apply Sorting
        filteredGames.sort((a, b) => {
            const [field, order] = currentSort.split('-');
            let comparison = 0;

            if (field === 'name') {
                comparison = (a.name || '').localeCompare(b.name || '');
            } else if (field === 'release') {
                const dateA = String(a.release_date || a.latest_release_date || '0000-00-00');
                const dateB = String(b.release_date || b.latest_release_date || '0000-00-00');
                comparison = dateA.localeCompare(dateB);
                if (comparison === 0) {
                    comparison = (a.name || '').localeCompare(b.name || '');
                }
            } else if (field === 'added') {
                comparison = (a.added_at || 0) - (b.added_at || 0);
            } else if (field === 'id') {
                comparison = (a.id || '').localeCompare(b.id || '');
            } else if (field === 'status') {
                comparison = (a.status_score || 0) - (b.status_score || 0);
                if (comparison === 0) {
                    comparison = (a.name || '').localeCompare(b.name || '');
                }
            }

            return order === 'asc' ? comparison : -comparison;
        });

        $('#totalItemsCount, #totalItemsCountMobile').text(`${filteredGames.length} Jogos`);
        currentPage = 1;
        renderLibrary();
    }


    function clearFilters() {
        $('#navbarSearch').val('');
        $('#filterGender').val('');
        $('#filterTag').val('');
        $('#btnFilterPendingBase, #btnFilterPendingUpd, #btnFilterPendingDlc').removeClass('is-primary').addClass('is-light');
        applyFilters();
    }

    $('#btnFilterPendingBase').on('click', function () {
        $(this).toggleClass('is-primary is-light');
        if ($(this).hasClass('is-primary')) {
            $('#btnFilterPendingUpd, #btnFilterPendingDlc').removeClass('is-primary').addClass('is-light');
        }
        applyFilters();
    });

    $('#btnFilterPendingUpd').on('click', function () {
        $(this).toggleClass('is-primary is-light');
        if ($(this).hasClass('is-primary')) {
            $('#btnFilterPendingBase, #btnFilterPendingDlc').removeClass('is-primary').addClass('is-light');
        }
        applyFilters();
    });

    $('#btnFilterPendingDlc').on('click', function () {
        $(this).toggleClass('is-primary is-light');
        if ($(this).hasClass('is-primary')) {
            $('#btnFilterPendingBase, #btnFilterPendingUpd').removeClass('is-primary').addClass('is-light');
        }
        applyFilters();
    });



    function setPageSize(size) {
        pageSize = size;
        localStorage.setItem('pageSize', size);
        currentPage = 1;
        updatePageSizeButtons();
        renderLibrary();
    }

    function updatePageSizeButtons() {
        $('.btn-page-size').removeClass('is-primary');
        $(`.btn-page-size[data-size="${pageSize}"]`).addClass('is-primary');
    }

    function goToPage(page) {
        const totalPages = Math.ceil(filteredGames.length / pageSize) || 1;
        if (page === -1) currentPage = totalPages;
        else currentPage = page;
        renderLibrary();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function changePage(delta) {
        const totalPages = Math.ceil(filteredGames.length / pageSize) || 1;
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderLibrary();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    let fileToDeleteId = null;
    let fileToDeleteTitleId = null;

    function deleteGameFile(fileId, titleId) {
        fileToDeleteId = fileId;
        fileToDeleteTitleId = titleId;
        $('#confirmDeleteModal').addClass('is-active');
    }

    function confirmDeleteFile() {
        if (!fileToDeleteId) return;

        const btnFn = $('#btnConfirmDelete');
        btnFn.addClass('is-loading');

        $.post(`/api/files/delete/${fileToDeleteId}`, (res) => {
            $('#confirmDeleteModal').removeClass('is-active');
            btnFn.removeClass('is-loading');

            if (res.success) {
                // Refresh modal info
                if (fileToDeleteTitleId) {
                    showGameDetails(fileToDeleteTitleId);

                    // Partial Update: Update specific game in the list without full reload
                    $.getJSON(`/api/app_info/${fileToDeleteTitleId}`, (updatedGame) => {
                        if (!updatedGame || !updatedGame.id) return; // Safety check

                        const idx = games.findIndex(g => g && g.id === fileToDeleteTitleId);
                        if (idx !== -1) {
                            games[idx] = updatedGame;
                            // Update local cache
                            localStorage.setItem('myfoil_library_cache', JSON.stringify(games));
                            applyFilters();
                        }
                    });
                }
                showToast('Arquivo excluído com sucesso.');
            } else {
                showToast('Erro ao excluir: ' + (res.error || 'Erro desconhecido'), 'error');
            }
            fileToDeleteId = null;
            fileToDeleteTitleId = null;
        });
    }

    function updatePagination() {
        const totalPages = Math.ceil(filteredGames.length / pageSize) || 1;
        $('#btnFirst').toggleClass('is-disabled', currentPage === 1);
        $('#btnPrev').toggleClass('is-disabled', currentPage === 1);
        $('#btnNext').toggleClass('is-disabled', currentPage === totalPages);
        $('#btnLast').toggleClass('is-disabled', currentPage === totalPages);

        $('#paginationSummary').html(`
            <li><span class="pagination-link is-current bg-primary shadow-sm border-none">Página ${currentPage} de ${totalPages}</span></li>
            <li class="ml-4 is-size-7 opacity-50 has-text-weight-bold">(${filteredGames.length} itens)</li>
        `);
    }

    // Event Listeners
    $('.filterInput').on('change', applyFilters);
    $('#navbarSearch').on('input', applyFilters);

    // Sorting dropdown toggle
    $('#sortDropdown .dropdown-trigger button').on('click', function (e) {
        e.stopPropagation();
        $('#sortDropdown').toggleClass('is-active');
        $('#filterDropdown').removeClass('is-active');
    });

    $(document).on('click', () => {
        $('#filterDropdown').removeClass('is-active');
        $('#sortDropdown').removeClass('is-active');
    });

    $('.sort-option').on('click', function () {
        currentSort = $(this).data('sort');
        localStorage.setItem('myfoil_library_sort', currentSort);
        $('.sort-option').removeClass('is-active has-text-weight-bold');
        $(this).addClass('is-active has-text-weight-bold');
        $('#sortDropdown').removeClass('is-active');
        applyFilters();
    });

    // Mark current sort as active on load
    $(document).ready(() => {
        $(`.sort-option[data-sort="${currentSort}"]`).addClass('is-active has-text-weight-bold');
    });

    // Modal closers
    $('.modal-background').on('click', () => closeModal('gameDetailsModal'));


    {% endraw %}
</script>

<script>

    // Initialize empty
    games = [];
    filteredGames = [];

    // Fetch games from API
    // Fetch games from API
    $(document).ready(() => {
        // 1. Try to load from cache first
        const cached = localStorage.getItem('myfoil_library_cache');
        if (cached) {
            try {
                games = JSON.parse(cached);
                initGenders(games);
                initTags(games);
                filteredGames = [...games];
                applyFilters(); // Render cached data immediately
            } catch (e) {
                console.error("Cache parse error", e);
            }
        } else {
            const loadingHtml = `
            <div class="column is-12 has-text-centered p-6">
                <span class="loader is-loading is-inline-block" style="width: 3rem; height: 3rem; border-width: 3px;"></span>
                <p class="mt-4 is-size-6 has-text-weight-bold opacity-60">Carregando Biblioteca...</p>
            </div>
            `;
            $('#libraryContainer').html(loadingHtml);
        }

        // 2. Fetch fresh data
        refreshLibrary();

        // Initialize zoom from localStorage
        const savedZoom = localStorage.getItem('gridZoom') || 240;
        $('#gridZoom').val(savedZoom);
        updateGridZoom(savedZoom);

        // Initialize pageSize from localStorage
        pageSize = parseInt(localStorage.getItem('pageSize')) || 24;
        updatePageSizeButtons();

        // Populated globally outside raw block
        setView(currentView);
    });

    function loadGameTagsAndWishlist(titleId) {
        titleId = titleId.toUpperCase();

        // Load all available tags as options in the modal dropdown
        $.getJSON('/api/tags', (tags) => {
            const select = $('#modalAddTagSelect');
            select.find('option:not(:first)').remove();
            tags.forEach(t => {
                select.append(`<option value="${t.id}">${t.name}</option>`);
            });
        });

        // Load active tags for this specific game
        $.getJSON(`/api/titles/${titleId}/tags`, (tags) => {
            const container = $('#gameModalTags').empty();
            tags.forEach(t => {
                container.append(`
                    <span class="tag" style="background-color: ${t.color}; color: #fff;">
                        ${t.name}
                        <button class="delete is-small" onclick="removeTagFromGame('${titleId}', ${t.id})"></button>
                    </span>
                `);
            });
        });

        // Load personal wishlist status
        $.getJSON('/api/wishlist', (wishlist) => {
            const inWishlist = wishlist.find(i => i.title_id === titleId);
            const btn = $('#btnWishlist');
            if (inWishlist) {
                btn.removeClass('is-light').addClass('is-danger is-light')
                    .find('i').removeClass('bi-heart').addClass('bi-heart-fill');
            } else {
                btn.removeClass('is-danger').addClass('is-light')
                    .find('i').removeClass('bi-heart-fill').addClass('bi-heart');
            }
        });
    }

    function toggleWishlist(titleId) {
        const btn = $('#btnWishlist');
        const isCurrentlyActive = btn.hasClass('is-danger');

        if (isCurrentlyActive) {
            $.ajax({
                url: `/api/wishlist/${titleId}`,
                type: 'DELETE',
                success: () => {
                    btn.removeClass('is-danger').addClass('is-light')
                        .find('i').removeClass('bi-heart-fill').addClass('bi-heart');
                    showToast(t('Removed from Wishlist'));
                }
            });
        } else {
            $.ajax({
                url: '/api/wishlist',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ title_id: titleId }),
                success: () => {
                    btn.removeClass('is-light').addClass('is-danger is-light')
                        .find('i').removeClass('bi-heart').addClass('bi-heart-fill');
                    showToast(t('Added to Wishlist'), 'success');
                }
            });
        }
    }

    function addTagToGame(titleId) {
        const tagId = $('#modalAddTagSelect').val();
        if (!tagId) return;

        $.ajax({
            url: `/api/titles/${titleId}/tags`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ tag_id: tagId }),
            success: () => {
                loadGameTagsAndWishlist(titleId);
            }
        });
    }

    function removeTagFromGame(titleId, tagId) {
        $.ajax({
            url: `/api/titles/${titleId}/tags`,
            type: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify({ tag_id: tagId }),
            success: () => {
                loadGameTagsAndWishlist(titleId);
            }
        });
    }
</script>

{% endblock %}